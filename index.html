<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SURVEY PEA NPN [Ver1.0]</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .navbar {
            flex-shrink: 0;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 8px 12px !important;
            }
            .navbar h1 {
                font-size: 16px !important;
            }
            .nav-button {
                padding: 6px 8px !important;
                font-size: 12px !important;
            }
            .nav-button span:last-child {
                display: none;
            }
            .modal-content {
                margin: 10px;
                max-width: calc(100vw - 20px);
            }
            .dashboard-fullscreen {
                padding: 10px !important;
            }
            .dashboard-panel {
                padding: 12px !important;
            }
            .map-overlay {
                padding: 4px !important;
                font-size: 12px !important;
            }
            .map-overlay-top-right {
                top: 5px;
                right: 5px;
            }
            .map-overlay-bottom-right {
                bottom: 5px;
                right: 5px;
            }
            .map-overlay button {
                padding: 6px !important;
                font-size: 14px !important;
            }
        }
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            cursor: crosshair;
        }
        .map-overlay {
            position: absolute;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .map-overlay-top-right {
            top: 10px;
            right: 10px;
        }
        .map-overlay-bottom-right {
            bottom: 10px;
            right: 10px;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            z-index: 10000;
        }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            pointer-events: none;
            color: #ef4444;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .distance-line {
            stroke: #3b82f6;
            stroke-width: 3;
            stroke-dasharray: 5,5;
            fill: none;
        }
        .marker-number {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #tableContainer {
            max-height: 400px;
            transition: max-height 0.3s ease;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .dashboard-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #10b981; }
        .status-inactive { background-color: #ef4444; }
        .status-pending { background-color: #f59e0b; }
        
        /* Dashboard Full Screen */
        .dashboard-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #f0f9ff, #e0e7ff);
            z-index: 10000;
            overflow-y: auto;
        }
        
        /* Image Preview */
        .image-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-preview img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Hover Image */
        .hover-image {
            position: absolute;
            z-index: 15000;
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        /* Real-time distance line */
        .temp-line {
            stroke: #ef4444;
            stroke-width: 2;
            stroke-dasharray: 3,3;
            fill: none;
            opacity: 0.8;
        }
        
        .distance-label {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 15000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* SweetAlert2 custom z-index */
        .swal2-container {
            z-index: 30000 !important;
        }
        
        /* Range Slider Styling */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #ddd;
            outline: none;
            border-radius: 3px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
  <div class="main-container"><!-- Navigation Bar -->
   <nav class="navbar px-4 py-3">
    <div class="flex items-center justify-between flex-wrap gap-2"><!-- Logo ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö -->
     <div class="flex items-center space-x-3">
      <div class="text-2xl">
       üß≠
      </div>
      <h1 class="text-xl font-bold text-white">SURVEY PEA NPN</h1>
     </div><!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
     <div id="currentProjectInfo" class="hidden flex items-center space-x-2 md:space-x-4 bg-white/20 rounded-lg px-2 md:px-4 py-2 text-xs md:text-sm">
      <div class="text-white">
       <div class="opacity-90">
        ‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à:
       </div>
       <div id="currentSurveyorName" class="font-semibold">
        -
       </div>
      </div>
      <div class="text-white">
       <div class="opacity-90">
        ‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô:
       </div>
       <div id="currentProjectName" class="font-semibold">
        -
       </div>
      </div>
      <div class="text-white">
       <div class="opacity-90">
        ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà:
       </div>
       <div id="currentPointDisplay" class="font-semibold text-yellow-300">
        1
       </div>
      </div>
     </div><!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
     <div class="flex items-center space-x-1 md:space-x-2 flex-wrap"><!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à --> <button id="newProjectBtn" class="nav-button bg-green-550 hover:bg-blue-300 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>üöÄ</span> <span class="hidden md:inline">START</span> </button> <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î --> <button id="dashboardBtn" class="nav-button bg-green-550 hover:bg-blue-300 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>üìä</span> <span class="hidden md:inline">DASHBOARD</span> </button> <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£) --> <button id="saveDataBtn" class="nav-button hidden bg-green-550 hover:bg-blue-300 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>üíæ</span> <span class="hidden md:inline">SAVE</span> </button> <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --> <button id="clearDataBtn" class="nav-button bg-red-550 hover:bg-red-500 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>üóëÔ∏è</span> <span class="hidden md:inline">DELETE DATA</span> </button>
     </div>
    </div>
   </nav><!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
   <div class="map-container">
    <div id="map"></div><!-- Crosshair -->
    <div id="crosshair" class="crosshair">
     üìç
    </div><!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤) -->
    <div class="map-overlay map-overlay-top-right">
     <div class="text-xs space-y-1">
      <div class="flex justify-between"><span>‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span> <span id="lastDistance" class="font-bold text-blue-600">0 ‡∏°.</span>
      </div>
      <div class="flex justify-between"><span>‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏ß‡∏°:</span> <span id="totalDistance" class="font-bold text-green-600">0 ‡∏°.</span>
      </div>
      <div class="flex justify-between"><span>‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> <span id="totalPoints" class="font-bold text-purple-600">0</span>
      </div>
     </div>
    </div><!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤) -->
    <div class="map-overlay map-overlay-bottom-right">
     <div class="flex flex-col space-y-2"><button id="currentLocationBtn" class="bg-blue-400 text-white p-2 rounded hover:bg-blue-700 transition-colors" title="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"> üìç </button> <button id="toggleMapBtn" class="bg-blue-400 text-white p-2 rounded hover:bg-blue-700 transition-colors" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"> üó∫Ô∏è </button> <button id="addPointBtn" class="bg-blue-400 text-white p-2 rounded hover:bg-blue-700 transition-colors" title="‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î"> ‚ûï </button>
     </div>
    </div>
   </div>
  </div><!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà -->
  <div id="newProjectModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4">
   <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
    <div class="p-4 border-b bg-blue-600 text-white rounded-t-lg">
     <h3 class="text-lg font-semibold">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à</h3>
    </div>
    <div class="p-6 space-y-4">
     <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</label> <select id="surveyorSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à...</option> </select>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label> <input type="text" id="projectName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠ WBS...">
     </div>
    </div>
    <div class="p-4 border-t flex space-x-2"><button id="startSurveyBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à </button> <button id="cancelNewProjectBtn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
    </div>
   </div>
  </div><!-- Dashboard Full Screen -->
  <div id="dashboardFullscreen" class="dashboard-fullscreen hidden">
   <div class="p-6"><!-- Header -->
    <div class="flex justify-between items-center mb-6">
     <h1 class="text-3xl font-bold text-gray-800">üìÅ DASHBOARD</h1><button id="closeDashboardBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2"> <span>‚ùå</span> <span>‡∏õ‡∏¥‡∏î</span> </button>
    </div><!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
     <div class="dashboard-panel p-6">
      <h3 class="text-xl font-semibold text-gray-700 mb-3">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
      <p id="totalProjects" class="text-4xl font-bold text-blue-600">0</p>
     </div>
     <div class="dashboard-panel p-6">
      <h3 class="text-xl font-semibold text-gray-700 mb-3">‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
      <p id="totalPointsAll" class="text-4xl font-bold text-green-600">0</p>
     </div>
     <div class="dashboard-panel p-6">
      <h3 class="text-xl font-semibold text-gray-700 mb-3">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°</h3>
      <p id="totalDistanceAll" class="text-4xl font-bold text-purple-600">0 ‡∏°.</p>
     </div>
    </div><!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à -->
    <div class="mb-8">
     <h2 class="text-2xl font-bold text-gray-800 mb-4">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</h2>
     <div id="surveyorStats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"><!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
     </div>
    </div><!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <div class="dashboard-panel p-6 mb-8">
     <div class="flex flex-wrap gap-4 items-end">
      <div class="flex-1 min-w-48"><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</label> <select id="filterSurveyor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option> </select>
      </div>
      <div class="flex-1 min-w-48"><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ</label>
       <div class="space-y-2"><input type="range" id="filterYear" min="2566" max="2570" value="2568" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
        <div class="flex justify-between text-xs text-gray-500"><span>2566</span> <span id="yearDisplay" class="font-semibold text-blue-600">2568</span> <span>2570</span>
        </div>
        <div class="text-center"><button id="clearYearFilter" class="text-xs text-gray-500 hover:text-gray-700 underline"> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ </button>
        </div>
       </div>
      </div>
      <div class="flex-1 min-w-48"><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label> <input type="text" id="searchInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...">
      </div>
      <div class="flex space-x-3"><button id="clearFilters" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium"> üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á </button>
      </div>
     </div>
    </div><!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="dashboard-panel overflow-hidden">
     <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
      <h3 class="text-xl font-semibold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h3><button id="toggleTableBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium"> üìã ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á </button>
     </div>
     <div id="tableContainer" class="overflow-x-auto">
      <table class="w-full">
       <thead class="bg-gray-100 sticky top-0">
        <tr>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('index')">‡∏•‡∏≥‡∏î‡∏±‡∏ö <span class="text-xs">‚ÜïÔ∏è</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('surveyor')">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à <span class="text-xs">‚ÜïÔ∏è</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('project')">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ <span class="text-xs">‚ÜïÔ∏è</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('distance')">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡∏ï‡∏£) <span class="text-xs">‚ÜïÔ∏è</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏†‡∏≤‡∏û‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('status')">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <span class="text-xs">‚ÜïÔ∏è</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('date')">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="text-xs">‚ÜïÔ∏è</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î KML</th>
        </tr>
       </thead>
       <tbody id="projectTableBody" class="divide-y divide-gray-200">
       </tbody>
      </table>
     </div>
    </div>
   </div>
  </div><!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î -->
  <div id="pointModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4">
   <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
    <div class="p-4 border-b bg-red-600 text-white rounded-t-lg">
     <h3 class="text-lg font-semibold">üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà <span id="pointNumber">1</span></h3>
    </div>
    <div class="p-4 space-y-4 max-h-96 overflow-y-auto"><!-- ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å) -->
     <div id="connectionPointSection"><label class="block text-sm font-medium text-gray-700 mb-2">üì∑ ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</label> <input type="file" id="connectionImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded">
     </div><!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å) -->
     <div id="documentSection"><label class="block text-sm font-medium text-gray-700 mb-2">üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</label> <input type="file" id="documentFile" accept="image/*,.pdf,.doc,.docx" class="w-full p-2 border border-gray-300 rounded">
     </div><!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">‚ö° ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤ <span class="text-red-500">*</span></label> <select id="poleType" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤...</option> </select>
     </div><!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">üîß ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label> <select id="equipment" class="w-full p-2 border border-gray-300 rounded"> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</option> </select>
     </div><!-- ‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤ -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">üîù ‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤</label> <select id="poleHead" class="w-full p-2 border border-gray-300 rounded"> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤...</option> </select>
     </div><!-- ‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á&‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">üîó ‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á&amp;‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô</label> <select id="wireSupport" class="w-full p-2 border border-gray-300 rounded"> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á...</option> </select>
     </div><!-- ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">üì∏ ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</label> <input type="file" id="pointImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded">
     </div><!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label> <textarea id="notes" class="w-full p-2 border border-gray-300 rounded" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
     </div>
    </div>
    <div class="p-4 border-t flex space-x-2"><button id="addPointModalBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î </button> <button id="finishPointBtn" class="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700"> ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô </button> <button id="cancelPointBtn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700"> ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
    </div>
   </div>
  </div>
  <script>
	// === SAFE OVERLAY (NO-OP) ===
window.showLoadingOverlay = window.showLoadingOverlay || function(){};
window.hideLoadingOverlay  = window.hideLoadingOverlay  || function(){};

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3sc2q1SQAkeDN1MxHOClJLqPyuSwu7gEkZ_WkuI-FkrUb4tScLt43_TD4jIc1fqZUfw/exec';
        const SHEET_ID = '1gQR42JzTackvfuedJUW5Zm-s9N_sun0mFb8zdOPyeVg';
        const FOLDER_ID = '1AL8KrbctkMQRA_AgmVfMLZU4a76soBX_';
        
	// === NEW: device helper ===
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
  navigator.userAgent
);
	let map;
        let currentSurveyor = '';
        let currentProject = '';
        let surveyPoints = [];
        let currentPointNumber = 1;
        let totalDistance = 0;
        let lastDistance = 0;
        let isMapSatellite = false;
        let polyline;
        let markers = [];
        let dropdownOptions = {};
        let allProjectData = [];
        let filteredProjectData = [];
        let isTableExpanded = false;
        let tempLine = null;
        let isProcessing = false;
        let currentLocationMarker = null;
        let distanceLabel = null;
        let watchId = null;
	// ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Äú‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‚Äù
	let shouldCenterOnGPS = true;


        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                await loadDropdownOptions();
                setupEventListeners();
                initializeMap();
            } catch (error) {
                console.error('Error initializing app:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å dropdown ‡∏à‡∏≤‡∏Å Google Sheet
        async function loadDropdownOptions() {
            try {
                console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å dropdown ‡∏à‡∏≤‡∏Å Google Sheets:', SCRIPT_URL);
                
                // ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
                let response;
                let data;
                
                // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: GET request ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
                try {
                    response = await fetch(`${SCRIPT_URL}?action=getOptions&timestamp=${Date.now()}`, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        console.log('üìÑ Response (Method 1):', responseText.substring(0, 200) + '...');
                        data = JSON.parse(responseText);
                        
                        if (data && data.success && data.options) {
                            console.log('‚úÖ Method 1 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                            dropdownOptions = data.options;
                            populateDropdowns();
                            return;
                        }
                    }
                } catch (error) {
                    console.log('‚ùå Method 1 ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error.message);
                }
                
                // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: POST request
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'getOptions');
                    
                    response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params.toString()
                    });
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        console.log('üìÑ Response (Method 2):', responseText.substring(0, 200) + '...');
                        data = JSON.parse(responseText);
                        
                        if (data && data.success && data.options) {
                            console.log('‚úÖ Method 2 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                            dropdownOptions = data.options;
                            populateDropdowns();
                            return;
                        }
                    }
                } catch (error) {
                    console.log('‚ùå Method 2 ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error.message);
                }
                
                // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á
                console.log('üîÑ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß...');
                dropdownOptions = {
                    surveyor: ['‡∏ô‡∏≤‡∏¢ ‡∏Å', '‡∏ô‡∏≤‡∏¢ ‡∏Ç', '‡∏ô‡∏≤‡∏¢ ‡∏Ñ', '‡∏ô‡∏≤‡∏á ‡∏á', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏à'],
                    poleType: ['‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 12 ‡∏°.', '‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï 15 ‡∏°.', '‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å 12 ‡∏°.', '‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å 15 ‡∏°.', '‡πÄ‡∏™‡∏≤‡πÑ‡∏°‡πâ 9 ‡∏°.'],
                    equipment: ['‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á 25 kVA', '‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á 50 kVA', '‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á 100 kVA', '‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå', '‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏á‡∏Ñ‡πå'],
                    poleHead: ['‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡πÅ‡∏ö‡∏ö A', '‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡πÅ‡∏ö‡∏ö B', '‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡πÅ‡∏ö‡∏ö C', '‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©'],
                    wireSupport: ['‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°', '‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï']
                };
                
                populateDropdowns();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                Swal.fire({
                    title: '‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á',
                    html: `
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ</p>
                        <p class="text-sm text-gray-600 mt-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</p>
                        <div class="mt-3 p-3 bg-yellow-50 rounded">
                            <p class="text-sm text-yellow-700">
                                <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
                            </p>
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded">
                            <p class="text-sm text-blue-600">
                                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞ URL ‡∏Ç‡∏≠‡∏á Google Apps Script
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    confirmButtonText: '‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á:', error);
                
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
                dropdownOptions = {
                    surveyor: ['‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à 1', '‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à 2', '‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à 3'],
                    poleType: ['‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï', '‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡πÄ‡∏™‡∏≤‡πÑ‡∏°‡πâ'],
                    equipment: ['‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á', '‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå', '‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'],
                    poleHead: ['‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©'],
                    wireSupport: ['‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á', '‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô']
                };
                
                populateDropdowns();
                
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
                    text: '‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ',
                    icon: 'error',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }



        function populateDropdowns() {
            console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô dropdown...', dropdownOptions);
            
            // ‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à
            const surveyorSelect = document.getElementById('surveyorSelect');
            if (surveyorSelect) {
                surveyorSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à...</option>';
                surveyorSelect.disabled = false;
                
                if (dropdownOptions.surveyor && Array.isArray(dropdownOptions.surveyor) && dropdownOptions.surveyor.length > 0) {
                    console.log('‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à:', dropdownOptions.surveyor.length, '‡∏Ñ‡∏ô');
                    dropdownOptions.surveyor.forEach((option, index) => {
                        if (option && option.trim()) {
                            surveyorSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                } else {
                    console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
                    const defaultSurveyors = ['‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à 1', '‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à 2', '‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à 3'];
                    defaultSurveyors.forEach(option => {
                        surveyorSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤
            const poleTypeSelect = document.getElementById('poleType');
            if (poleTypeSelect) {
                poleTypeSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤...</option>';
                poleTypeSelect.disabled = false;
                
                if (dropdownOptions.poleType && Array.isArray(dropdownOptions.poleType) && dropdownOptions.poleType.length > 0) {
                    dropdownOptions.poleType.forEach(option => {
                        if (option && option.trim()) {
                            poleTypeSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤:', dropdownOptions.poleType.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                } else {
                    console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤ - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
                    const defaultPoleTypes = ['‡πÄ‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï', '‡πÄ‡∏™‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡πÄ‡∏™‡∏≤‡πÑ‡∏°‡πâ'];
                    defaultPoleTypes.forEach(option => {
                        poleTypeSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            const equipmentSelect = document.getElementById('equipment');
            if (equipmentSelect) {
                equipmentSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</option>';
                
                if (dropdownOptions.equipment && Array.isArray(dropdownOptions.equipment) && dropdownOptions.equipment.length > 0) {
                    dropdownOptions.equipment.forEach(option => {
                        if (option && option.trim()) {
                            equipmentSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:', dropdownOptions.equipment.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                } else {
                    const defaultEquipment = ['‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á', '‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå', '‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'];
                    defaultEquipment.forEach(option => {
                        equipmentSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // ‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤
            const poleHeadSelect = document.getElementById('poleHead');
            if (poleHeadSelect) {
                poleHeadSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤...</option>';
                
                if (dropdownOptions.poleHead && Array.isArray(dropdownOptions.poleHead) && dropdownOptions.poleHead.length > 0) {
                    dropdownOptions.poleHead.forEach(option => {
                        if (option && option.trim()) {
                            poleHeadSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤:', dropdownOptions.poleHead.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                } else {
                    const defaultPoleHeads = ['‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©'];
                    defaultPoleHeads.forEach(option => {
                        poleHeadSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // ‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á
            const wireSupportSelect = document.getElementById('wireSupport');
            if (wireSupportSelect) {
                wireSupportSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á...</option>';
                
                if (dropdownOptions.wireSupport && Array.isArray(dropdownOptions.wireSupport) && dropdownOptions.wireSupport.length > 0) {
                    dropdownOptions.wireSupport.forEach(option => {
                        if (option && option.trim()) {
                            wireSupportSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á:', dropdownOptions.wireSupport.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                } else {
                    const defaultWireSupports = ['‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á', '‡πÄ‡∏ó‡πÇ‡∏Ñ‡∏ô'];
                    defaultWireSupports.forEach(option => {
                        wireSupportSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }
            
            console.log('üéâ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• dropdown ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!');
        }

// === Toast helpers (‡∏ß‡∏≤‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ setupEventListeners) ===
function notifySuccess(message) {
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon: 'success',
    title: message,
    showConfirmButton: false,
    timer: 3000
  });
}
function notifyError(message) {
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon: 'error',
    title: message,
    showConfirmButton: false,
    timer: 3000
  });
}
// === Mobile-safe SweetAlert (safe attach) ===
(function attachMobileSafeSwal(){
  function patch() {
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Swal ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏û‡∏ï‡∏ä‡πå
    if (!window.Swal || !Swal.fire || Swal.__mobilePatched) return;

    const _fire = Swal.fire.bind(Swal);

    Swal.fire = function (opts, ...rest) {
      // ‡∏ñ‡πâ‡∏≤ dev ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ string ‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô object
      if (typeof opts === 'string') opts = { title: String(opts) };

      // Toast ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô (‡∏Ñ‡∏á timer ‡πÑ‡∏î‡πâ)
      if (opts && opts.toast) {
        return _fire(opts, ...rest);
      }

      // Modal: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‚Äú‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‚Äù ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
      const safe = Object.assign(
        {
          allowOutsideClick: false,
          allowEscapeKey: false,
          heightAuto: false,
          showConfirmButton: true,
          confirmButtonText: (opts && opts.confirmButtonText) || '‡∏ï‡∏Å‡∏•‡∏á'
        },
        opts || {}
      );

      // ‡∏•‡∏ö timer ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å modal ‡πÄ‡∏™‡∏°‡∏≠ (‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏≤‡∏¢)
      if ('timer' in safe) delete safe.timer;

      return _fire(safe, ...rest);
    };

    Swal.__mobilePatched = true;
  }

  // ‡πÅ‡∏û‡∏ï‡∏ä‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤ Swal ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß
  if (window.Swal && Swal.fire) {
    patch();
  } else {
    // ‡∏ñ‡πâ‡∏≤ script SweetAlert ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏≠
    const iv = setInterval(() => {
      if (window.Swal && Swal.fire) {
        clearInterval(iv);
        patch();
      }
    }, 50);
    // ‡∏Å‡∏±‡∏ô‡∏•‡∏π‡∏õ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
    setTimeout(() => clearInterval(iv), 5000);
  }
})();


        function setupEventListeners() {
            // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            document.getElementById('newProjectBtn').addEventListener('click', showNewProjectModal);
            document.getElementById('dashboardBtn').addEventListener('click', showDashboardModal);
            document.getElementById('saveDataBtn').addEventListener('click', saveAllData);
            document.getElementById('clearDataBtn').addEventListener('click', confirmClearDataFromNav);
            
            // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            document.getElementById('currentLocationBtn').addEventListener('click', () => {
  // ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‚Äú‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  shouldCenterOnGPS = true;

  if (currentLocationMarker) {
    // ‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î auto-center
    map.setView(currentLocationMarker.getLatLng(), 16);
    shouldCenterOnGPS = false;
  } else {
    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‚Üí ‡∏Ç‡∏≠ GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ü‡∏•‡πá‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ô getCurrentLocation
    getCurrentLocation(true);
  }
});


            document.getElementById('toggleMapBtn').addEventListener('click', toggleMapView);
            document.getElementById('addPointBtn').addEventListener('click', confirmAddPoint);
            
            // Modal ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            document.getElementById('startSurveyBtn').addEventListener('click', startSurvey);
            document.getElementById('cancelNewProjectBtn').addEventListener('click', hideNewProjectModal);
            
            // Modal ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
            document.getElementById('closeDashboardBtn').addEventListener('click', hideDashboardModal);
            
            // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Modal ‡∏à‡∏∏‡∏î
            document.getElementById('addPointModalBtn').addEventListener('click', addPointFromModal);
            document.getElementById('finishPointBtn').addEventListener('click', finishPoint);
            document.getElementById('cancelPointBtn').addEventListener('click', cancelPoint);
            
            // ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
            document.getElementById('filterSurveyor').addEventListener('change', filterTable);
            document.getElementById('filterYear').addEventListener('input', updateYearDisplay);
            document.getElementById('filterYear').addEventListener('change', filterTable);
            document.getElementById('searchInput').addEventListener('input', filterTable);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('toggleTableBtn').addEventListener('click', toggleTable);
            
            // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ (‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'clearYearFilter') {
                    document.getElementById('filterYear').value = '2568';
                    updateYearDisplay();
                    filterTable();
                }
            });
// === NEW: event delegation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î KML ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ===
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.download-kml');
  if (!btn) return;  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° KML ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°

  const project = (btn.dataset.project || '').trim();
  if (!project) {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ helper toast ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÉ‡∏ä‡πâ Swal ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    if (typeof notifyError === 'function') {
      notifyError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î KML');
    } else {
      Swal.fire({
        title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô',
        text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î KML',
        icon: 'error',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        allowOutsideClick: false
      });
    }
    return;
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
  downloadKML(project);
});

        }

//222222222222
// === NEW: live measure toggles ===
function enableLiveMeasure() {
  if (!map) return;

  const onMobileMove = () => {
    if (surveyPoints.length > 0 && !isProjectFinished) {
      updateTempLine(map.getCenter());
    }
  };

  map.__onMobileMove = onMobileMove;

  if (isMobile) {
    map.on('move', map.__onMobileMove);
    map.on('touchmove', map.__onMobileMove);
  }
}

function disableLiveMeasure() {
  if (!map) return;
  if (map.__onMobileMove) {
    map.off('move', map.__onMobileMove);
    map.off('touchmove', map.__onMobileMove);
    map.__onMobileMove = null;
  }
  clearDistanceLines?.();
  document.getElementById('lastDistance').textContent = '0 ‡∏°.';
}

	//222222222222

        function initializeMap() {
            setTimeout(() => {
                try {
                    console.log('Initializing map...');
                    
                    if (typeof L === 'undefined') {
                        console.error('Leaflet not loaded');
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
                        return;
                    }
                    
                    map = L.map('map', {
                        center: [13.7563, 100.5018],
                        zoom: 13,
                        zoomControl: true
                    });
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(map);
                    map.on('dragstart', () => { shouldCenterOnGPS = false; });
			map.on('zoomstart', () => { shouldCenterOnGPS = false; });


                    polyline = L.polyline([], {
                        color: '#3b82f6',
                        weight: 3,
                        dashArray: '5, 5'
                    }).addTo(map);
                    
                    // ‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
                    tempLine = L.polyline([], {
                        color: '#ef4444',
                        weight: 2,
                        dashArray: '3, 3',
                        opacity: 0.8
                    }).addTo(map);
                    
                    map.on('click', function(e) {
                        if (currentSurveyor && currentProject && !isProcessing) {
                            confirmAddPointAtLocation(e.latlng);
                        }
                    });
                    
                    // ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    map.on('mousemove', function(e) {
                        if (currentSurveyor && currentProject && surveyPoints.length > 0) {
                            updateTempLine(e.latlng);
                        }
                    });
                    
                    map.whenReady(() => {
                        console.log('Map ready');
                        getCurrentLocation();
			enableLiveMeasure(); // <<< NEW: ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
                    });
                    
                    console.log('Map initialized successfully');
                } catch (error) {
                    console.error('Error initializing map:', error);
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: ' + error.message, 'error');
                }
            }, 300);
        }
        
        function updateTempLine(latlng) {
  if (!latlng || surveyPoints.length === 0) return;

  const lastPoint = surveyPoints[surveyPoints.length - 1];
  const tempDistance = calculateDistance(lastPoint.lat, lastPoint.lng, latlng.lat, latlng.lng);

  tempLine.setLatLngs([
    [lastPoint.lat, lastPoint.lng],
    [latlng.lat, latlng.lng]
  ]);

  if (distanceLabel) {
    map.removeLayer(distanceLabel);
  }

  const midLat = (lastPoint.lat + latlng.lat) / 2;
  const midLng = (lastPoint.lng + latlng.lng) / 2;

  distanceLabel = L.marker([midLat, midLng], {
    icon: L.divIcon({
      className: 'distance-label',
      html: `<div class="distance-label">${Math.round(tempDistance)} ‡∏°.</div>`,
      iconSize: [60, 20],
      iconAnchor: [30, 10]
    })
  }).addTo(map);

  document.getElementById('lastDistance').textContent = `${Math.round(tempDistance)} ‡∏°.`; // ‡πÄ‡∏î‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
}


        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('hidden');
            document.getElementById('newProjectModal').classList.add('flex');
        }

        function hideNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('hidden');
            document.getElementById('newProjectModal').classList.remove('flex');
        }

        async function showDashboardModal() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (isProjectFinished && surveyPoints.length > 0) {
                const saveResult = await Swal.fire({
                    title: '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    cancelButtonText: '‡πÑ‡∏°‡πà',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
                if (saveResult.isConfirmed) {
                    try {
                        await saveAllData();
                        // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                        document.getElementById('dashboardFullscreen').classList.remove('hidden');
                        await loadDashboardData();
                    } catch (error) {
                        Swal.fire({
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                            icon: 'error',
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                            allowOutsideClick: false
                        });
                        return;
                    }
                } else {
                    // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÑ‡∏õ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏•‡∏¢
                    document.getElementById('dashboardFullscreen').classList.remove('hidden');
                    await loadDashboardData();
                }
            } else {
                // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÑ‡∏õ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏•‡∏¢
                document.getElementById('dashboardFullscreen').classList.remove('hidden');
                await loadDashboardData();
            }
        }

        function hideDashboardModal() {
            document.getElementById('dashboardFullscreen').classList.add('hidden');
        }

        function startSurvey() {
            const surveyor = document.getElementById('surveyorSelect').value;
            const project = document.getElementById('projectName').value;
            
            if (!surveyor || !project) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô(‡∏´‡∏£‡∏∑‡∏≠WBS)',
                    icon: 'warning',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false
                });
                return;
            }
            
            currentSurveyor = surveyor;
            currentProject = project;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            document.getElementById('currentSurveyorName').textContent = surveyor;
            document.getElementById('currentProjectName').textContent = project;
            document.getElementById('currentProjectInfo').classList.remove('hidden');
            document.getElementById('saveDataBtn').classList.remove('hidden');
            
            hideNewProjectModal();
            
            Swal.fire({
                title: 'START üöóüìç!',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        }

function getCurrentLocation(forceCenter = false) {
  if (!navigator.geolocation) {
    Swal.fire('‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 'error');
    return;
  }

  // ‡πÉ‡∏ä‡πâ overlay ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏≠‡∏∑‡πà‡∏ô)
  showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...');

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå watch ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  if (window.watchId) navigator.geolocation.clearWatch(watchId);

  window.watchId = navigator.geolocation.watchPosition(
    (position) => {
      try {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        updateCurrentLocationMarker(lat, lng);

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå ‚Äú‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (forceCenter) {
          map.setView([lat, lng], 16);
          shouldCenterOnGPS = false;
        } else if (shouldCenterOnGPS) {
          map.setView([lat, lng], 16);
          shouldCenterOnGPS = false;
        }
      } finally {
        hideLoadingOverlay();
      }
    },
    (error) => {
      hideLoadingOverlay();
      Swal.fire({
        title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        icon: 'error',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        allowOutsideClick: false,
        allowEscapeKey: false
      });
    },
    { enableHighAccuracy: true, timeout: 100000, maximumAge: 5000 }
  );
}

        
        function updateCurrentLocationMarker(lat, lng) {
            // ‡∏•‡∏ö marker ‡πÄ‡∏Å‡πà‡∏≤
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡πÉ‡∏´‡∏°‡πà
            const locationIcon = L.divIcon({
                className: 'current-location-marker',
                html: '<div style="background: #3b82f6; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">üìç</div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            currentLocationMarker = L.marker([lat, lng], { icon: locationIcon }).addTo(map);
            currentLocationMarker.bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
        }

        function toggleMapView() {
            const mapContainer = map.getContainer();
            map.eachLayer((layer) => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            
            if (isMapSatellite) {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                isMapSatellite = false;
            } else {
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri'
                }).addTo(map);
                isMapSatellite = true;
            }
        }

        async function confirmAddPoint() {
            if (!currentSurveyor || !currentProject) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° START',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° START ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                    icon: 'warning',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false
                });
                return;
            }
            
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentPointNumber} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            
            if (result.isConfirmed) {
                showPointModal();
            }
        }

        async function confirmAddPointAtLocation(latlng) {
            if (!currentSurveyor || !currentProject) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° START',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                    icon: 'warning',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false
                });
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (isProjectFinished) {
                const continueResult = await Swal.fire({
                    title: '‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                    text: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ï‡πà‡∏≠',
                    cancelButtonText: '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
                if (!continueResult.isConfirmed) {
                    return; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ï‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                isProjectFinished = false;
                // <<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
currentPointNumber = surveyPoints.length + 1;
document.getElementById('currentPointDisplay').textContent = currentPointNumber;
                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                if (surveyPoints.length > 0) {
                    const points = surveyPoints.map(point => [point.lat, point.lng]);
                    polyline.setLatLngs(points);
                }
            }
            
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentPointNumber} ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            
            if (result.isConfirmed) {
                map.setView([latlng.lat, latlng.lng], map.getZoom());
                showPointModal();
            }
        }

        function showPointModal() {
            document.getElementById('pointNumber').textContent = currentPointNumber;
            
            const connectionSection = document.getElementById('connectionPointSection');
            const documentSection = document.getElementById('documentSection');
            
            if (currentPointNumber === 1) {
                connectionSection.style.display = 'block';
                documentSection.style.display = 'block';
            } else {
                connectionSection.style.display = 'none';
                documentSection.style.display = 'none';
            }
            
            resetModalForm();
            
            document.getElementById('pointModal').classList.remove('hidden');
            document.getElementById('pointModal').classList.add('flex');
        }

        function resetModalForm() {
            document.getElementById('connectionImage').value = '';
            document.getElementById('documentFile').value = '';
            document.getElementById('poleType').value = '';
            document.getElementById('equipment').value = '';
            document.getElementById('poleHead').value = '';
            document.getElementById('wireSupport').value = '';
            document.getElementById('pointImage').value = '';
            document.getElementById('notes').value = '';
        }

        function hidePointModal() {
            document.getElementById('pointModal').classList.add('hidden');
            document.getElementById('pointModal').classList.remove('flex');
        }

        async function addPointFromModal() {
            if (isProcessing) return;
            
            const poleType = document.getElementById('poleType').value;
            if (!poleType) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤',
                    icon: 'warning',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                return;
            }
            
            isProcessing = true;
            
            // ‡πÅ‡∏™‡∏î‡∏á loading overlay
            showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                await saveCurrentPoint();
                currentPointNumber++;
                document.getElementById('currentPointDisplay').textContent = currentPointNumber;
                hidePointModal();
                hideLoadingOverlay();
                // <<< NEW: ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î modal) 5555555
		enableLiveMeasure();

                Swal.fire({
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà',
                    icon: 'success',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                                    });
            } catch (error) {
                hideLoadingOverlay();
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                    icon: 'error',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            } finally {
                isProcessing = false;
            }
        }
        
        function showLoadingOverlay(message) {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-8 text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-lg font-medium text-gray-700">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        let isProjectFinished = false;
        
        async function finishPoint() {
            const poleType = document.getElementById('poleType').value;
            if (!poleType) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤',
                    icon: 'warning',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                return;
            }
            
            if (isProcessing) return;
            isProcessing = true;
            
            showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                await saveCurrentPoint();
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                isProjectFinished = true;
                
                // ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞ event listeners ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                clearAllDistanceElements();
                disableLiveMeasure(); // <<< NEW 44
                // ‡∏õ‡∏¥‡∏î Modal
                hidePointModal();
                hideLoadingOverlay();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                Swal.fire({
                    title: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                    icon: 'success',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
            } catch (error) {
                console.error('Error finishing point:', error);
                hideLoadingOverlay();
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message,
                    icon: 'error',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            } finally {
                isProcessing = false;
            }
        }
        
        function clearDistanceLines() {
            // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
            if (polyline && map) {
                try {
                    polyline.setLatLngs([]);
                } catch (error) {
                    console.error('Error clearing polyline:', error);
                }
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            if (tempLine && map) {
                try {
                    tempLine.setLatLngs([]);
                } catch (error) {
                    console.error('Error clearing temp line:', error);
                }
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á distance label
            if (distanceLabel && map) {
                try {
                    if (map.hasLayer(distanceLabel)) {
                        map.removeLayer(distanceLabel);
                    }
                    distanceLabel = null;
                } catch (error) {
                    console.error('Error removing distance label:', error);
                }
            }
        }
        
        function clearAllDistanceElements() {
            console.log('üßπ ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞ event listeners ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
            clearDistanceLines();
            
            // ‡∏•‡∏ö event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mousemove
            if (map) {
                map.off('mousemove');
                console.log('‚úÖ ‡∏•‡∏ö mousemove event listener ‡πÅ‡∏•‡πâ‡∏ß');
            }
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            distanceLabel = null;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
            document.getElementById('lastDistance').textContent = '0 ‡∏°.';
            
            console.log('üéâ ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        }
        
        function showProjectCompletionOptions() {
            Swal.fire({
                title: '‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß?',
                icon: 'success',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                denyButtonText: 'üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: 'üìä ‡∏î‡∏π‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î',
                confirmButtonColor: '#10b981',
                denyButtonColor: '#ef4444',
                cancelButtonColor: '#6366f1'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveAllData();
                } else if (result.isDenied) {
                    confirmClearData();
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    showDashboardModal();
                }
            });
        }
        
        function confirmClearDataFromNav() {
            if (surveyPoints.length === 0) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á', 'info');
                return;
            }
            
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${surveyPoints.length} ‡∏à‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏µ‡πâ?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ef4444',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((result) => {
                if (result.isConfirmed) {
                    resetSurveyData();
                    Swal.fire({
                        title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
  			allowOutsideClick: false,
  			allowEscapeKey: false
                    });
                }
            });
        }
        
        function confirmClearData() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏µ‡πâ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#ef4444',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((result) => {
                if (result.isConfirmed) {
                    resetSurveyData();
                    Swal.fire({
                        title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });
                }
            });
        }

        function cancelPoint() {
            hidePointModal();
        }

        async function saveCurrentPoint() {
            const center = map.getCenter();
            const lat = center.lat;
            const lng = center.lng;
            
            const connectionImageUrl = await uploadFile(document.getElementById('connectionImage').files[0]);
            const documentUrl = await uploadFile(document.getElementById('documentFile').files[0]);
            const pointImageUrl = await uploadFile(document.getElementById('pointImage').files[0]);
            
            const pointData = {
                pointNumber: currentPointNumber,
                lat: lat,
                lng: lng,
                poleType: document.getElementById('poleType').value,
                equipment: document.getElementById('equipment').value,
                poleHead: document.getElementById('poleHead').value,
                wireSupport: document.getElementById('wireSupport').value,
                notes: document.getElementById('notes').value,
                connectionImageUrl: connectionImageUrl,
                documentUrl: documentUrl,
                pointImageUrl: pointImageUrl,
                timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
            };
            
            surveyPoints.push(pointData);
            
            addMarkerToMap(lat, lng, currentPointNumber);
            calculateDistances();
            updateDistanceDisplay();
        }

        function addMarkerToMap(lat, lng, number) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á custom icon ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            const customIcon = L.divIcon({
                className: 'marker-number',
                html: `<div class="marker-number">${number}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            marker.bindPopup(`‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${number}<br>‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            markers.push(marker);
            
            const points = surveyPoints.map(point => [point.lat, point.lng]);
            polyline.setLatLngs(points);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
            if (surveyPoints.length >= 2) {
                const currentPoint = surveyPoints[surveyPoints.length - 1];
                const previousPoint = surveyPoints[surveyPoints.length - 2];
                const distance = calculateDistance(
                    previousPoint.lat, previousPoint.lng,
                    currentPoint.lat, currentPoint.lng
                );
                
                const midLat = (previousPoint.lat + currentPoint.lat) / 2;
                const midLng = (previousPoint.lng + currentPoint.lng) / 2;
                
                const distanceMarker = L.marker([midLat, midLng], {
                    icon: L.divIcon({
                        className: 'distance-marker',
                        html: `<div style="background: rgba(59, 130, 246, 0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; border: 1px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${Math.round(distance)} ‡∏°.</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(map);
                
                markers.push(distanceMarker);
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            tempLine.setLatLngs([]);
        }

        function calculateDistances() {
            if (surveyPoints.length < 2) {
                lastDistance = 0;
                totalDistance = 0;
                return;
            }
            
            const lastPoint = surveyPoints[surveyPoints.length - 1];
            const secondLastPoint = surveyPoints[surveyPoints.length - 2];
            
            lastDistance = calculateDistance(
                secondLastPoint.lat, secondLastPoint.lng,
                lastPoint.lat, lastPoint.lng
            );
            
            totalDistance = 0;
            for (let i = 1; i < surveyPoints.length; i++) {
                totalDistance += calculateDistance(
                    surveyPoints[i-1].lat, surveyPoints[i-1].lng,
                    surveyPoints[i].lat, surveyPoints[i].lng
                );
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateDistanceDisplay() {
            document.getElementById('lastDistance').textContent = `${Math.round(lastDistance)} ‡∏°.`;
            document.getElementById('totalDistance').textContent = `${Math.round(totalDistance)} ‡∏°.`;
            document.getElementById('totalPoints').textContent = surveyPoints.length;
        }

        async function uploadFile(file) {
            if (!file) return '';
            
            try {
                console.log('Uploading file:', file.name, 'Size:', file.size);
                
                const base64 = await fileToBase64(file);
                console.log('File converted to base64, length:', base64.length);
                
                const params = new URLSearchParams();
                params.append('action', 'uploadFile');
                params.append('fileName', file.name);
                params.append('fileData', base64);
                params.append('folderId', FOLDER_ID);
                params.append('surveyor', currentSurveyor);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                console.log('Upload result:', result);
                
                if (result.success) {
                    console.log('File uploaded successfully:', result.url);
                    return result.url;
                } else {
                    console.error('Upload failed:', result.error);
                    return '';
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                return '';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function clearMapElements() {
            console.log('Clearing map elements...');
            
            // ‡∏•‡πâ‡∏≤‡∏á markers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            markers.forEach(marker => {
                try {
                    if (map && map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                } catch (error) {
                    console.error('Error removing marker:', error);
                }
            });
            markers = [];
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
            if (polyline && map) {
                try {
                    polyline.setLatLngs([]);
                    if (map.hasLayer(polyline)) {
                        map.removeLayer(polyline);
                    }
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÉ‡∏´‡∏°‡πà
                    polyline = L.polyline([], {
                        color: '#3b82f6',
                        weight: 3,
                        dashArray: '5, 5'
                    }).addTo(map);
                } catch (error) {
                    console.error('Error clearing polyline:', error);
                }
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            if (tempLine && map) {
                try {
                    tempLine.setLatLngs([]);
                    if (map.hasLayer(tempLine)) {
                        map.removeLayer(tempLine);
                    }
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà
                    tempLine = L.polyline([], {
                        color: '#ef4444',
                        weight: 2,
                        dashArray: '3, 3',
                        opacity: 0.8
                    }).addTo(map);
                } catch (error) {
                    console.error('Error clearing temp line:', error);
                }
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á distance label
            if (distanceLabel && map) {
                try {
                    if (map.hasLayer(distanceLabel)) {
                        map.removeLayer(distanceLabel);
                    }
                    distanceLabel = null;
                } catch (error) {
                    console.error('Error removing distance label:', error);
                }
            }
            
            console.log('Map elements cleared successfully');
        }

        async function saveAllDataToSheets() {
            if (surveyPoints.length === 0) {
                throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
            }
            
            try {
                console.log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets...');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô
                let isConnected = false;
                try {
                    const testResponse = await fetch(`${SCRIPT_URL}?action=test&timestamp=${Date.now()}`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    isConnected = testResponse.ok;
                } catch (error) {
                    console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ');
                    isConnected = false;
                }
                
                if (!isConnected) {
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Local Storage)
                    console.log('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ó‡∏ô...');
                    const projectData = {
                        surveyor: currentSurveyor,
                        project: currentProject,
                        points: surveyPoints,
                        totalDistance: totalDistance,
                        timestamp: new Date().toISOString(),
                        saved: false // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
                    };
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô localStorage
                    const existingData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    existingData.push(projectData);
                    localStorage.setItem('surveyData', JSON.stringify(existingData));
                    
                    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    Swal.fire({
                        title: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß',
                        html: `
                            <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏î‡πâ</p>
                            <p class="text-sm text-gray-600 mt-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</p>
                            <div class="mt-3 p-3 bg-yellow-50 rounded">
                                <p class="text-sm text-yellow-700">
                                    <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
                                </p>
                            </div>
                        `,
                        icon: 'warning',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                    
                    return true;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥
                const mapImageUrl = await captureMapScreenshot();
                console.log('üì∏ ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:', mapImageUrl ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                
                let savedCount = 0;
                for (let i = 0; i < surveyPoints.length; i++) {
                    const point = surveyPoints[i];
                    console.log(`üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${i + 1}/${surveyPoints.length}...`);
                    
                    try {
                        const params = new URLSearchParams();
                        params.append('action', 'saveData');
                        params.append('surveyor', currentSurveyor);
                        params.append('project', currentProject);
                        params.append('pointNumber', point.pointNumber);
                        params.append('lat', point.lat);
                        params.append('lng', point.lng);
                        params.append('poleType', point.poleType);
                        params.append('equipment', point.equipment || '');
                        params.append('poleHead', point.poleHead || '');
                        params.append('wireSupport', point.wireSupport || '');
                        params.append('notes', point.notes || '');
                        params.append('timestamp', point.timestamp);
                        params.append('status', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á');
                        params.append('mapImageUrl', mapImageUrl || '');
                        params.append('connectionImageUrl', point.connectionImageUrl || '');
                        params.append('documentUrl', point.documentUrl || '');
                        params.append('pointImageUrl', point.pointImageUrl || '');
                        
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå O
                        if (point.documentUrl) {
                            params.append('documentLinkUrl', point.documentUrl);
                        }
                        
                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: params.toString()
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            savedCount++;
                            console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${i + 1} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                        } else {
                            console.error(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${i + 1} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, result.error);
                        }
                        
                    } catch (pointError) {
                        console.error(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${i + 1}:`, pointError);
                    }
                }
                
                if (savedCount === surveyPoints.length) {
                    console.log('üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    return true;
                } else {
                    throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${savedCount}/${surveyPoints.length} ‡∏à‡∏∏‡∏î`);
                }
                
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', error);
                throw error;
            }
        }

        async function saveAllData() {
            if (surveyPoints.length === 0) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
                return;
            }
            
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                await saveAllDataToSheets();
                
                Swal.fire({
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${surveyPoints.length} ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                    icon: 'success',
                    timer: 30000,
                    showConfirmButton: true
                });
                
                resetSurveyData();
                
            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }

        async function captureMapScreenshot() {
            try {
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô capture
                if (surveyPoints.length > 0) {
                    const latlngs = surveyPoints.map(point => [point.lat, point.lng]);
                    const group = L.featureGroup(markers);
                    
                    // ‡∏õ‡∏£‡∏±‡∏ö bounds ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î
                    if (markers.length > 0) {
                        const bounds = group.getBounds();
                        map.fitBounds(bounds, { padding: [20, 20] });
                    } else if (latlngs.length > 0) {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ markers ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ coordinates
                        const bounds = L.latLngBounds(latlngs);
                        map.fitBounds(bounds, { padding: [20, 20] });
                    }
                    
                    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                const mapElement = document.getElementById('map');
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 1,
                    logging: false
                });
                
                const base64 = canvas.toDataURL('image/png').split(',')[1];
                const fileName = `map_${currentProject}_${Date.now()}.png`;
                
                const params = new URLSearchParams({
                    action: 'uploadFile',
                    fileName: fileName,
                    fileData: base64,
                    folderId: FOLDER_ID,
                    surveyor: currentSurveyor
                });
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                return result.success ? result.url : '';
            } catch (error) {
                console.error('Error capturing map screenshot:', error);
                return '';
            }
        }

        function resetSurveyData() {
            surveyPoints = [];
            currentPointNumber = 1;
            totalDistance = 0;
            lastDistance = 0;
            currentSurveyor = '';
            currentProject = '';
            isProjectFinished = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
            document.getElementById('currentProjectInfo').classList.add('hidden');
            document.getElementById('saveDataBtn').classList.add('hidden');
            document.getElementById('currentPointDisplay').textContent = '1';
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            if (map) {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                if (polyline) {
                    polyline.setLatLngs([]);
                }
            }
            
            updateDistanceDisplay();
        }

        async function loadDashboardData() {
            try {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡∏Å‡πà‡∏≠‡∏ô
                let data = null;
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=getDashboardData&timestamp=${Date.now()}`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            data = result.data;
                            console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        }
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ:', error.message);
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage
                if (!data) {
                    console.log('üì± ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage...');
                    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• localStorage ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Google Sheets
                    data = [];
                    localData.forEach(project => {
                        project.points.forEach(point => {
                            data.push([
                                project.surveyor,           // 0: surveyor
                                project.project,            // 1: project
                                point.pointNumber,          // 2: pointNumber
                                point.lat,                  // 3: lat
                                point.lng,                  // 4: lng
                                point.poleType,             // 5: poleType
                                point.equipment || '',      // 6: equipment
                                point.poleHead || '',       // 7: poleHead
                                point.wireSupport || '',    // 8: wireSupport
                                point.notes || '',          // 9: notes
                                point.timestamp,            // 10: timestamp
                                project.saved ? '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á', // 11: status
                                '',                         // 12: mapImageUrl
                                point.connectionImageUrl || '', // 13: connectionImageUrl
                                point.documentUrl || '',    // 14: documentUrl
                                point.pointImageUrl || ''   // 15: pointImageUrl
                            ]);
                        });
                    });
                    
                    if (data.length > 0) {
                        console.log(`üìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage: ${data.length} ‡∏à‡∏∏‡∏î`);
                    } else {
                        console.log('üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage');
                    }
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏îshboard
                allProjectData = data || [];
                filteredProjectData = [...allProjectData];
                updateDashboardDisplay(allProjectData);
                
                Swal.close();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage
                if (data && data.length > 0 && !data.some(row => row[11] === '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß')) {
                    const localDataCount = JSON.parse(localStorage.getItem('surveyData') || '[]').length;
                    if (localDataCount > 0) {
                        Swal.fire({
                            title: 'üì± ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
                            html: `
                                <p>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                                <p class="text-sm text-gray-600 mt-2">‡∏û‡∏ö ${localDataCount} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets</p>
                                <div class="mt-3 p-3 bg-blue-50 rounded">
                                    <p class="text-sm text-blue-600">
                                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    </p>
                                </div>
                            `,
                            icon: 'info',
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                            timer: 40000
                        });
                    }
                }
                
            } catch (error) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î:', error);
                Swal.close();
                
                // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                try {
                    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    if (localData.length > 0) {
                        console.log('üîÑ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å localStorage');
                        
                        const data = [];
                        localData.forEach(project => {
                            project.points.forEach(point => {
                                data.push([
                                    project.surveyor, project.project, point.pointNumber,
                                    point.lat, point.lng, point.poleType,
                                    point.equipment || '', point.poleHead || '', point.wireSupport || '',
                                    point.notes || '', point.timestamp, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á',
                                    '', point.connectionImageUrl || '', point.documentUrl || '', point.pointImageUrl || ''
                                ]);
                            });
                        });
                        
                        allProjectData = data;
                        filteredProjectData = [...allProjectData];
                        updateDashboardDisplay(allProjectData);
                        
                        Swal.fire({
                            title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á',
                            text: '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
                            icon: 'info',
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                        });
                    } else {
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                    }
                } catch (localError) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á error
                    allProjectData = [];
                    filteredProjectData = [];
                    updateDashboardDisplay([]);
                    
                    console.log('üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö - ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏õ‡∏•‡πà‡∏≤');
                }
            }
        }

        function updateDashboardDisplay(data) {
            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            const currentFilteredData = getCurrentFilteredData(data);
            
            const projects = [...new Set(currentFilteredData.map(row => row[1]).filter(p => p))];
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalPointsAll').textContent = currentFilteredData.length;
            
            const totalDistanceAll = currentFilteredData.reduce((sum, row, index) => {
                if (index > 0 && row[1] === currentFilteredData[index-1][1]) {
                    return sum + calculateDistance(
                        parseFloat(currentFilteredData[index-1][3]), parseFloat(currentFilteredData[index-1][4]),
                        parseFloat(row[3]), parseFloat(row[4])
                    );
                }
                return sum;
            }, 0);
            
            document.getElementById('totalDistanceAll').textContent = `${Math.round(totalDistanceAll).toLocaleString('th-TH')} ‡∏°.`;
            
            updateSurveyorStats(currentFilteredData, projects.length);
            updateSurveyorFilter(data); // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
            updateYearFilter(data); // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
            updateProjectTable(data);
        }
        
        function getCurrentFilteredData(data) {
            const yearFilter = document.getElementById('filterYear')?.value;
            
            if (!yearFilter || yearFilter === '') {
                return data;
            }
            
            return data.filter(row => {
                if (!row[10]) return false; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                try {
                    let date;
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    if (row[10].includes('/')) {
                        const parts = row[10].split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            let year = parseInt(parts[2]);
                            
                            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (3111 -> 2568)
                            if (year === 3111) {
                                year = 2568;
                            }
                            
                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                            const actualYear = year > 2500 ? year - 543 : year;
                            date = new Date(actualYear, month, day);
                            
                            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ ‡∏û.‡∏®.
                            const dataYear = year > 2500 ? year : year;
                            return dataYear.toString() === yearFilter;
                        }
                    } else {
                        date = new Date(row[10]);
                        if (date && !isNaN(date.getTime())) {
                            const dataYear = date.getFullYear(); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
                            return dataYear.toString() === yearFilter;
                        }
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            });
        }
        
        function updateSurveyorStats(data, totalProjects) {
            const surveyorProjects = {};
            
            // ‡∏ô‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à
            const projects = [...new Set(data.map(row => row[1]).filter(p => p))];
            projects.forEach(project => {
                const projectData = data.find(row => row[1] === project);
                if (projectData && projectData[0]) {
                    const surveyor = projectData[0];
                    surveyorProjects[surveyor] = (surveyorProjects[surveyor] || 0) + 1;
                }
            });
            
            const statsContainer = document.getElementById('surveyorStats');
            statsContainer.innerHTML = '';
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏´‡∏≤‡∏ô‡πâ‡∏≠‡∏¢
            const sortedSurveyors = Object.entries(surveyorProjects).sort((a, b) => {
                const percentageA = totalProjects > 0 ? ((a[1] / totalProjects) * 100) : 0;
                const percentageB = totalProjects > 0 ? ((b[1] / totalProjects) * 100) : 0;
                return percentageB - percentageA;
            });
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à
            sortedSurveyors.forEach(([surveyor, projectCount]) => {
                const percentage = totalProjects > 0 ? ((projectCount / totalProjects) * 100).toFixed(1) : 0;
                
                const card = document.createElement('div');
                card.className = 'dashboard-panel p-4 text-center';
                card.innerHTML = `
                    <div class="text-2xl mb-2">üë§</div>
                    <h4 class="font-semibold text-gray-800 mb-2 text-sm">${surveyor}</h4>
                    <div class="text-2xl font-bold text-blue-600 mb-1">${projectCount}</div>
                    <div class="text-xs text-gray-600">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
                    <div class="text-sm font-medium text-green-600 mt-2">${percentage}%</div>
                `;
                
                statsContainer.appendChild(card);
            });
        }

        let currentPage = 1;
        const itemsPerPage = 20;
        let currentProjectSummary = {};
        let sortColumn = '';
        let sortDirection = 'asc';
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            const projects = Object.entries(currentProjectSummary);
            
            projects.sort((a, b) => {
                let valueA, valueB;
                
                switch (column) {
                    case 'index':
                        return sortDirection === 'asc' ? 0 : 0; // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                    case 'surveyor':
                        valueA = a[1].surveyor;
                        valueB = b[1].surveyor;
                        break;
                    case 'project':
                        valueA = a[0];
                        valueB = b[0];
                        break;
                    case 'distance':
                        valueA = a[1].distance;
                        valueB = b[1].distance;
                        break;
                    case 'status':
                        valueA = a[1].status;
                        valueB = b[1].status;
                        break;
                    case 'date':
                        valueA = a[1].date || '';
                        valueB = b[1].date || '';
                        break;
                    default:
                        return 0;
                }
                
                if (typeof valueA === 'number' && typeof valueB === 'number') {
                    return sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
                } else {
                    const comparison = String(valueA).localeCompare(String(valueB), 'th');
                    return sortDirection === 'asc' ? comparison : -comparison;
                }
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï currentProjectSummary ‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
            const sortedSummary = {};
            projects.forEach(([project, summary]) => {
                sortedSummary[project] = summary;
            });
            currentProjectSummary = sortedSummary;
            
            currentPage = 1;
            renderTablePage();
        }
        
        function updateProjectTable(data) {
            filteredProjectData = data;
            
            const projectSummary = {};
            
            data.forEach(row => {
                const project = row[1];
                
                if (!projectSummary[project]) {
                    projectSummary[project] = {
                        projectName: project,
                        surveyor: row[0],
                        distance: 0,
                        status: row[11] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á',
                        mapImageUrl: row[12] || '',
                        connectionImageUrl: row[13] || '',
                        documentUrl: row[14] || '',
                        date: row[10] || ''
                    };
                }
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
                const projectData = data.filter(d => d[1] === project);
                let totalDistance = 0;
                for (let i = 1; i < projectData.length; i++) {
                    totalDistance += calculateDistance(
                        parseFloat(projectData[i-1][3]), parseFloat(projectData[i-1][4]),
                        parseFloat(projectData[i][3]), parseFloat(projectData[i][4])
                    );
                }
                projectSummary[project].distance = totalDistance;
            });
            
            currentProjectSummary = projectSummary;
            currentPage = 1;
            renderTablePage();
        }
        
        function renderTablePage() {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';
            
            const projects = Object.entries(currentProjectSummary);
            const totalPages = Math.ceil(projects.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentProjects = projects.slice(startIndex, endIndex);
            
            currentProjects.forEach(([projectKey, summary], index) => {
                const globalIndex = startIndex + index + 1;
                
                // ‡πÉ‡∏ä‡πâ projectName ‡πÅ‡∏ó‡∏ô project key
                const projectName = summary.projectName;
                
                // ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                const truncatedProject = projectName.length > 30 ? projectName.substring(0, 30) + '...' : projectName;
                
                // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                let formattedDate = '-';
                if (summary.date) {
                    try {
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
                        let date;
                        
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY
                        if (summary.date.includes('/')) {
                            const parts = summary.date.split(' ')[0].split('/'); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // JavaScript month ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0
                                let year = parseInt(parts[2]);
                                
                                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (3111 -> 2568)
                                if (year === 3111) {
                                    year = 2568;
                                }
                                
                                // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                                const actualYear = year > 2500 ? year - 543 : year;
                                date = new Date(actualYear, month, day);
                                
                                // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY (‡∏û.‡∏®.)
                                const formattedDay = date.getDate().toString().padStart(2, '0');
                                const formattedMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                                const formattedYear = year > 2500 ? year : year; // ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ ‡∏û.‡∏®.
                                formattedDate = `${formattedDay}/${formattedMonth}/${formattedYear}`;
                            }
                        } else {
                            // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
                            date = new Date(summary.date);
                            if (date && !isNaN(date.getTime())) {
                                const day = date.getDate().toString().padStart(2, '0');
                                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                                const year = date.getFullYear(); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
                                formattedDate = `${day}/${month}/${year}`;
                            }
                        }
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        formattedDate = summary.date; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                    }
                }
                
                // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ
                const formattedDistance = Math.round(summary.distance).toLocaleString('th-TH');
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm">${globalIndex}</td>
                    <td class="px-6 py-4 text-sm">${summary.surveyor}</td>
                    <td class="px-6 py-4 text-sm font-medium" title="${projectName}">${truncatedProject}</td>
                    <td class="px-6 py-4 text-sm">${formattedDistance}</td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.mapImageUrl ? `
                            <a href="javascript:void(0)" onclick="showImagePreview('${encodeURIComponent(summary.mapImageUrl)}')" 
                               onmouseover="showHoverImage(event, '${encodeURIComponent(summary.mapImageUrl)}')" 
                               onmouseout="hideHoverImage()" 
                               class="text-blue-600 hover:underline">üó∫Ô∏è ‡∏î‡∏π‡∏†‡∏≤‡∏û</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.connectionImageUrl ? `
                            <a href="javascript:void(0)" onclick="showImagePreview('${encodeURIComponent(summary.connectionImageUrl)}')" 
                               onmouseover="showHoverImage(event, '${encodeURIComponent(summary.connectionImageUrl)}')" 
                               onmouseout="hideHoverImage()" 
                               class="text-blue-600 hover:underline">üì∑ ‡∏î‡∏π‡∏†‡∏≤‡∏û</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.documentUrl ? `
                            <a href="${summary.documentUrl}" target="_blank" rel="noopener noreferrer" 
                               class="text-blue-600 hover:underline">üìÑ ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <select class="text-sm p-2 border rounded-lg" onchange="updateProjectStatus('${projectName}', this.value)">
                            <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á" ${summary.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á' ? 'selected' : ''}>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á</option>
                            <option value="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß" ${summary.status === '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß' ? 'selected' : ''}>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-sm">${formattedDate}</td>
                    <td class="px-6 py-4 text-sm">
                        <button class="download-kml bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium"
        data-project="${projectName}">
  üì• KML
</button>

                    </td>
                `;
                tbody.appendChild(row);
            });
            
            renderPagination(totalPages);
        }
        
        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) {
                const container = document.createElement('div');
                container.id = 'paginationContainer';
                container.className = 'flex justify-center items-center space-x-2 p-4 bg-gray-50';
                document.getElementById('tableContainer').appendChild(container);
            }
            
            const pagination = document.getElementById('paginationContainer');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            const prevBtn = document.createElement('button');
            prevBtn.className = `px-3 py-2 rounded-lg text-sm font-medium ${currentPage === 1 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            prevBtn.textContent = '‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTablePage();
                }
            };
            pagination.appendChild(prevBtn);
            
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤
            const pageInfo = document.createElement('span');
            pageInfo.className = 'px-4 py-2 text-sm text-gray-700';
            pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages}`;
            pagination.appendChild(pageInfo);
            
            // ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            const nextBtn = document.createElement('button');
            nextBtn.className = `px-3 py-2 rounded-lg text-sm font-medium ${currentPage === totalPages ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            nextBtn.textContent = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTablePage();
                }
            };
            pagination.appendChild(nextBtn);
        }
        
        function showHoverImage(event, encodedImageUrl) {
            try {
                let imageUrl = decodeURIComponent(encodedImageUrl);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á Google Drive URL
                if (imageUrl.includes('drive.google.com/uc?export=view&id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s800`;
                    }
                } else if (imageUrl.includes('drive.google.com/uc?id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s800`;
                    }
                } else if (imageUrl.includes('drive.google.com')) {
                    const fileIdMatch = imageUrl.match(/\/d\/([a-zA-Z0-9-_]+)/) || imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s800`;
                    }
                }
                
                console.log('Showing hover image:', imageUrl);
                
                // ‡∏•‡∏ö hover image ‡πÄ‡∏Å‡πà‡∏≤
                hideHoverImage();
                
                const hoverImg = document.createElement('img');
                hoverImg.id = 'hoverImage';
                hoverImg.className = 'hover-image';
                hoverImg.style.cssText = `
                    position: absolute;
                    z-index: 15000;
                    left: ${event.pageX + 10}px;
                    top: ${event.pageY + 10}px;
                    max-width: 300px;
                    max-height: 200px;
                    object-fit: contain;
                    border: 2px solid white;
                    border-radius: 8px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    background-color: white;
                    padding: 4px;
                    pointer-events: none;
                    display: block;
                `;
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error
                hoverImg.onerror = function() {
                    console.error('Failed to load hover image:', imageUrl);
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y3ZjdmNyIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiPuC5hOC4oeC5iOC4quC4suC4oeC4suC4o+C4luC5guC4q+C4peC4lOC4oOC4suC4nuC5hOC4lOC5iDwvdGV4dD48L3N2Zz4=';
                    this.alt = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ';
                };
                
                hoverImg.onload = function() {
                    console.log('Hover image loaded successfully');
                };
                
                hoverImg.src = imageUrl;
                document.body.appendChild(hoverImg);
                
            } catch (error) {
                console.error('Error in showHoverImage:', error);
            }
        }
        
        function hideHoverImage() {
            const hoverImg = document.getElementById('hoverImage');
            if (hoverImg) {
                hoverImg.remove();
            }
        }
        
        function showImagePreview(encodedImageUrl) {
            try {
                let imageUrl = decodeURIComponent(encodedImageUrl);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á Google Drive URL
                if (imageUrl.includes('drive.google.com/uc?export=view&id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s1600`;
                    }
                } else if (imageUrl.includes('drive.google.com/uc?id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s1600`;
                    }
                } else if (imageUrl.includes('drive.google.com')) {
                    const fileIdMatch = imageUrl.match(/\/d\/([a-zA-Z0-9-_]+)/) || imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s1600`;
                    }
                }
                
                console.log('Showing image preview:', imageUrl);
                
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 20000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const img = document.createElement('img');
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                `;
                img.alt = '‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á';
                
                img.onerror = function() {
                    console.error('Failed to load preview image:', imageUrl);
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y3ZjdmNyIvPjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTk5OTkiPuC5hOC4oeC5iOC4quC4suC4oeC4suC4o+C4luC5guC4q+C4peC4lOC4oOC4suC4nuC5hOC4lOC5iDwvdGV4dD48L3N2Zz4=';
                    this.alt = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ';
                };
                
                img.onload = function() {
                    console.log('Preview image loaded successfully');
                };
                
                img.src = imageUrl;
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'image-preview-close';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    font-size: 20px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                closeBtn.textContent = '√ó';
                closeBtn.onclick = closeImagePreview;
                
                preview.appendChild(closeBtn);
                preview.appendChild(img);
                preview.onclick = function(e) {
                    if (e.target === preview) {
                        closeImagePreview();
                    }
                };
                
                document.body.appendChild(preview);
                
            } catch (error) {
                console.error('Error in showImagePreview:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
            }
        }
        
        function closeImagePreview() {
            const preview = document.querySelector('.image-preview');
            if (preview) {
                preview.remove();
            }
        }

        function updateSurveyorFilter(data) {
            const filterSelect = document.getElementById('filterSurveyor');
            const currentValue = filterSelect.value;
            const surveyors = [...new Set(data.map(row => row[0]).filter(s => s))];
            
            filterSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            surveyors.forEach(surveyor => {
                const selected = surveyor === currentValue ? 'selected' : '';
                filterSelect.innerHTML += `<option value="${surveyor}" ${selected}>${surveyor}</option>`;
            });
        }
        
        function updateYearFilter(data) {
            const filterSelect = document.getElementById('filterYear');
            const currentValue = filterSelect.value;
            const years = new Set();
            
            data.forEach(row => {
                if (row[10]) { // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    try {
                        const date = new Date(row[10]);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            if (year >= 2020 && year <= 2030) { // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
                                years.add(year);
                            }
                        }
                    } catch (error) {
                        // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    }
                }
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ 2568 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            years.add(2568);
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            filterSelect.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>';
            sortedYears.forEach(year => {
                const selected = (year.toString() === currentValue || (!currentValue && year === 2568)) ? 'selected' : '';
                filterSelect.innerHTML += `<option value="${year}" ${selected}>${year}</option>`;
            });
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 2568 ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (!currentValue && sortedYears.includes(2568)) {
                filterSelect.value = '2568';
            }
        }

        function filterTable() {
            const surveyorFilter = document.getElementById('filterSurveyor').value;
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const yearFilter = document.getElementById('filterYear').value;
            
            let filteredData = [...allProjectData];
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à
            if (surveyorFilter && surveyorFilter !== '' && surveyorFilter !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') {
                filteredData = filteredData.filter(row => row[0] === surveyorFilter);
            }
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            if (searchTerm && searchTerm !== '') {
                filteredData = filteredData.filter(row => 
                    row[1] && row[1].toString().toLowerCase().includes(searchTerm)
                );
            }
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ (‡πÉ‡∏ä‡πâ Range Slider)
            if (yearFilter && yearFilter !== '') {
                filteredData = filteredData.filter(row => {
                    if (!row[10]) return false; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    try {
                        let date;
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                        if (row[10].includes('/')) {
                            const parts = row[10].split(' ')[0].split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1;
                                let year = parseInt(parts[2]);
                                
                                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (3111 -> 2568)
                                if (year === 3111) {
                                    year = 2568;
                                }
                                
                                // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                                const actualYear = year > 2500 ? year - 543 : year;
                                date = new Date(actualYear, month, day);
                                
                                // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ ‡∏û.‡∏®.
                                const dataYear = year > 2500 ? year : year;
                                return dataYear.toString() === yearFilter;
                            }
                        } else {
                            date = new Date(row[10]);
                            if (date && !isNaN(date.getTime())) {
                                const dataYear = date.getFullYear(); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
                                return dataYear.toString() === yearFilter;
                            }
                        }
                        return false;
                    } catch (error) {
                        return false;
                    }
                });
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            updateDashboardStats(filteredData);
            updateProjectTable(filteredData);
        }
        
        function updateDashboardStats(data) {
            const projects = [...new Set(data.map(row => row[1]).filter(p => p))];
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalPointsAll').textContent = data.length;
            
            const totalDistanceAll = data.reduce((sum, row, index) => {
                if (index > 0 && row[1] === data[index-1][1]) {
                    return sum + calculateDistance(
                        parseFloat(data[index-1][3]), parseFloat(data[index-1][4]),
                        parseFloat(row[3]), parseFloat(row[4])
                    );
                }
                return sum;
            }, 0);
            
            document.getElementById('totalDistanceAll').textContent = `${Math.round(totalDistanceAll).toLocaleString('th-TH')} ‡∏°.`;
            
            updateSurveyorStats(data, projects.length);
        }

        function updateYearDisplay() {
            const yearSlider = document.getElementById('filterYear');
            const yearDisplay = document.getElementById('yearDisplay');
            if (yearSlider && yearDisplay) {
                yearDisplay.textContent = yearSlider.value;
            }
        }
        
        function clearFilters() {
            document.getElementById('filterSurveyor').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('filterYear').value = '2568'; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 2568
            updateYearDisplay();
            filterTable();
        }

        function toggleTable() {
            const tableContainer = document.getElementById('tableContainer');
            const toggleBtn = document.getElementById('toggleTableBtn');
            const dashboardPanel = tableContainer.closest('.dashboard-panel');
            
            if (!tableContainer || !toggleBtn) {
                console.error('Table container or toggle button not found');
                return;
            }
            
            if (isTableExpanded) {
                // ‡∏¢‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                tableContainer.style.maxHeight = '400px';
                tableContainer.style.overflow = 'auto';
                dashboardPanel.style.position = 'static';
                dashboardPanel.style.zIndex = 'auto';
                dashboardPanel.style.width = 'auto';
                dashboardPanel.style.height = 'auto';
                toggleBtn.innerHTML = 'üìã ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
                isTableExpanded = false;
            } else {
                // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠
                tableContainer.style.maxHeight = 'calc(100vh - 200px)';
                tableContainer.style.overflow = 'auto';
                dashboardPanel.style.position = 'fixed';
                dashboardPanel.style.top = '20px';
                dashboardPanel.style.left = '20px';
                dashboardPanel.style.right = '20px';
                dashboardPanel.style.bottom = '20px';
                dashboardPanel.style.zIndex = '25000';
                dashboardPanel.style.width = 'calc(100vw - 40px)';
                dashboardPanel.style.height = 'calc(100vh - 40px)';
                toggleBtn.innerHTML = 'üìã ‡∏¢‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
                isTableExpanded = true;
            }
        }

        async function updateProjectStatus(project, status) {
  try {
    showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...');

    // 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á Google Sheets ‡∏Å‡πà‡∏≠‡∏ô
    let updatedInSheets = false;
    try {
      const params = new URLSearchParams({
        action: 'updateStatus',
        project: project,
        status: status,
        sheetId: SHEET_ID   // <<< ‡∏™‡πà‡∏á sheetId ‡πÑ‡∏õ‡∏ù‡∏±‡πà‡∏á Apps Script
      });

      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString()
      });

      // ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á GAS ‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á text ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏ó‡∏ô JSON ‚Äî ‡πÄ‡∏£‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ
      const raw = await response.text();
      let result = {};
      try { result = JSON.parse(raw); } catch (_) { /* not JSON */ }

      // ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö {success:true} ‡∏´‡∏£‡∏∑‡∏≠ {status:"ok"} ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏°‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏±‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ok/success
      updatedInSheets =
        (result && (result.success === true || result.status === 'ok')) ||
        /"success"\s*:\s*true/i.test(raw) ||
        /\bok\b|\bsuccess\b/i.test(raw);
    } catch (err) {
      console.log('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Google Sheets ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', err);
    }

    // 2) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ (‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î)
    allProjectData.forEach(row => {
      if (row[1] === project) {
        row[11] = status; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå L (index 11) = Status
      }
    });

    // 3) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô localStorage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
    const projectIndex = localData.findIndex(p => p.project === project);
    if (projectIndex !== -1) {
      localData[projectIndex].saved = (status === '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß');
      localStorage.setItem('surveyData', JSON.stringify(localData));
    }

    // 4) ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
    updateProjectTable(allProjectData);

    hideLoadingOverlay();

    // 5) ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏≠‡∏á" (‡πÑ‡∏°‡πà‡∏°‡∏µ timer)
    const message = updatedInSheets
      ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
      : '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö Google Sheets)';

    Swal.fire({
      title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
      text: message,
      icon: 'success',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
      allowOutsideClick: false,
      allowEscapeKey: false
    });
  } catch (error) {
    hideLoadingOverlay();
    Swal.fire({
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: ' + (error?.message || ''),
      icon: 'error',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
      allowOutsideClick: false,
      allowEscapeKey: false
    });
  }
}


        async function exportLocalData() {
            try {
                const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                
                if (localData.length === 0) {
                    Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'info');
                    return;
                }
                
                const result = await Swal.fire({
                    title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    html: `
                        <p>‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${localData.length} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                        <p class="text-sm text-gray-600 mt-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å:</p>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: 'üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON',
                    denyButtonText: 'üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    confirmButtonColor: '#3b82f6',
                    denyButtonColor: '#10b981'
                });
                
                if (result.isConfirmed) {
                    // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô JSON
                    exportAsJSON(localData);
                } else if (result.isDenied) {
                    // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV
                    exportAsCSV(localData);
                }
                
            } catch (error) {
                console.error('Error exporting data:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }
        
        function exportAsJSON(data) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            Swal.fire({
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
        }
        
        function exportAsCSV(data) {
            let csvContent = '‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à,‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô,‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà,‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤,‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå,‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤,‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n';
            
            data.forEach(project => {
                project.points.forEach(point => {
                    const row = [
                        project.surveyor,
                        project.project,
                        point.pointNumber,
                        point.lat,
                        point.lng,
                        point.poleType,
                        point.equipment || '',
                        point.poleHead || '',
                        point.wireSupport || '',
                        point.notes || '',
                        point.timestamp,
                        project.saved ? '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á'
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° BOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UTF-8
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            Swal.fire({
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                timer: 20000,
                showConfirmButton: false
            });
        }

        async function downloadKML(project) {
            try {
                showLoadingOverlay('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå KML...');
                
               // ‡∏•‡∏≠‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡∏Å‡πà‡∏≠‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á JSON ‡πÅ‡∏•‡∏∞ KML ‡∏ï‡∏£‡∏á‡πÜ)
try {
  const response = await fetch(`${SCRIPT_URL}?action=generateKML&project=${encodeURIComponent(project)}`);
  const raw = await response.text();

  // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse ‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏Å‡πà‡∏≠‡∏ô
  let data = null;
  try { data = JSON.parse(raw); } catch (_) {}

  let kmlPayload = null;

  if (data && data.success && typeof data.kml === 'string' && data.kml.trim()) {
    // ‡πÄ‡∏Ñ‡∏™: Apps Script ‡∏™‡πà‡∏á JSON { success:true, kml:"..." }
    kmlPayload = data.kml;
  } else if (/^\s*<\?xml[\s\S]*<kml[\s\S]*<\/kml>\s*$/i.test(raw) || /^\s*<kml[\s\S]*<\/kml>\s*$/i.test(raw)) {
    // ‡πÄ‡∏Ñ‡∏™: ‡∏™‡πà‡∏á KML ‡πÄ‡∏õ‡πá‡∏ô XML ‡∏ï‡∏£‡∏á‡πÜ
    kmlPayload = raw;
  }

  if (kmlPayload) {
    const blob = new Blob([kmlPayload], { type: 'application/vnd.google-earth.kml+xml' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${project}.kml`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    hideLoadingOverlay();

    Swal.fire({
      title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
      text: '‡πÑ‡∏ü‡∏•‡πå KML ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      icon: 'success',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
      allowOutsideClick: false
    });
    return;
  }
} catch (error) {
  console.log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ:', error?.message || error);
}

                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á KML ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                const projectPoints = allProjectData.filter(row => row[1] === project);
                
                if (projectPoints.length === 0) {
                    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å localStorage
                    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    const projectData = localData.find(p => p.project === project);
                    
                    if (!projectData) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£');
                    }
                    
                    const kmlContent = generateKMLFromLocalData(projectData);
                    downloadKMLFile(kmlContent, project);
                } else {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á KML ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                    const kmlContent = generateKMLFromDashboardData(projectPoints);
                    downloadKMLFile(kmlContent, project);
                }
                
                hideLoadingOverlay();
                
                Swal.fire({
                    title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡πÑ‡∏ü‡∏•‡πå KML ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
  			allowOutsideClick: false
                });
                
            } catch (error) {
                console.error('Error downloading KML:', error);
                hideLoadingOverlay();
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå KML ‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }
        
        function downloadKMLFile(kmlContent, project) {
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project}.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function generateKMLFromDashboardData(projectPoints) {
            if (projectPoints.length === 0) return '';
            
            const surveyor = projectPoints[0][0];
            const project = projectPoints[0][1];
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${project}</name>
    <description>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï - ${surveyor}</description>
    
    <Style id="poleStyle">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="lineStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>3</width>
      </LineStyle>
    </Style>
    
    <Placemark>
      <name>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏£‡∏ß‡∏à</name>
      <styleUrl>#lineStyle</styleUrl>
      <LineString>
        <coordinates>`;
        
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç
            projectPoints.sort((a, b) => parseInt(a[2]) - parseInt(b[2]));
            
            projectPoints.forEach(point => {
                kml += `${point[4]},${point[3]},0 `;
            });
            
            kml += `</coordinates>
      </LineString>
    </Placemark>`;
    
            projectPoints.forEach(point => {
                kml += `
    <Placemark>
      <name>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${point[2]}</name>
      <description><![CDATA[
        <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤:</b> ${point[5]}<br/>
        <b>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</b> ${point[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br/>
        <b>‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤:</b> ${point[7] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br/>
        <b>‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á:</b> ${point[8] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br/>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ${point[9] || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}<br/>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</b> ${point[10]}
      ]]></description>
      <styleUrl>#poleStyle</styleUrl>
      <Point>
        <coordinates>${point[4]},${point[3]},0</coordinates>
      </Point>
    </Placemark>`;
            });
            
            kml += `
  </Document>
</kml>`;
            
            return kml;
        }
        
        function generateKMLFromLocalData(projectData) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${projectData.project}</name>
    <description>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï - ${projectData.surveyor}</description>
    
    <Style id="poleStyle">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="lineStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>3</width>
      </LineStyle>
    </Style>
    
    <Placemark>
      <name>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏£‡∏ß‡∏à</name>
      <styleUrl>#lineStyle</styleUrl>
      <LineString>
        <coordinates>`;
        
            projectData.points.forEach(point => {
                kml += `${point.lng},${point.lat},0 `;
            });
            
            kml += `</coordinates>
      </LineString>
    </Placemark>`;
    
            projectData.points.forEach(point => {
                kml += `
    <Placemark>
      <name>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${point.pointNumber}</name>
      <description><![CDATA[
        <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤:</b> ${point.poleType}<br/>
        <b>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</b> ${point.equipment || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br/>
        <b>‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏≤:</b> ${point.poleHead || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br/>
        <b>‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á:</b> ${point.wireSupport || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br/>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ${point.notes || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}<br/>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</b> ${point.timestamp}
      ]]></description>
      <styleUrl>#poleStyle</styleUrl>
      <Point>
        <coordinates>${point.lng},${point.lat},0</coordinates>
      </Point>
    </Placemark>`;
            });
            
            kml += `
  </Document>
</kml>`;
            
            return kml;
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9909fe9ea5e7895a',t:'MTc2MDgxMTA0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>