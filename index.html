<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสำรวจเสาไฟฟ้า PEA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            box-sizing: border-box;
        }
        .map-container {
            height: calc(100vh - 120px);
            position: relative;
        }
        .distance-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .modal {
            z-index: 10000;
        }
        .modal-backdrop {
            z-index: 9999;
        }
        .swal2-container {
            z-index: 20000 !important;
        }
        .swal2-popup {
            z-index: 20001 !important;
        }
        .numbered-marker {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .nav-tab {
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        .card-gradient {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .connection-status {
            position: fixed;
            top: 70px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online {
            background: #10b981;
            color: white;
        }
        .status-offline {
            background: #ef4444;
            color: white;
        }
        .surveyor-card {
            min-width: 200px;
            max-width: 250px;
        }
        .project-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .project-item:hover {
            background-color: #f3f4f6;
        }
        .project-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .project-details.expanded {
            max-height: 500px;
        }
        .surveyor-project-item {
            background: #f8fafc;
            border-left: 3px solid #3b82f6;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .map-container {
                height: calc(100vh - 160px);
            }
            
            .distance-info {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
                min-width: 120px;
                text-align: center;
            }
            
            .connection-status {
                top: 70px;
                right: 10px;
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .nav-tab {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .surveyor-card {
                min-width: 100%;
                max-width: 100%;
            }
            
            .numbered-marker {
                width: 28px;
                height: 28px;
                font-size: 13px;
            }
            
            .modal .bg-white {
                margin: 15px;
                max-height: calc(100vh - 60px);
                border-radius: 12px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-table {
                min-width: 600px;
            }
            
            .mobile-card {
                display: block;
            }
            
            .desktop-table {
                display: none;
            }
            
            .control-panel-mobile {
                padding: 16px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .mobile-buttons {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .mobile-buttons button {
                padding: 12px 16px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 8px;
            }
            
            .current-location-btn {
                position: fixed;
                bottom: 120px;
                right: 15px;
                z-index: 1000;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: #3b82f6;
                color: white;
                border: none;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
            }
            
            .mobile-pin-btn {
                position: fixed;
                bottom: 180px;
                right: 15px;
                z-index: 1000;
                padding: 12px 16px;
                border-radius: 25px;
                background: #10b981;
                color: white;
                border: none;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
                animation: pulse-green 2s infinite;
                gap: 6px;
            }
            
            .center-crosshair {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 999;
                color: #10b981;
                font-size: 24px;
                pointer-events: none;
                text-shadow: 0 0 4px rgba(0,0,0,0.5);
            }
            
            @keyframes pulse-green {
                0% { 
                    transform: scale(1);
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                }
                50% { 
                    transform: scale(1.05);
                    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.6);
                }
                100% { 
                    transform: scale(1);
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                }
            }
            
            .temp-marker {
                background: #f59e0b !important;
                border: 3px solid white !important;
                box-shadow: 0 0 0 2px #f59e0b, 0 4px 12px rgba(245, 158, 11, 0.4) !important;
                animation: pulse 1.5s infinite;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        }
        
        @media (min-width: 769px) {
            .mobile-card {
                display: none;
            }
            
            .desktop-table {
                display: table;
            }
            
            .current-location-btn {
                position: absolute;
                top: 60px;
                right: 10px;
                z-index: 1000;
                width: 40px;
                height: 40px;
                border-radius: 8px;
                background: #3b82f6;
                color: white;
                border: none;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
            }
        }
        
        /* iPhone 6.1" (414px) and 6.7" (428px) specific adjustments */
        @media (max-width: 428px) and (min-width: 375px) {
            .map-container {
                height: calc(100vh - 170px);
            }
            
            .nav-tab {
                padding: 8px 14px;
                font-size: 13px;
            }
            
            .card-gradient {
                padding: 14px;
            }
            
            .btn-primary, .btn-success, .btn-warning, .btn-danger {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .distance-info {
                font-size: 13px;
                padding: 8px 12px;
                min-width: 130px;
            }
            
            .connection-status {
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .control-panel-mobile {
                padding: 18px;
            }
            
            .mobile-buttons button {
                padding: 14px 18px;
                font-size: 15px;
            }
            
            .current-location-btn {
                width: 55px;
                height: 55px;
                bottom: 130px;
                right: 20px;
                font-size: 20px;
            }
        }
        
        /* Very small screens (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .map-container {
                height: calc(100vh - 180px);
            }
            
            .nav-tab {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .modal .bg-white {
                margin: 10px;
                max-height: calc(100vh - 40px);
            }
            
            .distance-info {
                font-size: 11px;
                padding: 6px 10px;
                min-width: 110px;
            }
            
            .current-location-btn {
                width: 45px;
                height: 45px;
                bottom: 110px;
                right: 15px;
                font-size: 16px;
            }
            
            .control-panel-mobile {
                padding: 12px;
            }
            
            .mobile-buttons button {
                padding: 10px 14px;
                font-size: 13px;
            }
        }
        
        /* Distance label improvements */
        .distance-label {
            pointer-events: none;
        }
        
        .distance-label div {
            background: rgba(245, 158, 11, 0.98) !important;
            color: white !important;
            padding: 6px 12px !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            font-weight: bold !important;
            white-space: nowrap !important;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4) !important;
            border: 3px solid white !important;
            min-width: 60px !important;
            text-align: center !important;
        }
        
        @media (max-width: 768px) {
            .distance-label div {
                font-size: 12px !important;
                padding: 5px 10px !important;
                min-width: 55px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Connection Status -->
    <div id="connection-status" class="connection-status status-offline hidden">
        <i class="fas fa-wifi mr-1"></i>
        <span id="status-text">กำลังเชื่อมต่อ...</span>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="px-4 py-3">
            <div class="flex justify-between items-center">
                <h1 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-bolt text-blue-600 mr-2"></i>
                    ระบบสำรวจเสาไฟฟ้า PEA
                </h1>
                <div class="flex space-x-2">
                    <button onclick="showTab('dashboard')" class="nav-tab px-3 py-2 rounded-lg text-sm font-medium" id="tab-dashboard">
                        <i class="fas fa-chart-pie mr-1"></i>แดชบอร์ด
                    </button>
                    <button onclick="showTab('survey')" class="nav-tab px-3 py-2 rounded-lg text-sm font-medium active" id="tab-survey">
                        <i class="fas fa-map-marker-alt mr-1"></i>สำรวจ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="hidden p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <div class="card-gradient p-4 rounded-lg shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">โครงการทั้งหมด</p>
                        <p class="text-2xl font-bold text-blue-600" id="total-projects">0</p>
                    </div>
                    <i class="fas fa-project-diagram text-3xl text-blue-400"></i>
                </div>
            </div>
            <div class="card-gradient p-4 rounded-lg shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">ผู้สำรวจทั้งหมด</p>
                        <p class="text-2xl font-bold text-green-600" id="total-surveyors">0</p>
                    </div>
                    <i class="fas fa-users text-3xl text-green-400"></i>
                </div>
            </div>
            <div class="card-gradient p-4 rounded-lg shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">จุดสำรวจทั้งหมด</p>
                        <p class="text-2xl font-bold text-purple-600" id="total-points">0</p>
                    </div>
                    <i class="fas fa-map-pin text-3xl text-purple-400"></i>
                </div>
            </div>
        </div>

        <!-- Surveyor Cards -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">สถิติตามผู้สำรวจ</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="surveyor-cards">
                <!-- Surveyor cards will be populated here -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="text-lg font-semibold mb-4">จัดการข้อมูล</h3>
            
            <!-- Filter Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">กรองตามผู้สำรวจ</label>
                    <select id="surveyor-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="applyFilters()">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ค้นหาโครงการ</label>
                    <input type="text" id="project-search" placeholder="ชื่อโครงการ..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="applyFilters()">
                </div>
                <div class="flex items-end">
                    <button onclick="clearFilters()" class="w-full bg-gray-500 text-white px-4 py-3 rounded-lg font-medium">
                        <i class="fas fa-times mr-2"></i>ล้างตัวกรอง
                    </button>
                </div>
            </div>
            
            <!-- Export Section -->
            <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                <button onclick="exportAllKML()" class="btn-primary text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-download mr-2"></i>Export ไฟล์ KML ทั้งหมด
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold mb-4">สถานะโครงการ</h3>
            
            <!-- Desktop Table -->
            <div class="desktop-table table-container">
                <div class="max-h-80 overflow-y-auto border border-gray-300 rounded-lg">
                    <table class="w-full border-collapse table-fixed">
                        <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="border-b border-gray-300 px-4 py-3 text-left text-sm font-semibold w-16 bg-gray-100">ลำดับ</th>
                                <th class="border-b border-gray-300 px-4 py-3 text-left text-sm font-semibold w-48 bg-gray-100">ชื่อผู้สำรวจ</th>
                                <th class="border-b border-gray-300 px-4 py-3 text-left text-sm font-semibold w-64 bg-gray-100">โครงการ</th>
                                <th class="border-b border-gray-300 px-4 py-3 text-left text-sm font-semibold w-32 bg-gray-100">ระยะทางรวม (เมตร)</th>
                                <th class="border-b border-gray-300 px-4 py-3 text-left text-sm font-semibold w-40 bg-gray-100">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="project-table-body">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Mobile Cards -->
            <div class="mobile-card space-y-3" id="project-mobile-cards">
                <!-- Mobile cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Survey Tab -->
    <div id="survey-tab" class="relative">
        <!-- Control Panel -->
        <div class="bg-white shadow-md p-4">
            <div class="space-y-4 md:space-y-0 md:flex md:flex-wrap md:gap-4 md:justify-between md:items-center">
                <div class="space-y-3 md:space-y-0 md:flex md:items-center md:space-x-4">
                    <div class="flex items-center justify-between md:justify-start md:space-x-2">
                        <span class="text-sm font-medium text-gray-700">จุดสำรวจ:</span>
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-bold" id="point-counter">0</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 md:flex md:items-center md:space-x-4">
                        <div class="flex flex-col md:flex-row md:items-center md:space-x-2">
                            <label class="text-sm font-medium text-gray-700 mb-1 md:mb-0">ผู้สำรวจ:</label>
                            <select id="main-surveyor-select" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full md:min-w-[150px]">
                                <option value="">เลือกผู้สำรวจ</option>
                            </select>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center md:space-x-2">
                            <label class="text-sm font-medium text-gray-700 mb-1 md:mb-0">โครงการ:</label>
                            <input type="text" id="project-name-input" placeholder="ชื่อโครงการ" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full md:min-w-[150px]">
                        </div>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                    <button onclick="startSurvey()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium w-full md:w-auto" id="start-btn">
                        <i class="fas fa-play mr-1"></i>เริ่มสำรวจ
                    </button>
                    <button onclick="finishSurvey()" class="btn-success text-white px-4 py-2 rounded-lg text-sm font-medium w-full md:w-auto hidden" id="finish-btn">
                        <i class="fas fa-save mr-1"></i>บันทึกข้อมูล
                    </button>
                    <button onclick="clearSurvey()" class="btn-danger text-white px-4 py-2 rounded-lg text-sm font-medium w-full md:w-auto hidden" id="clear-btn">
                        <i class="fas fa-trash mr-1"></i>ล้างข้อมูล
                    </button>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map" class="w-full h-full"></div>
            <div class="distance-info" id="distance-info">
                <div class="text-xs text-gray-600">ระยะทางจากจุดล่าสุด</div>
                <div class="font-bold text-blue-600" id="distance-text">-</div>
                <div class="text-xs text-gray-600 mt-1">ระยะรวม</div>
                <div class="font-bold text-green-600" id="total-distance-text">0 เมตร</div>
            </div>
            <button onclick="getCurrentLocation()" class="current-location-btn" title="ตำแหน่งปัจจุบัน">
                <i class="fas fa-crosshairs"></i>
            </button>
            <!-- Mobile Pin Button -->
            <button onclick="pinAtCenter()" class="mobile-pin-btn hidden" id="mobile-pin-btn" title="ปักหมุดที่ตำแหน่งนี้">
                <i class="fas fa-map-pin"></i>
                ปักหมุด
            </button>
            <!-- Center Crosshair -->
            <div class="center-crosshair hidden" id="center-crosshair">
                <i class="fas fa-plus"></i>
            </div>
        </div>
    </div>

    <!-- Survey Point Modal -->
    <div id="survey-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold">ข้อมูลจุดสำรวจ #<span id="modal-point-number">1</span></h3>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทเสา</label>
                    <select id="pole-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกประเภทเสา</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">การติดตั้งอุปกรณ์</label>
                    <select id="equipment" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกอุปกรณ์</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หัวเสา</label>
                    <select id="pole-head" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกหัวเสา</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">สายยึดโยง&เทโคน</label>
                    <select id="guy-wire" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกสายยึดโยง&เทโคน</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">รูปภาพ</label>
                    <input type="file" id="photo-input" accept="image/*" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุ</label>
                    <textarea id="notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="หมายเหตุเพิ่มเติม"></textarea>
                </div>
            </div>
            
            <div class="p-4 border-t flex flex-col space-y-2">
                <button onclick="savePoint()" class="btn-primary text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-plus mr-2"></i>เพิ่มจุดสำรวจ
                </button>
                <button onclick="finishSurveyFromModal()" class="btn-success text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-check mr-2"></i>เสร็จสิ้นการสำรวจ
                </button>
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-times mr-2"></i>ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let surveyPoints = [];
        let currentPointNumber = 0;
        let isAddingPoint = false;
        let currentLat, currentLng;
        let currentMarker = null;
        let options = {};
        let allProjects = [];
        let filteredProjects = [];
        let isOnline = false;
        let measureLine = null;
        let distanceLabel = null;
        let tempMarker = null;
        let isMobile = false;

        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZB9R8J8lToURW_BwXhfLIRAAbK0jI90tOrwhxLuoWqEk4lKzDqxKjtMxkwU2NeHObwQ/exec';
        const SHEET_ID = '1kf_xzfTOx98T5f_9grznU3U0U1MqA87lt_Dl2hGSyAw';
        const FOLDER_ID = '1AmI2prj8Bma9gVBb0oLq7uwkr2D1aERZ';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if mobile device
            isMobile = window.innerWidth <= 768;
            
            initMap();
            loadOptions();
            loadDashboardData();
            showTab('survey');
            checkConnection();
            
            // Listen for resize events
            window.addEventListener('resize', function() {
                isMobile = window.innerWidth <= 768;
                if (map) {
                    setTimeout(() => map.invalidateSize(), 100);
                }
            });
        });

        // Check connection status
        async function checkConnection() {
            const statusElement = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            statusElement.classList.remove('hidden');
            statusText.textContent = 'กำลังตรวจสอบ...';
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=ping&t=${Date.now()}`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    isOnline = true;
                    statusElement.className = 'connection-status status-online';
                    statusText.textContent = 'เชื่อมต่อแล้ว';
                    
                    // Load options from Google Sheets
                    await loadOptionsFromSheets();
                    
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 2000);
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                isOnline = false;
                statusElement.className = 'connection-status status-offline';
                statusText.textContent = 'ออฟไลน์';
                
                // Use default options when offline
                useDefaultOptions();
                
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 3000);
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('survey-tab').classList.add('hidden');
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'survey') {
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add click event for adding points (only for desktop)
            map.on('click', function(e) {
                if (isAddingPoint && !isMobile) {
                    currentLat = e.latlng.lat;
                    currentLng = e.latlng.lng;
                    showSurveyModal();
                }
            });

            // Add mousemove event for distance calculation and line drawing
            map.on('mousemove', function(e) {
                if (isAddingPoint && surveyPoints.length > 0) {
                    updateDistanceInfo(e.latlng);
                    updateMeasureLine(e.latlng);
                }
            });

            // Add touchmove event for mobile distance calculation
            map.on('touchmove', function(e) {
                if (isAddingPoint && surveyPoints.length > 0 && isMobile) {
                    updateDistanceInfo(e.latlng);
                    updateMeasureLine(e.latlng);
                }
            });

            // Add move event for mobile (covers pan/zoom)
            map.on('move', function(e) {
                if (isAddingPoint && surveyPoints.length > 0 && isMobile) {
                    const center = map.getCenter();
                    updateDistanceInfo(center);
                    updateMeasureLine(center);
                }
            });

            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location',
                            html: '<i class="fas fa-crosshairs text-red-500 text-xl"></i>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map).bindPopup('ตำแหน่งปัจจุบัน');
                });
            }
        }

        // Load options from Google Sheets
        async function loadOptionsFromSheets() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getOptions&sheetId=${SHEET_ID}&t=${Date.now()}`);
                const data = await response.json();
                
                if (data.success) {
                    options = data.options;
                    populateDropdowns();
                    populateSurveyorSelect();
                } else {
                    throw new Error('Failed to load options');
                }
            } catch (error) {
                console.error('Error loading options from sheets:', error);
                useDefaultOptions();
            }
        }

        // Load options (fallback to default if needed)
        function loadOptions() {
            if (isOnline) {
                loadOptionsFromSheets();
            } else {
                useDefaultOptions();
            }
        }

        // Use default options
        function useDefaultOptions() {
            options = {
                surveyors: [
                    'ศุภกฤษ ทะวัง', 
                    'อาทิตย์ สมบัติ', 
                    'สนธยา คำจันทร์'
                ],
                poleTypes: [
                    '8m', 
                    '9m', 
                    '12m', 
                    '12.20m', 
                    '14m',
                    '14.30m',
                    '22m'
                ],
                equipment: [
                    'หม้อแปลง', 
                    'สวิตช์', 
                    'คาปาซิเตอร์', 
                    'ไม่มีอุปกรณ์',
                    'เครื่องตัดไฟอัตโนมัติ', 
                    'เซอร์กิตเบรกเกอร์',
                    'ฟิวส์',
                    'อุปกรณ์วัดไฟฟ้า'
                ],
                poleHeads: [
                    'ทางตรง', 
                    'ทางโค้ง', 
                    'DDE', 
                    'DE'
                ],
                guyWires: [
                    'มีสายยึดโยง', 
                    'ไม่มีสายยึดโยง', 
                    'เทโคน', 
                    'ทั้งสอง'
                ]
            };
            populateDropdowns();
            populateSurveyorSelect();
        }

        // Populate dropdown menus
        function populateDropdowns() {
            const dropdowns = {
                'pole-type': options.poleTypes || [],
                'equipment': options.equipment || [],
                'pole-head': options.poleHeads || [],
                'guy-wire': options.guyWires || []
            };

            Object.keys(dropdowns).forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">เลือก...</option>';
                    
                    const optionsList = dropdowns[id];
                    optionsList.forEach(option => {
                        if (option && option.trim()) {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.trim();
                            optionElement.textContent = option.trim();
                            select.appendChild(optionElement);
                        }
                    });
                }
            });
        }

        // Populate main surveyor select
        function populateSurveyorSelect() {
            const select = document.getElementById('main-surveyor-select');
            if (select && options.surveyors) {
                select.innerHTML = '<option value="">เลือกผู้สำรวจ</option>';
                
                options.surveyors.forEach(surveyor => {
                    if (surveyor && surveyor.trim()) {
                        const option = document.createElement('option');
                        option.value = surveyor.trim();
                        option.textContent = surveyor.trim();
                        select.appendChild(option);
                    }
                });
            }
        }

        // Pin at center (for mobile)
        function pinAtCenter() {
            if (!isAddingPoint) return;
            
            const center = map.getCenter();
            currentLat = center.lat;
            currentLng = center.lng;
            
            showSurveyModal();
        }

        // Start survey
        function startSurvey() {
            const selectedSurveyor = document.getElementById('main-surveyor-select').value;
            const projectName = document.getElementById('project-name-input').value.trim();
            
            if (!selectedSurveyor) {
                Swal.fire({
                    title: 'กรุณาเลือกผู้สำรวจ',
                    text: 'กรุณาเลือกชื่อผู้สำรวจก่อนเริ่มการสำรวจ',
                    icon: 'warning',
                    position: 'top'
                });
                return;
            }

            if (!projectName) {
                Swal.fire({
                    title: 'กรุณาใส่ชื่อโครงการ',
                    text: 'กรุณาใส่ชื่อโครงการก่อนเริ่มการสำรวจ',
                    icon: 'warning',
                    position: 'top'
                });
                return;
            }
            
            isAddingPoint = true;
            document.getElementById('start-btn').classList.add('hidden');
            document.getElementById('finish-btn').classList.remove('hidden');
            document.getElementById('clear-btn').classList.remove('hidden');
            document.getElementById('main-surveyor-select').disabled = true;
            document.getElementById('project-name-input').disabled = true;
            
            // Show mobile controls if on mobile
            if (isMobile) {
                document.getElementById('mobile-pin-btn').classList.remove('hidden');
                document.getElementById('center-crosshair').classList.remove('hidden');
            }
            
            const instructionText = isMobile ? 
                `โครงการ: ${projectName}\nผู้สำรวจ: ${selectedSurveyor}\nใช้ปุ่ม "ปักหมุด" เพื่อปักหมุดจุดสำรวจ` :
                `โครงการ: ${projectName}\nผู้สำรวจ: ${selectedSurveyor}\nคลิกบนแผนที่เพื่อปักหมุดจุดสำรวจ`;
            
            Swal.fire({
                title: 'เริ่มการสำรวจ',
                text: instructionText,
                icon: 'info',
                timer: 3000,
                showConfirmButton: false,
                position: 'top'
            });
        }

        // Update distance info
        function updateDistanceInfo(latlng) {
            if (surveyPoints.length === 0) return;
            
            const lastPoint = surveyPoints[surveyPoints.length - 1];
            const distance = calculateDistance(lastPoint.lat, lastPoint.lng, latlng.lat, latlng.lng);
            
            document.getElementById('distance-text').textContent = `${distance.toFixed(0)} เมตร`;
        }

        // Update measure line with distance label
        function updateMeasureLine(latlng) {
            if (surveyPoints.length === 0) return;
            
            // Remove existing measure line and label
            if (measureLine) {
                map.removeLayer(measureLine);
            }
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
            }
            
            const lastPoint = surveyPoints[surveyPoints.length - 1];
            const distance = calculateDistance(lastPoint.lat, lastPoint.lng, latlng.lat, latlng.lng);
            
            // Create new measure line
            measureLine = L.polyline([
                [lastPoint.lat, lastPoint.lng],
                [latlng.lat, latlng.lng]
            ], {
                color: '#ff6b6b',
                weight: 2,
                opacity: 0.8,
                dashArray: '5, 10'
            }).addTo(map);
            
            // Add distance label at midpoint
            const midLat = (lastPoint.lat + latlng.lat) / 2;
            const midLng = (lastPoint.lng + latlng.lng) / 2;
            
            distanceLabel = L.marker([midLat, midLng], {
                icon: L.divIcon({
                    className: 'distance-label',
                    html: `<div>${distance.toFixed(0)}m</div>`,
                    iconSize: [0, 0],
                    iconAnchor: [0, 0]
                })
            }).addTo(map);
        }

        // Get current location
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                Swal.fire({
                    title: 'ไม่รองรับ GPS',
                    text: 'เบราว์เซอร์นี้ไม่รองรับการหาตำแหน่ง',
                    icon: 'error',
                    position: 'top'
                });
                return;
            }

            Swal.fire({
                title: 'กำลังหาตำแหน่ง...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                position: 'top',
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    map.setView([lat, lng], 18);
                    
                    Swal.fire({
                        title: 'พบตำแหน่งแล้ว!',
                        text: 'แผนที่ได้ย้ายไปยังตำแหน่งปัจจุบันของคุณ',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false,
                        position: 'top'
                    });
                },
                function(error) {
                    let errorMessage = 'ไม่สามารถหาตำแหน่งได้';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'กรุณาอนุญาตการเข้าถึงตำแหน่ง';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ไม่สามารถหาตำแหน่งได้';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'หาตำแหน่งใช้เวลานานเกินไป';
                            break;
                    }
                    
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: errorMessage,
                        icon: 'error',
                        position: 'top'
                    });
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Show survey modal
        function showSurveyModal() {
            // Remove measure line when showing modal
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
                distanceLabel = null;
            }
            
            // Set correct point number (next available number)
            const nextPointNumber = surveyPoints.length + 1;
            document.getElementById('modal-point-number').textContent = nextPointNumber;
            document.getElementById('survey-modal').classList.remove('hidden');
            document.getElementById('survey-modal').classList.add('flex');
        }

        // Close modal
        function closeModal() {
            document.getElementById('survey-modal').classList.add('hidden');
            document.getElementById('survey-modal').classList.remove('flex');
        }

        // Save point and continue
        function savePoint() {
            if (validateForm()) {
                addPointToSurvey();
                closeModal();
                clearForm();
            }
        }

        // Save point and finish
        function saveAndFinish() {
            if (validateForm()) {
                addPointToSurvey();
                closeModal();
                clearForm();
                // Don't call finishSurvey() - just return to survey view
            }
        }

        // Finish survey from modal
        function finishSurveyFromModal() {
            if (validateForm()) {
                addPointToSurvey();
                closeModal();
                clearForm();
                // Remove measure line and return to survey view
                if (measureLine) {
                    map.removeLayer(measureLine);
                    measureLine = null;
                }
                if (distanceLabel) {
                    map.removeLayer(distanceLabel);
                    distanceLabel = null;
                }
                // Stop adding points but keep all markers and data
                isAddingPoint = false;
                document.getElementById('start-btn').classList.remove('hidden');
                document.getElementById('finish-btn').classList.remove('hidden');
                document.getElementById('clear-btn').classList.remove('hidden');
                
                // Hide mobile controls
                document.getElementById('mobile-pin-btn').classList.add('hidden');
                document.getElementById('center-crosshair').classList.add('hidden');
                
                // Show completion message
                Swal.fire({
                    title: 'เสร็จสิ้นการสำรวจ!',
                    text: `ได้ทำการปักหมุด ${surveyPoints.length} จุดแล้ว คุณสามารถดูข้อมูลทั้งหมดบนแผนที่`,
                    icon: 'success',
                    position: 'center'
                });
            }
        }

        // Validate form
        function validateForm() {
            const required = ['pole-type'];
            for (let id of required) {
                if (!document.getElementById(id).value) {
                    Swal.fire({
                        title: 'ข้อมูลไม่ครบถ้วน',
                        text: 'กรุณาเลือกประเภทเสา',
                        icon: 'warning',
                        position: 'top'
                    });
                    return false;
                }
            }
            return true;
        }

        // Add point to survey
        async function addPointToSurvey() {
            const photoFiles = document.getElementById('photo-input').files;
            let photoUrls = [];

            // Handle photo upload
            if (photoFiles.length > 0) {
                for (let file of photoFiles) {
                    const base64 = await fileToBase64(file);
                    photoUrls.push({
                        name: file.name,
                        data: base64,
                        type: file.type
                    });
                }
            }

            const selectedSurveyor = document.getElementById('main-surveyor-select').value;
            const projectName = document.getElementById('project-name-input').value.trim();
            const pointNumber = surveyPoints.length + 1;

            const point = {
                number: pointNumber,
                lat: currentLat,
                lng: currentLng,
                surveyorName: selectedSurveyor,
                projectName: projectName,
                poleType: document.getElementById('pole-type').value,
                equipment: document.getElementById('equipment').value,
                poleHead: document.getElementById('pole-head').value,
                guyWire: document.getElementById('guy-wire').value,
                photos: photoUrls,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            surveyPoints.push(point);
            addMarkerToMap(point);
            updatePointCounter();
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Add marker to map
        function addMarkerToMap(point) {
            const marker = L.marker([point.lat, point.lng], {
                icon: L.divIcon({
                    className: 'numbered-marker',
                    html: point.number.toString(),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);

            marker.bindPopup(`
                <div class="p-2">
                    <h4 class="font-bold">จุดที่ ${point.number}</h4>
                    <p><strong>โครงการ:</strong> ${point.projectName}</p>
                    <p><strong>ผู้สำรวจ:</strong> ${point.surveyorName}</p>
                    <p><strong>ประเภทเสา:</strong> ${point.poleType}</p>
                    <p><strong>พิกัด:</strong> ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</p>
                </div>
            `);
        }

        // Update point counter
        function updatePointCounter() {
            document.getElementById('point-counter').textContent = surveyPoints.length;
            updateTotalDistance();
        }

        // Update total distance
        function updateTotalDistance() {
            if (surveyPoints.length < 2) {
                document.getElementById('total-distance-text').textContent = '0 เมตร';
                return;
            }

            let totalDistance = 0;
            for (let i = 0; i < surveyPoints.length - 1; i++) {
                const point1 = surveyPoints[i];
                const point2 = surveyPoints[i + 1];
                totalDistance += calculateDistance(point1.lat, point1.lng, point2.lat, point2.lng);
            }

            document.getElementById('total-distance-text').textContent = `${totalDistance.toFixed(0)} เมตร`;
        }

        // Clear form
        function clearForm() {
            document.getElementById('pole-type').value = '';
            document.getElementById('equipment').value = '';
            document.getElementById('pole-head').value = '';
            document.getElementById('guy-wire').value = '';
            document.getElementById('photo-input').value = '';
            document.getElementById('notes').value = '';
        }

        // Finish survey
        async function finishSurvey() {
            if (surveyPoints.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณาเพิ่มจุดสำรวจอย่างน้อย 1 จุด',
                    icon: 'warning',
                    position: 'top'
                });
                return;
            }

            if (!isOnline) {
                Swal.fire({
                    title: 'ไม่สามารถบันทึกได้',
                    text: 'ไม่มีการเชื่อมต่ออินเทอร์เน็ต ข้อมูลจะถูกเก็บไว้ในเครื่อง',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Export KML',
                    cancelButtonText: 'ยกเลิก',
                    position: 'top'
                }).then((result) => {
                    if (result.isConfirmed) {
                        exportKML();
                    }
                });
                return;
            }

            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                await saveSurveyData();
                
                Swal.fire({
                    title: 'บันทึกสำเร็จ!',
                    text: `บันทึกข้อมูล ${surveyPoints.length} จุดเรียบร้อยแล้ว`,
                    icon: 'success',
                    position: 'top'
                });

                resetSurvey();
                loadDashboardData();
            } catch (error) {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้ ต้องการ Export เป็น KML หรือไม่?',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonText: 'Export KML',
                    cancelButtonText: 'ยกเลิก',
                    position: 'top'
                }).then((result) => {
                    if (result.isConfirmed) {
                        exportKML();
                    }
                });
            }
        }

        // Save survey data to Google Sheets
        async function saveSurveyData() {
            for (let point of surveyPoints) {
                const formData = new URLSearchParams();
                formData.append('action', 'saveSurveyPoint');
                formData.append('sheetId', SHEET_ID);
                formData.append('folderId', FOLDER_ID);
                formData.append('surveyorName', point.surveyorName);
                formData.append('projectName', point.projectName);
                formData.append('pointNumber', point.number);
                formData.append('lat', point.lat);
                formData.append('lng', point.lng);
                formData.append('poleType', point.poleType);
                formData.append('equipment', point.equipment);
                formData.append('poleHead', point.poleHead);
                formData.append('guyWire', point.guyWire);
                formData.append('notes', point.notes);
                formData.append('timestamp', point.timestamp);
                formData.append('photos', JSON.stringify(point.photos));

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }
            }
        }

        // Reset survey
        function resetSurvey() {
            surveyPoints = [];
            currentPointNumber = 0;
            isAddingPoint = false;
            
            // Remove measure line and label
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
                distanceLabel = null;
            }
            
            // Remove temp marker
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            
            // Hide mobile controls
            document.getElementById('mobile-pin-btn').classList.add('hidden');
            document.getElementById('center-crosshair').classList.add('hidden');
            
            // Clear map markers
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker && layer.options.icon && layer.options.icon.options.className === 'numbered-marker') {
                    map.removeLayer(layer);
                }
            });

            updatePointCounter();
            
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('finish-btn').classList.add('hidden');
            document.getElementById('clear-btn').classList.add('hidden');
            document.getElementById('main-surveyor-select').disabled = false;
            document.getElementById('project-name-input').disabled = false;
            document.getElementById('distance-text').textContent = '-';
            document.getElementById('total-distance-text').textContent = '0 เมตร';
        }

        // Clear survey
        function clearSurvey() {
            Swal.fire({
                title: 'ยืนยันการล้างข้อมูล',
                text: 'ต้องการล้างข้อมูลการสำรวจทั้งหมดหรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ล้างข้อมูล',
                cancelButtonText: 'ยกเลิก',
                position: 'top'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetSurvey();
                    Swal.fire({
                        title: 'ล้างข้อมูลแล้ว!',
                        icon: 'success',
                        position: 'top'
                    });
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            if (!isOnline) {
                document.getElementById('total-projects').textContent = 'ออฟไลน์';
                document.getElementById('total-surveyors').textContent = 'ออฟไลน์';
                document.getElementById('total-points').textContent = 'ออฟไลน์';
                return;
            }

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getDashboardData&sheetId=${SHEET_ID}&t=${Date.now()}`);
                const data = await response.json();
                
                if (data.success) {
                    allProjects = data.projects || [];
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('total-projects').textContent = 'ข้อผิดพลาด';
                document.getElementById('total-surveyors').textContent = 'ข้อผิดพลาด';
                document.getElementById('total-points').textContent = 'ข้อผิดพลาด';
            }
        }

        // Update dashboard
        function updateDashboard() {
            const totalPoints = allProjects.length;
            const uniqueProjects = [...new Set(allProjects.map(p => p.projectName).filter(name => name))];
            const uniqueSurveyors = [...new Set(allProjects.map(p => p.surveyorName).filter(name => name))];
            
            document.getElementById('total-projects').textContent = uniqueProjects.length;
            document.getElementById('total-surveyors').textContent = uniqueSurveyors.length;
            document.getElementById('total-points').textContent = totalPoints;

            // Group by surveyor
            const surveyorStats = {};
            allProjects.forEach(project => {
                const surveyor = project.surveyorName || 'ไม่ระบุ';
                if (!surveyorStats[surveyor]) {
                    surveyorStats[surveyor] = 0;
                }
                surveyorStats[surveyor]++;
            });

            // Update surveyor cards
            const surveyorCardsContainer = document.getElementById('surveyor-cards');
            surveyorCardsContainer.innerHTML = '';

            Object.keys(surveyorStats).forEach(surveyor => {
                const count = surveyorStats[surveyor];
                const percentage = totalPoints > 0 ? ((count / totalPoints) * 100).toFixed(1) : 0;
                
                const card = document.createElement('div');
                card.className = 'surveyor-card card-gradient p-4 rounded-lg shadow-md';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">${surveyor}</p>
                            <p class="text-xl font-bold text-green-600">${count} จุด</p>
                            <p class="text-xs text-gray-500">${percentage}%</p>
                        </div>
                        <i class="fas fa-user text-2xl text-green-400"></i>
                    </div>
                `;
                surveyorCardsContainer.appendChild(card);
            });

            // Update filter dropdowns
            updateFilterDropdowns();
            
            // Initialize filtered projects
            filteredProjects = [...allProjects];
            
            // Update project status list
            updateProjectStatusList();
        }

        // Update filter dropdowns
        function updateFilterDropdowns() {
            const surveyorFilter = document.getElementById('surveyor-filter');
            const uniqueSurveyors = [...new Set(allProjects.map(p => p.surveyorName).filter(name => name))];
            
            surveyorFilter.innerHTML = '<option value="">ทั้งหมด</option>';
            uniqueSurveyors.forEach(surveyor => {
                const option = document.createElement('option');
                option.value = surveyor;
                option.textContent = surveyor;
                surveyorFilter.appendChild(option);
            });
        }

        // Apply filters
        function applyFilters() {
            const surveyorFilter = document.getElementById('surveyor-filter').value;
            const projectSearch = document.getElementById('project-search').value.toLowerCase();
            
            filteredProjects = allProjects.filter(project => {
                const matchSurveyor = !surveyorFilter || project.surveyorName === surveyorFilter;
                const matchProject = !projectSearch || (project.projectName && project.projectName.toLowerCase().includes(projectSearch));
                return matchSurveyor && matchProject;
            });
            
            updateProjectStatusList();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('surveyor-filter').value = '';
            document.getElementById('project-search').value = '';
            filteredProjects = [...allProjects];
            updateProjectStatusList();
        }

        // Export project KML
        function exportProjectKML(projectName) {
            const projectPoints = allProjects.filter(project => project.projectName === projectName);
            
            if (projectPoints.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลสำหรับโครงการนี้',
                    icon: 'warning',
                    position: 'top'
                });
                return;
            }

            const kml = generateKML(projectPoints, `โครงการ: ${projectName}`);
            const filename = `${projectName.replace(/[^a-zA-Z0-9ก-๙]/g, '_')}.kml`;
            downloadKML(kml, filename);
        }

        // Calculate total distance for a project
        function calculateProjectDistance(projectPoints) {
            if (projectPoints.length < 2) return 0;
            
            // Sort points by point number to ensure correct order
            const sortedPoints = projectPoints.sort((a, b) => {
                const aNum = parseInt(a.pointNumber) || 0;
                const bNum = parseInt(b.pointNumber) || 0;
                return aNum - bNum;
            });
            
            let totalDistance = 0;
            for (let i = 0; i < sortedPoints.length - 1; i++) {
                const point1 = sortedPoints[i];
                const point2 = sortedPoints[i + 1];
                totalDistance += calculateDistance(point1.lat, point1.lng, point2.lat, point2.lng);
            }
            
            return totalDistance;
        }

        // Update project status list as table
        function updateProjectStatusList() {
            const tableBody = document.getElementById('project-table-body');
            const mobileCards = document.getElementById('project-mobile-cards');
            
            tableBody.innerHTML = '';
            mobileCards.innerHTML = '';

            if (filteredProjects.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">ไม่มีข้อมูลโครงการ</td></tr>';
                mobileCards.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่มีข้อมูลโครงการ</p>';
                return;
            }

            // Group by project and timestamp to allow duplicate project names
            const projectGroups = {};
            filteredProjects.forEach(project => {
                const surveyorName = project.surveyorName || 'ไม่ระบุผู้สำรวจ';
                const projectName = project.projectName || 'ไม่ระบุโครงการ';
                const timestamp = project.timestamp || new Date().toISOString();
                const key = `${surveyorName}|${projectName}|${timestamp.split('T')[0]}`;
                
                if (!projectGroups[key]) {
                    projectGroups[key] = {
                        surveyorName,
                        projectName,
                        timestamp,
                        points: []
                    };
                }
                
                projectGroups[key].points.push(project);
            });

            let rowIndex = 1;
            Object.keys(projectGroups).forEach(key => {
                const group = projectGroups[key];
                const totalDistance = calculateProjectDistance(group.points);
                const firstProject = group.points[0];
                const status = firstProject.status || 'ยังไม่เขียนผัง';
                
                // Desktop table row
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 border-b border-gray-200';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${rowIndex}</td>
                    <td class="px-4 py-3 text-sm">${group.surveyorName}</td>
                    <td class="px-4 py-3 text-sm">${group.projectName}</td>
                    <td class="px-4 py-3 text-sm text-right">${totalDistance.toFixed(0)}</td>
                    <td class="px-2 py-3 text-sm">
                        <div class="flex flex-col space-y-2">
                            <select onchange="updateProjectGroupStatus('${group.projectName}', this.value)" class="w-full px-2 py-1 border rounded text-xs">
                                <option value="ยังไม่เขียนผัง" ${status === 'ยังไม่เขียนผัง' ? 'selected' : ''}>ยังไม่เขียนผัง</option>
                                <option value="เขียนผังแล้ว" ${status === 'เขียนผังแล้ว' ? 'selected' : ''}>เขียนผังแล้ว</option>
                            </select>
                            <button onclick="exportProjectKML('${group.projectName}')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                                <i class="fas fa-download mr-1"></i>Export KML
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
                
                // Mobile card
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">#${rowIndex}</span>
                                <span class="text-sm font-medium text-gray-600">${group.surveyorName}</span>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-1">${group.projectName}</h4>
                            <p class="text-sm text-gray-600">ระยะทาง: ${totalDistance.toFixed(0)} เมตร</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">สถานะ:</label>
                            <select onchange="updateProjectGroupStatus('${group.projectName}', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="ยังไม่เขียนผัง" ${status === 'ยังไม่เขียนผัง' ? 'selected' : ''}>ยังไม่เขียนผัง</option>
                                <option value="เขียนผังแล้ว" ${status === 'เขียนผังแล้ว' ? 'selected' : ''}>เขียนผังแล้ว</option>
                            </select>
                        </div>
                        <button onclick="exportProjectKML('${group.projectName}')" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-download mr-2"></i>Export KML
                        </button>
                    </div>
                `;
                mobileCards.appendChild(card);
                
                rowIndex++;
            });
        }

        // Update project group status
        async function updateProjectGroupStatus(projectName, status) {
            if (!isOnline) {
                Swal.fire({
                    title: 'ไม่สามารถอัปเดตได้',
                    text: 'ไม่มีการเชื่อมต่ออินเทอร์เน็ต',
                    icon: 'warning',
                    position: 'top'
                });
                return;
            }

            try {
                const formData = new URLSearchParams();
                formData.append('action', 'updateProjectStatus');
                formData.append('sheetId', SHEET_ID);
                formData.append('projectName', projectName);
                formData.append('status', status);

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    // Update local data
                    allProjects.forEach(project => {
                        if (project.projectName === projectName) {
                            project.status = status;
                        }
                    });
                    
                    Swal.fire({
                        title: 'อัปเดตสำเร็จ',
                        text: `อัปเดตสถานะโครงการ "${projectName}" เรียบร้อยแล้ว`,
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false,
                        position: 'top'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถอัปเดตสถานะได้',
                    icon: 'error',
                    position: 'top'
                });
            }
        }

        // Export all KML
        function exportAllKML() {
            if (allProjects.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลสำหรับ Export',
                    icon: 'warning',
                    position: 'top'
                });
                return;
            }

            const kml = generateKML(allProjects, 'ข้อมูลสำรวจเสาไฟฟ้าทั้งหมด');
            downloadKML(kml, 'survey_all_points.kml');
        }

        // Export KML
        function exportKML() {
            if (surveyPoints.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลการสำรวจปัจจุบันสำหรับ Export',
                    icon: 'warning',
                    position: 'top'
                });
                return;
            }

            const kml = generateKML(surveyPoints, 'ข้อมูลสำรวจปัจจุบัน');
            downloadKML(kml, 'current_survey.kml');
        }

        // Generate KML content
        function generateKML(points, name) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${name}</name>
    <description>ข้อมูลสำรวจเสาไฟฟ้า PEA</description>
`;

            points.forEach(point => {
                kml += `
    <Placemark>
      <name>จุดที่ ${point.number || point.pointNumber}</name>
      <description><![CDATA[
        <b>โครงการ:</b> ${point.projectName || '-'}<br/>
        <b>ผู้สำรวจ:</b> ${point.surveyorName}<br/>
        <b>ประเภทเสา:</b> ${point.poleType}<br/>
        <b>อุปกรณ์:</b> ${point.equipment || '-'}<br/>
        <b>หัวเสา:</b> ${point.poleHead || '-'}<br/>
        <b>สายยึดโยง:</b> ${point.guyWire || '-'}<br/>
        <b>หมายเหตุ:</b> ${point.notes || '-'}
      ]]></description>
      <Point>
        <coordinates>${point.lng},${point.lat},0</coordinates>
      </Point>
    </Placemark>`;
            });

            kml += `
  </Document>
</kml>`;

            return kml;
        }

        // Download KML file
        function downloadKML(kmlContent, filename) {
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Swal.fire({
                title: 'ดาวน์โหลดสำเร็จ',
                text: `ไฟล์ ${filename} ถูกดาวน์โหลดแล้ว`,
                icon: 'success',
                position: 'top'
            });
        }
    </script>

    <!-- Developer Credit -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm">
                พัฒนาโดย: <span class="font-semibold">นายศุภกฤษ ทะวัง</span> 
                ตำแหน่ง <span class="font-semibold">ชผ.บส.กฟจ.นพ.</span>
            </p>
        </div>
    </footer>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98acff6be559fd9e',t:'MTc1OTgzNTkwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
