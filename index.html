<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey PEA NPN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            box-sizing: border-box;
        }
        .map-container {
            height: calc(100vh - 120px);
            position: relative;
        }
        .distance-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .modal {
            z-index: 2000;
        }
        .modal-backdrop {
            z-index: 1999;
        }
        .numbered-marker {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .nav-tab {
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        .card-gradient {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .connection-status {
            position: fixed;
            top: 70px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online {
            background: #10b981;
            color: white;
        }
        .status-offline {
            background: #ef4444;
            color: white;
        }
        .surveyor-card {
            min-width: 200px;
            max-width: 250px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Connection Status -->
    <div id="connection-status" class="connection-status status-offline hidden">
        <i class="fas fa-wifi mr-1"></i>
        <span id="status-text">กำลังเชื่อมต่อ...</span>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="px-4 py-3">
            <div class="flex justify-between items-center">
                <h1 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-bolt text-blue-600 mr-2"></i>
                    Survey PEA NPN
                </h1>
                <div class="flex space-x-2">
                    <button onclick="showTab('dashboard')" class="nav-tab px-3 py-2 rounded-lg text-sm font-medium" id="tab-dashboard">
                        <i class="fas fa-chart-pie mr-1"></i>แดชบอร์ด
                    </button>
                    <button onclick="showTab('survey')" class="nav-tab px-3 py-2 rounded-lg text-sm font-medium active" id="tab-survey">
                        <i class="fas fa-map-marker-alt mr-1"></i>สำรวจ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="hidden p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <div class="card-gradient p-4 rounded-lg shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">โครงการทั้งหมด</p>
                        <p class="text-2xl font-bold text-blue-600" id="total-projects">0</p>
                    </div>
                    <i class="fas fa-project-diagram text-3xl text-blue-400"></i>
                </div>
            </div>
        </div>

        <!-- Surveyor Cards -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">สถิติตามผู้สำรวจ</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="surveyor-cards">
                <!-- Surveyor cards will be populated here -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="text-lg font-semibold mb-4">จัดการข้อมูล</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="exportAllKML()" class="btn-primary text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-download mr-2"></i>Export ไฟล์ KML ทั้งหมด
                </button>
                <button onclick="exportKML()" class="btn-success text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-file-export mr-2"></i>Export KML ปัจจุบัน
                </button>
                <div class="relative">
                    <select id="project-export-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกโครงการ</option>
                    </select>
                    <button onclick="exportProjectKML()" class="btn-warning text-white px-4 py-2 rounded-lg font-medium mt-2 w-full">
                        <i class="fas fa-file-download mr-2"></i>Export KML ตามโครงการ
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold mb-4">สถานะโครงการ</h3>
            <div class="space-y-3" id="project-status-list">
                <!-- Project status items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Survey Tab -->
    <div id="survey-tab" class="relative">
        <!-- Control Panel -->
        <div class="bg-white shadow-md p-4">
            <div class="flex flex-wrap gap-4 justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">จุดสำรวจ:</span>
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-bold" id="point-counter">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">ผู้สำรวจ:</label>
                        <select id="main-surveyor-select" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 min-w-[150px]">
                            <option value="">เลือกผู้สำรวจ</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">โครงการ:</label>
                        <input type="text" id="project-name-input" placeholder="ชื่อโครงการ" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 min-w-[150px]">
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="startSurvey()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium" id="start-btn">
                        <i class="fas fa-play mr-1"></i>เริ่มสำรวจ
                    </button>
                    <button onclick="finishSurvey()" class="btn-success text-white px-4 py-2 rounded-lg text-sm font-medium hidden" id="finish-btn">
                        <i class="fas fa-save mr-1"></i>เสร็จสิ้น
                    </button>
                    <button onclick="clearSurvey()" class="btn-danger text-white px-4 py-2 rounded-lg text-sm font-medium hidden" id="clear-btn">
                        <i class="fas fa-trash mr-1"></i>ล้างข้อมูล
                    </button>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map" class="w-full h-full"></div>
            <div class="distance-info" id="distance-info">
                <div class="text-xs text-gray-600">ระยะทางจากจุดล่าสุด</div>
                <div class="font-bold text-blue-600" id="distance-text">-</div>
            </div>
        </div>
    </div>

    <!-- Survey Point Modal -->
    <div id="survey-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold">ข้อมูลจุดสำรวจ #<span id="modal-point-number">1</span></h3>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทเสา</label>
                    <select id="pole-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกประเภทเสา</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">การติดตั้งอุปกรณ์</label>
                    <select id="equipment" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกอุปกรณ์</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หัวเสา</label>
                    <select id="pole-head" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกหัวเสา</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">สายยึดโยง&เทโคน</label>
                    <select id="guy-wire" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">เลือกสายยึดโยง&เทโคน</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">รูปภาพ</label>
                    <input type="file" id="photo-input" accept="image/*" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุ</label>
                    <textarea id="notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="หมายเหตุเพิ่มเติม"></textarea>
                </div>
            </div>
            
            <div class="p-4 border-t flex flex-col space-y-2">
                <button onclick="savePoint()" class="btn-primary text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-plus mr-2"></i>เพิ่มจุดสำรวจ
                </button>
                <button onclick="saveAndFinish()" class="btn-success text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-check mr-2"></i>เสร็จสิ้นการสำรวจ
                </button>
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-3 rounded-lg font-medium">
                    <i class="fas fa-times mr-2"></i>ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let surveyPoints = [];
        let currentPointNumber = 0;
        let isAddingPoint = false;
        let currentLat, currentLng;
        let currentMarker = null;
        let options = {};
        let allProjects = [];
        let isOnline = false;
        let measureLine = null;
        let distanceLabel = null;

        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZB9R8J8lToURW_BwXhfLIRAAbK0jI90tOrwhxLuoWqEk4lKzDqxKjtMxkwU2NeHObwQ/exec';
        const SHEET_ID = '1kf_xzfTOx98T5f_9grznU3U0U1MqA87lt_Dl2hGSyAw';
        const FOLDER_ID = '1AmI2prj8Bma9gVBb0oLq7uwkr2D1aERZ';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadOptions();
            loadDashboardData();
            showTab('survey');
            checkConnection();
        });

        // Check connection status
        async function checkConnection() {
            const statusElement = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            statusElement.classList.remove('hidden');
            statusText.textContent = 'กำลังตรวจสอบ...';
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=ping&t=${Date.now()}`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    isOnline = true;
                    statusElement.className = 'connection-status status-online';
                    statusText.textContent = 'เชื่อมต่อแล้ว';
                    
                    // Load options from Google Sheets
                    await loadOptionsFromSheets();
                    
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 2000);
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                isOnline = false;
                statusElement.className = 'connection-status status-offline';
                statusText.textContent = 'ออฟไลน์';
                
                // Use default options when offline
                useDefaultOptions();
                
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 3000);
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('survey-tab').classList.add('hidden');
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'survey') {
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add click event for adding points
            map.on('click', function(e) {
                if (isAddingPoint) {
                    currentLat = e.latlng.lat;
                    currentLng = e.latlng.lng;
                    showSurveyModal();
                }
            });

            // Add mousemove event for distance calculation and line drawing
            map.on('mousemove', function(e) {
                if (isAddingPoint && surveyPoints.length > 0) {
                    updateDistanceInfo(e.latlng);
                    updateMeasureLine(e.latlng);
                }
            });

            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location',
                            html: '<i class="fas fa-crosshairs text-red-500 text-xl"></i>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map).bindPopup('ตำแหน่งปัจจุบัน');
                });
            }
        }

        // Load options from Google Sheets
        async function loadOptionsFromSheets() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getOptions&sheetId=${SHEET_ID}&t=${Date.now()}`);
                const data = await response.json();
                
                if (data.success) {
                    options = data.options;
                    populateDropdowns();
                    populateSurveyorSelect();
                } else {
                    throw new Error('Failed to load options');
                }
            } catch (error) {
                console.error('Error loading options from sheets:', error);
                useDefaultOptions();
            }
        }

        // Load options (fallback to default if needed)
        function loadOptions() {
            if (isOnline) {
                loadOptionsFromSheets();
            } else {
                useDefaultOptions();
            }
        }

        // Use default options
        function useDefaultOptions() {
            options = {
                surveyors: [
                    'ศุภกฤษ ทะวัง', 
                    'อาทิตย์ สมบัติ', 
                    'สนธยา คำจันทร์'
                ],
                poleTypes: [
                    '8m', 
                    '9m', 
                    '12m', 
                    '12.20m', 
                    '14m',
                    '14.30m',
                    '22m'
                ],
                equipment: [
                    'หม้อแปลง', 
                    'สวิตช์', 
                    'คาปาซิเตอร์', 
                    'ไม่มีอุปกรณ์',
                    'เครื่องตัดไฟอัตโนมัติ', 
                    'เซอร์กิตเบรกเกอร์',
                    'ฟิวส์',
                    'อุปกรณ์วัดไฟฟ้า'
                ],
                poleHeads: [
                    'ทางตรง', 
                    'ทางโค้ง', 
                    'DDE', 
                    'DE'
                ],
                guyWires: [
                    'มีสายยึดโยง', 
                    'ไม่มีสายยึดโยง', 
                    'เทโคน', 
                    'ทั้งสอง'
                ]
            };
            populateDropdowns();
            populateSurveyorSelect();
        }

        // Populate dropdown menus
        function populateDropdowns() {
            const dropdowns = {
                'pole-type': options.poleTypes || [],
                'equipment': options.equipment || [],
                'pole-head': options.poleHeads || [],
                'guy-wire': options.guyWires || []
            };

            Object.keys(dropdowns).forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">เลือก...</option>';
                    
                    const optionsList = dropdowns[id];
                    optionsList.forEach(option => {
                        if (option && option.trim()) {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.trim();
                            optionElement.textContent = option.trim();
                            select.appendChild(optionElement);
                        }
                    });
                }
            });
        }

        // Populate main surveyor select
        function populateSurveyorSelect() {
            const select = document.getElementById('main-surveyor-select');
            if (select && options.surveyors) {
                select.innerHTML = '<option value="">เลือกผู้สำรวจ</option>';
                
                options.surveyors.forEach(surveyor => {
                    if (surveyor && surveyor.trim()) {
                        const option = document.createElement('option');
                        option.value = surveyor.trim();
                        option.textContent = surveyor.trim();
                        select.appendChild(option);
                    }
                });
            }
        }

        // Start survey
        function startSurvey() {
            const selectedSurveyor = document.getElementById('main-surveyor-select').value;
            const projectName = document.getElementById('project-name-input').value.trim();
            
            if (!selectedSurveyor) {
                Swal.fire({
                    title: 'กรุณาเลือกผู้สำรวจ',
                    text: 'กรุณาเลือกชื่อผู้สำรวจก่อนเริ่มการสำรวจ',
                    icon: 'warning'
                });
                return;
            }

            if (!projectName) {
                Swal.fire({
                    title: 'กรุณาใส่ชื่อโครงการ',
                    text: 'กรุณาใส่ชื่อโครงการก่อนเริ่มการสำรวจ',
                    icon: 'warning'
                });
                return;
            }
            
            isAddingPoint = true;
            document.getElementById('start-btn').classList.add('hidden');
            document.getElementById('finish-btn').classList.remove('hidden');
            document.getElementById('clear-btn').classList.remove('hidden');
            document.getElementById('main-surveyor-select').disabled = true;
            document.getElementById('project-name-input').disabled = true;
            
            Swal.fire({
                title: 'เริ่มการสำรวจ',
                text: `โครงการ: ${projectName}\nผู้สำรวจ: ${selectedSurveyor}\nคลิกบนแผนที่เพื่อปักหมุดจุดสำรวจ`,
                icon: 'info',
                timer: 3000,
                showConfirmButton: false
            });
        }

        // Update distance info
        function updateDistanceInfo(latlng) {
            if (surveyPoints.length === 0) return;
            
            const lastPoint = surveyPoints[surveyPoints.length - 1];
            const distance = calculateDistance(lastPoint.lat, lastPoint.lng, latlng.lat, latlng.lng);
            
            document.getElementById('distance-text').textContent = `${distance.toFixed(0)} เมตร`;
        }

        // Update measure line with distance label
        function updateMeasureLine(latlng) {
            if (surveyPoints.length === 0) return;
            
            // Remove existing measure line and label
            if (measureLine) {
                map.removeLayer(measureLine);
            }
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
            }
            
            const lastPoint = surveyPoints[surveyPoints.length - 1];
            const distance = calculateDistance(lastPoint.lat, lastPoint.lng, latlng.lat, latlng.lng);
            
            // Create new measure line
            measureLine = L.polyline([
                [lastPoint.lat, lastPoint.lng],
                [latlng.lat, latlng.lng]
            ], {
                color: '#ff6b6b',
                weight: 2,
                opacity: 0.8,
                dashArray: '5, 10'
            }).addTo(map);
            
            // Add distance label at midpoint
            const midLat = (lastPoint.lat + latlng.lat) / 2;
            const midLng = (lastPoint.lng + latlng.lng) / 2;
            
            distanceLabel = L.marker([midLat, midLng], {
                icon: L.divIcon({
                    className: 'distance-label',
                    html: `<div style="background: rgba(255,107,107,0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">${distance.toFixed(0)}m</div>`,
                    iconSize: [0, 0],
                    iconAnchor: [0, 0]
                })
            }).addTo(map);
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Show survey modal
        function showSurveyModal() {
            // Remove measure line when showing modal
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
                distanceLabel = null;
            }
            
            // Set correct point number (next available number)
            const nextPointNumber = surveyPoints.length + 1;
            document.getElementById('modal-point-number').textContent = nextPointNumber;
            document.getElementById('survey-modal').classList.remove('hidden');
            document.getElementById('survey-modal').classList.add('flex');
        }

        // Close modal
        function closeModal() {
            document.getElementById('survey-modal').classList.add('hidden');
            document.getElementById('survey-modal').classList.remove('flex');
        }

        // Save point and continue
        function savePoint() {
            if (validateForm()) {
                addPointToSurvey();
                closeModal();
                clearForm();
            }
        }

        // Save point and finish
        function saveAndFinish() {
            if (validateForm()) {
                addPointToSurvey();
                closeModal();
                finishSurvey();
            }
        }

        // Validate form
        function validateForm() {
            const required = ['pole-type'];
            for (let id of required) {
                if (!document.getElementById(id).value) {
                    Swal.fire({
                        title: 'ข้อมูลไม่ครบถ้วน',
                        text: 'กรุณาเลือกประเภทเสา',
                        icon: 'warning'
                    });
                    return false;
                }
            }
            return true;
        }

        // Add point to survey
        async function addPointToSurvey() {
            const photoFiles = document.getElementById('photo-input').files;
            let photoUrls = [];

            // Handle photo upload
            if (photoFiles.length > 0) {
                for (let file of photoFiles) {
                    const base64 = await fileToBase64(file);
                    photoUrls.push({
                        name: file.name,
                        data: base64,
                        type: file.type
                    });
                }
            }

            const selectedSurveyor = document.getElementById('main-surveyor-select').value;
            const projectName = document.getElementById('project-name-input').value.trim();
            const pointNumber = surveyPoints.length + 1;

            const point = {
                number: pointNumber,
                lat: currentLat,
                lng: currentLng,
                surveyorName: selectedSurveyor,
                projectName: projectName,
                poleType: document.getElementById('pole-type').value,
                equipment: document.getElementById('equipment').value,
                poleHead: document.getElementById('pole-head').value,
                guyWire: document.getElementById('guy-wire').value,
                photos: photoUrls,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            surveyPoints.push(point);
            addMarkerToMap(point);
            updatePointCounter();
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Add marker to map
        function addMarkerToMap(point) {
            const marker = L.marker([point.lat, point.lng], {
                icon: L.divIcon({
                    className: 'numbered-marker',
                    html: point.number.toString(),
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);

            marker.bindPopup(`
                <div class="p-2">
                    <h4 class="font-bold">จุดที่ ${point.number}</h4>
                    <p><strong>โครงการ:</strong> ${point.projectName}</p>
                    <p><strong>ผู้สำรวจ:</strong> ${point.surveyorName}</p>
                    <p><strong>ประเภทเสา:</strong> ${point.poleType}</p>
                    <p><strong>พิกัด:</strong> ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</p>
                </div>
            `);
        }

        // Update point counter
        function updatePointCounter() {
            document.getElementById('point-counter').textContent = surveyPoints.length;
        }

        // Clear form
        function clearForm() {
            document.getElementById('pole-type').value = '';
            document.getElementById('equipment').value = '';
            document.getElementById('pole-head').value = '';
            document.getElementById('guy-wire').value = '';
            document.getElementById('photo-input').value = '';
            document.getElementById('notes').value = '';
        }

        // Finish survey
        async function finishSurvey() {
            if (surveyPoints.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณาเพิ่มจุดสำรวจอย่างน้อย 1 จุด',
                    icon: 'warning'
                });
                return;
            }

            if (!isOnline) {
                Swal.fire({
                    title: 'ไม่สามารถบันทึกได้',
                    text: 'ไม่มีการเชื่อมต่ออินเทอร์เน็ต ข้อมูลจะถูกเก็บไว้ในเครื่อง',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Export KML',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        exportKML();
                    }
                });
                return;
            }

            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                await saveSurveyData();
                
                Swal.fire({
                    title: 'บันทึกสำเร็จ!',
                    text: `บันทึกข้อมูล ${surveyPoints.length} จุดเรียบร้อยแล้ว`,
                    icon: 'success'
                });

                resetSurvey();
                loadDashboardData();
            } catch (error) {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้ ต้องการ Export เป็น KML หรือไม่?',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonText: 'Export KML',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        exportKML();
                    }
                });
            }
        }

        // Save survey data to Google Sheets
        async function saveSurveyData() {
            for (let point of surveyPoints) {
                const formData = new URLSearchParams();
                formData.append('action', 'saveSurveyPoint');
                formData.append('sheetId', SHEET_ID);
                formData.append('folderId', FOLDER_ID);
                formData.append('surveyorName', point.surveyorName);
                formData.append('projectName', point.projectName);
                formData.append('pointNumber', point.number);
                formData.append('lat', point.lat);
                formData.append('lng', point.lng);
                formData.append('poleType', point.poleType);
                formData.append('equipment', point.equipment);
                formData.append('poleHead', point.poleHead);
                formData.append('guyWire', point.guyWire);
                formData.append('notes', point.notes);
                formData.append('timestamp', point.timestamp);
                formData.append('photos', JSON.stringify(point.photos));

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }
            }
        }

        // Reset survey
        function resetSurvey() {
            surveyPoints = [];
            currentPointNumber = 0;
            isAddingPoint = false;
            
            // Remove measure line and label
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            if (distanceLabel) {
                map.removeLayer(distanceLabel);
                distanceLabel = null;
            }
            
            // Clear map markers
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker && layer.options.icon && layer.options.icon.options.className === 'numbered-marker') {
                    map.removeLayer(layer);
                }
            });

            updatePointCounter();
            
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('finish-btn').classList.add('hidden');
            document.getElementById('clear-btn').classList.add('hidden');
            document.getElementById('main-surveyor-select').disabled = false;
            document.getElementById('project-name-input').disabled = false;
            document.getElementById('distance-text').textContent = '-';
        }

        // Clear survey
        function clearSurvey() {
            Swal.fire({
                title: 'ยืนยันการล้างข้อมูล',
                text: 'ต้องการล้างข้อมูลการสำรวจทั้งหมดหรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ล้างข้อมูล',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    resetSurvey();
                    Swal.fire('ล้างข้อมูลแล้ว!', '', 'success');
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            if (!isOnline) {
                document.getElementById('total-projects').textContent = 'ออฟไลน์';
                return;
            }

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getDashboardData&sheetId=${SHEET_ID}&t=${Date.now()}`);
                const data = await response.json();
                
                if (data.success) {
                    allProjects = data.projects || [];
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('total-projects').textContent = 'ข้อผิดพลาด';
            }
        }

        // Update dashboard
        function updateDashboard() {
            const totalProjects = allProjects.length;
            document.getElementById('total-projects').textContent = totalProjects;

            // Group by surveyor
            const surveyorStats = {};
            allProjects.forEach(project => {
                const surveyor = project.surveyorName || 'ไม่ระบุ';
                if (!surveyorStats[surveyor]) {
                    surveyorStats[surveyor] = 0;
                }
                surveyorStats[surveyor]++;
            });

            // Update surveyor cards
            const surveyorCardsContainer = document.getElementById('surveyor-cards');
            surveyorCardsContainer.innerHTML = '';

            Object.keys(surveyorStats).forEach(surveyor => {
                const count = surveyorStats[surveyor];
                const percentage = totalProjects > 0 ? ((count / totalProjects) * 100).toFixed(1) : 0;
                
                const card = document.createElement('div');
                card.className = 'surveyor-card card-gradient p-4 rounded-lg shadow-md';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">${surveyor}</p>
                            <p class="text-xl font-bold text-green-600">${count} จุด</p>
                            <p class="text-xs text-gray-500">${percentage}%</p>
                        </div>
                        <i class="fas fa-user text-2xl text-green-400"></i>
                    </div>
                `;
                surveyorCardsContainer.appendChild(card);
            });

            // Update project status list and export dropdown
            updateProjectStatusList();
            updateProjectExportDropdown();
        }

        // Update project export dropdown
        function updateProjectExportDropdown() {
            const select = document.getElementById('project-export-select');
            select.innerHTML = '<option value="">เลือกโครงการ</option>';

            // Get unique project names
            const projectNames = [...new Set(allProjects.map(p => p.projectName).filter(name => name))];
            
            projectNames.forEach(projectName => {
                const option = document.createElement('option');
                option.value = projectName;
                option.textContent = projectName;
                select.appendChild(option);
            });
        }

        // Update project status list (grouped by project)
        function updateProjectStatusList() {
            const statusList = document.getElementById('project-status-list');
            statusList.innerHTML = '';

            if (allProjects.length === 0) {
                statusList.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่มีข้อมูลโครงการ</p>';
                return;
            }

            // Group by project name
            const projectGroups = {};
            allProjects.forEach(project => {
                const projectName = project.projectName || 'ไม่ระบุโครงการ';
                if (!projectGroups[projectName]) {
                    projectGroups[projectName] = [];
                }
                projectGroups[projectName].push(project);
            });

            Object.keys(projectGroups).forEach(projectName => {
                const projects = projectGroups[projectName];
                const firstProject = projects[0];
                const pointCount = projects.length;
                
                const statusItem = document.createElement('div');
                statusItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                statusItem.innerHTML = `
                    <div>
                        <p class="font-medium">${projectName}</p>
                        <p class="text-sm text-gray-600">${pointCount} จุดสำรวจ</p>
                    </div>
                    <select onchange="updateProjectGroupStatus('${projectName}', this.value)" class="px-3 py-1 border rounded-lg text-sm">
                        <option value="ยังไม่เขียนผัง" ${firstProject.status === 'ยังไม่เขียนผัง' ? 'selected' : ''}>ยังไม่เขียนผัง</option>
                        <option value="เขียนผังแล้ว" ${firstProject.status === 'เขียนผังแล้ว' ? 'selected' : ''}>เขียนผังแล้ว</option>
                    </select>
                `;
                statusList.appendChild(statusItem);
            });
        }

        // Update project group status
        async function updateProjectGroupStatus(projectName, status) {
            if (!isOnline) {
                Swal.fire({
                    title: 'ไม่สามารถอัปเดตได้',
                    text: 'ไม่มีการเชื่อมต่ออินเทอร์เน็ต',
                    icon: 'warning'
                });
                return;
            }

            try {
                const formData = new URLSearchParams();
                formData.append('action', 'updateProjectStatus');
                formData.append('sheetId', SHEET_ID);
                formData.append('projectName', projectName);
                formData.append('status', status);

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    // Update local data
                    allProjects.forEach(project => {
                        if (project.projectName === projectName) {
                            project.status = status;
                        }
                    });
                    
                    Swal.fire({
                        title: 'อัปเดตสำเร็จ',
                        text: `อัปเดตสถานะโครงการ "${projectName}" เรียบร้อยแล้ว`,
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถอัปเดตสถานะได้',
                    icon: 'error'
                });
            }
        }

        // Export all KML
        function exportAllKML() {
            if (allProjects.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลสำหรับ Export',
                    icon: 'warning'
                });
                return;
            }

            const kml = generateKML(allProjects, 'ข้อมูลสำรวจเสาไฟฟ้าทั้งหมด');
            downloadKML(kml, 'survey_all_points.kml');
        }

        // Export project KML
        function exportProjectKML() {
            const selectedProject = document.getElementById('project-export-select').value;
            
            if (!selectedProject) {
                Swal.fire({
                    title: 'กรุณาเลือกโครงการ',
                    text: 'กรุณาเลือกโครงการที่ต้องการ Export',
                    icon: 'warning'
                });
                return;
            }

            const projectData = allProjects.filter(p => p.projectName === selectedProject);
            
            if (projectData.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลในโครงการที่เลือก',
                    icon: 'warning'
                });
                return;
            }

            const kml = generateKML(projectData, `โครงการ: ${selectedProject}`);
            downloadKML(kml, `${selectedProject.replace(/[^a-zA-Z0-9ก-๙]/g, '_')}.kml`);
        }

        // Export KML
        function exportKML() {
            if (surveyPoints.length === 0) {
                Swal.fire({
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลการสำรวจปัจจุบันสำหรับ Export',
                    icon: 'warning'
                });
                return;
            }

            const kml = generateKML(surveyPoints, 'ข้อมูลสำรวจปัจจุบัน');
            downloadKML(kml, 'current_survey.kml');
        }

        // Generate KML content
        function generateKML(points, name) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${name}</name>
    <description>ข้อมูลสำรวจเสาไฟฟ้า PEA</description>
`;

            points.forEach(point => {
                kml += `
    <Placemark>
      <name>จุดที่ ${point.number || point.pointNumber}</name>
      <description><![CDATA[
        <b>โครงการ:</b> ${point.projectName || '-'}<br/>
        <b>ผู้สำรวจ:</b> ${point.surveyorName}<br/>
        <b>ประเภทเสา:</b> ${point.poleType}<br/>
        <b>อุปกรณ์:</b> ${point.equipment || '-'}<br/>
        <b>หัวเสา:</b> ${point.poleHead || '-'}<br/>
        <b>สายยึดโยง:</b> ${point.guyWire || '-'}<br/>
        <b>หมายเหตุ:</b> ${point.notes || '-'}
      ]]></description>
      <Point>
        <coordinates>${point.lng},${point.lat},0</coordinates>
      </Point>
    </Placemark>`;
            });

            kml += `
  </Document>
</kml>`;

            return kml;
        }

        // Download KML file
        function downloadKML(kmlContent, filename) {
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Swal.fire({
                title: 'ดาวน์โหลดสำเร็จ',
                text: `ไฟล์ ${filename} ถูกดาวน์โหลดแล้ว`,
                icon: 'success'
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'989e2ffbf674a1c2',t:'MTc1OTY4MDYwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
