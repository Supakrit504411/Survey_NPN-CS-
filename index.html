<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ - PEA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
        }
        @media (max-width: 640px) {
            .map-container {
                height: 250px;
            }
        }
        .survey-card {
            background: linear-gradient(135deg, #0ea5e9 0%, #10b981 100%);
        }
        .pole-icon {
            font-size: 2rem;
        }
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <!-- Header -->
    <div class="survey-card text-white p-4 shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h1>
                <p class="text-blue-100 text-sm">‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ (PEA)</p>
            </div>
            <div class="text-right">
                <div class="pole-icon">üóº</div>
                <div class="text-xs">GIS Survey</div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-md">
        <!-- Survey Info Card -->
        <div class="form-section rounded-xl p-4 mb-4 shadow-lg border border-white/20">
            <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à
            </h2>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
                    <input type="text" id="responsible" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="text" id="projectName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à" required>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="form-section rounded-xl p-4 mb-4 shadow-lg border border-white/20">
            <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à
            </h2>
            
            <div id="map" class="map-container mb-3"></div>
            
            <div class="flex justify-between items-center text-sm text-gray-600 mb-3">
                <span>üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î: <span id="markerCount" class="font-semibold text-blue-600">0</span></span>
                <button id="clearMarkers" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-red-600 transition-colors">
                    üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î
                </button>
            </div>
            
            <div class="grid grid-cols-1 gap-2">
                <button id="addCurrentLocation" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white p-3 rounded-lg font-semibold shadow-md hover:from-green-600 hover:to-blue-600 transition-all transform hover:scale-105 flex items-center justify-center">
                    üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                </button>
                <div class="text-xs text-gray-500 text-center">
                    üí° ‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏≠‡∏¢‡∏π‡πà
                </div>
            </div>
        </div>

        <!-- Distance Info -->
        <div id="distanceInfo" class="form-section rounded-xl p-4 mb-4 shadow-lg border border-white/20" style="display: none;">
            <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
            </h2>
            <div class="bg-yellow-50 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-yellow-600" id="distanceValue">0</div>
                <div class="text-gray-600 text-sm">‡πÄ‡∏°‡∏ï‡∏£ ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            </div>
        </div>

        <!-- Pole Data Form -->
        <div class="form-section rounded-xl p-4 mb-4 shadow-lg border border-white/20">
            <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                ‚ö° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
            </h2>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label>
                    <select id="poleType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤</option>
                        <option value="‡πÅ‡∏£‡∏á‡∏™‡∏π‡∏á">‚ö° ‡πÅ‡∏£‡∏á‡∏™‡∏π‡∏á (High Voltage)</option>
                        <option value="‡πÅ‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á">üîå ‡πÅ‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á (Medium Voltage)</option>
                        <option value="‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≥">üí° ‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≥ (Low Voltage)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á</label>
                    <select id="transformer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                        <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á</label>
                    <select id="guyWire" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                        <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                    <input type="file" id="imageFile" accept="image/*" capture="environment" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <div class="text-xs text-gray-500 mt-1">üì∏ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="form-section rounded-xl p-4 mb-4 shadow-lg border border-white/20">
            <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </h2>
            
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-blue-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalPoints">0</div>
                    <div class="text-gray-600">‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="savedPoints">0</div>
                    <div class="text-gray-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
            </div>

            <div class="mt-3 space-y-2 text-xs">
                <div class="flex justify-between">
                    <span>‚ö° ‡πÅ‡∏£‡∏á‡∏™‡∏π‡∏á:</span>
                    <span id="highVoltage" class="font-semibold">0</span>
                </div>
                <div class="flex justify-between">
                    <span>üîå ‡πÅ‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á:</span>
                    <span id="mediumVoltage" class="font-semibold">0</span>
                </div>
                <div class="flex justify-between">
                    <span>üí° ‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≥:</span>
                    <span id="lowVoltage" class="font-semibold">0</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-3">
            <button id="addPointData" class="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white p-4 rounded-xl font-semibold shadow-lg hover:from-blue-600 hover:to-green-600 transition-all transform hover:scale-105">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à
            </button>
            
            <button id="finishSurvey" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white p-4 rounded-xl font-semibold shadow-lg hover:from-green-600 hover:to-blue-600 transition-all transform hover:scale-105" style="display: none;">
                ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à
            </button>
            
            <div class="grid grid-cols-2 gap-3" id="exportButtons" style="display: none;">
                <button id="exportGoogleSheets" class="bg-green-600 text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-green-700 transition-all">
                    üìä Google Sheets
                </button>
                <button id="exportKML" class="bg-blue-600 text-white p-3 rounded-xl font-semibold shadow-lg hover:bg-blue-700 transition-all">
                    üó∫Ô∏è ‡πÑ‡∏ü‡∏•‡πå KML
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-xs text-gray-500">
            <p>üîß ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô GIS</p>
            <p>‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ (PEA)</p>
        </div>
    </div>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZB9R8J8lToURW_BwXhfLIRAAbK0jI90tOrwhxLuoWqEk4lKzDqxKjtMxkwU2NeHObwQ/exec';
        const SHEET_ID = '1kf_xzfTOx98T5f_9grznU3U0U1MqA87lt_Dl2hGSyAw';
        const FOLDER_ID = '1AmI2prj8Bma9gVBb0oLq7uwkr2D1aERZ';

        // Global variables
        let map;
        let markers = [];
        let surveyData = [];
        let currentLocation = null;
        let lastMarkerPosition = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 10); // Bangkok center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentLocation = [position.coords.latitude, position.coords.longitude];
                    map.setView(currentLocation, 15);
                    
                    // Add current location marker
                    L.marker(currentLocation)
                        .addTo(map)
                        .bindPopup('üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô')
                        .openPopup();
                });
            }

            // Add click event to map
            map.on('click', function(e) {
                addMarker(e.latlng);
            });
        }

        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update distance display
        function updateDistanceDisplay(lat, lng) {
            if (lastMarkerPosition) {
                const distance = calculateDistance(
                    lastMarkerPosition.lat, 
                    lastMarkerPosition.lng, 
                    lat, 
                    lng
                );
                
                document.getElementById('distanceValue').textContent = Math.round(distance);
                document.getElementById('distanceInfo').style.display = 'block';
            }
        }

        // Add marker to map
        function addMarker(latlng) {
            // Update distance display before adding marker
            updateDistanceDisplay(latlng.lat, latlng.lng);
            
            const marker = L.marker([latlng.lat, latlng.lng])
                .addTo(map)
                .bindPopup(`üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${markers.length + 1}<br>Lat: ${latlng.lat.toFixed(6)}<br>Lng: ${latlng.lng.toFixed(6)}`);
            
            markers.push({
                marker: marker,
                lat: latlng.lat,
                lng: latlng.lng,
                id: Date.now()
            });
            
            // Update last marker position
            lastMarkerPosition = { lat: latlng.lat, lng: latlng.lng };
            
            updateMarkerCount();
        }

        // Add current location marker
        function addCurrentLocationMarker() {
            if (navigator.geolocation) {
                // Show loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        // Close loading
                        Swal.close();
                        
                        // Update distance display before adding marker
                        updateDistanceDisplay(lat, lng);
                        
                        // Add marker at current location
                        const marker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(`üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${markers.length + 1}<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy.toFixed(0)}m`)
                            .openPopup();
                        
                        markers.push({
                            marker: marker,
                            lat: lat,
                            lng: lng,
                            id: Date.now(),
                            accuracy: accuracy
                        });
                        
                        // Update last marker position
                        lastMarkerPosition = { lat: lat, lng: lng };
                        
                        // Center map on new location
                        map.setView([lat, lng], 18);
                        
                        updateMarkerCount();
                        
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${markers.length} ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy.toFixed(0)}m)`,
                            timer: 2000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end'
                        });
                    },
                    function(error) {
                        Swal.close();
                        let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                                break;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                            text: errorMessage,
                            confirmButtonColor: '#ef4444'
                        });
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö',
                    text: '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        // Update marker count display
        function updateMarkerCount() {
            document.getElementById('markerCount').textContent = markers.length;
            document.getElementById('totalPoints').textContent = markers.length;
        }

        // Clear all markers
        function clearMarkers() {
            markers.forEach(item => {
                map.removeLayer(item.marker);
            });
            markers = [];
            lastMarkerPosition = null;
            document.getElementById('distanceInfo').style.display = 'none';
            updateMarkerCount();
            updateSummary();
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Add point data (new flow)
        async function addPointData() {
            const responsible = document.getElementById('responsible').value;
            const projectName = document.getElementById('projectName').value;
            const poleType = document.getElementById('poleType').value;
            const transformer = document.getElementById('transformer').value;
            const guyWire = document.getElementById('guyWire').value;
            const notes = document.getElementById('notes').value;
            const imageFile = document.getElementById('imageFile').files[0];

            if (!responsible || !projectName) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (markers.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏à‡∏∏‡∏î',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            try {
                let imageData = null;
                let fileName = null;
                let mimeType = null;

                if (imageFile) {
                    imageData = await fileToBase64(imageFile);
                    fileName = imageFile.name;
                    mimeType = imageFile.type;
                }

                // Save data for each marker
                for (let i = 0; i < markers.length; i++) {
                    const markerData = markers[i];
                    const pointData = {
                        responsible,
                        projectName,
                        pointNumber: surveyData.length + i + 1,
                        latitude: markerData.lat,
                        longitude: markerData.lng,
                        poleType,
                        transformer,
                        guyWire,
                        notes,
                        timestamp: new Date().toLocaleString('th-TH'),
                        imageData,
                        fileName,
                        mimeType
                    };
                    
                    surveyData.push(pointData);
                }

                // Clear form
                document.getElementById('poleType').value = '';
                document.getElementById('transformer').value = '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                document.getElementById('guyWire').value = '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                document.getElementById('notes').value = '';
                document.getElementById('imageFile').value = '';

                // Clear markers but keep last position for distance calculation
                markers.forEach(item => {
                    map.removeLayer(item.marker);
                });
                markers = [];
                document.getElementById('distanceInfo').style.display = 'none';

                updateMarkerCount();
                updateSummary();

                // Show finish survey button
                document.getElementById('finishSurvey').style.display = 'block';

                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß ${surveyData.length} ‡∏à‡∏∏‡∏î`,
                    confirmButtonColor: '#10b981'
                });

            } catch (error) {
                console.error('Error adding point data:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        // Finish survey
        function finishSurvey() {
            if (surveyData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏à‡∏∏‡∏î',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            Swal.fire({
                icon: 'success',
                title: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à!',
                text: `‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏£‡∏ß‡∏° ${surveyData.length} ‡∏à‡∏∏‡∏î`,
                confirmButtonColor: '#10b981'
            });

            // Show export buttons
            document.getElementById('exportButtons').style.display = 'grid';
            document.getElementById('finishSurvey').style.display = 'none';
        }

        // Export to Google Sheets
        async function exportToGoogleSheets() {
            if (surveyData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡πà‡∏≠‡∏ô',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                for (const data of surveyData) {
                    const params = new URLSearchParams({
                        action: 'saveData',
                        sheetId: SHEET_ID,
                        folderId: FOLDER_ID,
                        responsible: data.responsible,
                        projectName: data.projectName,
                        pointNumber: data.pointNumber,
                        latitude: data.latitude,
                        longitude: data.longitude,
                        poleType: data.poleType,
                        equipment: data.equipment,
                        poleHead: data.poleHead,
                        guyWire: data.guyWire,
                        notes: data.notes,
                        timestamp: data.timestamp
                    });

                    if (data.imageData) {
                        params.append('imageData', data.imageData);
                        params.append('fileName', data.fileName);
                        params.append('mimeType', data.mimeType);
                    }

                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: params.toString()
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                }

                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    confirmButtonColor: '#10b981'
                });

            } catch (error) {
                console.error('Error exporting data:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        // Export to KML
        function exportToKML() {
            if (surveyData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡πà‡∏≠‡∏ô',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            const responsible = document.getElementById('responsible').value;
            const projectName = document.getElementById('projectName').value;

            // Create KML content
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ - ${projectName}</name>
    <description>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÇ‡∏î‡∏¢ ${responsible} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleString('th-TH')}</description>
    
    <!-- Styles -->
    <Style id="poleHighVoltage">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/red-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="poleMediumVoltage">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="poleLowVoltage">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/grn-circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
`;

            // Add placemarks for each survey point
            surveyData.forEach((point, index) => {
                let styleId = 'poleLowVoltage';
                if (point.poleType === '‡πÅ‡∏£‡∏á‡∏™‡∏π‡∏á') styleId = 'poleHighVoltage';
                else if (point.poleType === '‡πÅ‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á') styleId = 'poleMediumVoltage';

                kmlContent += `    <Placemark>
      <name>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${point.pointNumber} - ${point.poleType}</name>
      <description><![CDATA[
        <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏™‡∏≤:</b> ${point.poleType}<br/>
        <b>‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á:</b> ${point.transformer}<br/>
        <b>‡∏™‡∏≤‡∏¢‡∏¢‡∏∂‡∏î‡πÇ‡∏¢‡∏á:</b> ${point.guyWire}<br/>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ${point.notes}<br/>
        <b>‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à:</b> ${point.responsible}<br/>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${point.timestamp}<br/>
        <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${point.latitude.toFixed(6)}, ${point.longitude.toFixed(6)}
      ]]></description>
      <styleUrl>#${styleId}</styleUrl>
      <Point>
        <coordinates>${point.longitude},${point.latitude},0</coordinates>
      </Point>
    </Placemark>
`;
            });

            kmlContent += `  </Document>
</kml>`;

            // Create and download file
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Swal.fire({
                icon: 'success',
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå KML ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡πÑ‡∏ü‡∏•‡πå KML ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô GIS ‡πÑ‡∏î‡πâ',
                confirmButtonColor: '#10b981'
            });
        }

        // Update summary statistics
        function updateSummary() {
            document.getElementById('savedPoints').textContent = surveyData.length;
            
            const highVoltage = surveyData.filter(d => d.poleType === '‡πÅ‡∏£‡∏á‡∏™‡∏π‡∏á').length;
            const mediumVoltage = surveyData.filter(d => d.poleType === '‡πÅ‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á').length;
            const lowVoltage = surveyData.filter(d => d.poleType === '‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≥').length;
            
            document.getElementById('highVoltage').textContent = highVoltage;
            document.getElementById('mediumVoltage').textContent = mediumVoltage;
            document.getElementById('lowVoltage').textContent = lowVoltage;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            document.getElementById('clearMarkers').addEventListener('click', clearMarkers);
            document.getElementById('addCurrentLocation').addEventListener('click', addCurrentLocationMarker);
            document.getElementById('addPointData').addEventListener('click', addPointData);
            document.getElementById('finishSurvey').addEventListener('click', finishSurvey);
            document.getElementById('exportGoogleSheets').addEventListener('click', exportToGoogleSheets);
            document.getElementById('exportKML').addEventListener('click', exportToKML);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'989b99465324a1c2',t:'MTc1OTY1MzQ2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
