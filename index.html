<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SURVEY PEA NPN [Ver1.0]</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .navbar {
            flex-shrink: 0;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 8px 12px !important;
            }
            .navbar h1 {
                font-size: 16px !important;
            }
            .nav-button {
                padding: 6px 8px !important;
                font-size: 12px !important;
            }
            .nav-button span:last-child {
                display: none;
            }
            .modal-content {
                margin: 10px;
                max-width: calc(100vw - 20px);
            }
            .dashboard-fullscreen {
                padding: 10px !important;
            }
            .dashboard-panel {
                padding: 12px !important;
            }
            .map-overlay {
                padding: 4px !important;
                font-size: 12px !important;
            }
            .map-overlay-top-right {
                top: 5px;
                right: 5px;
            }
            .map-overlay-bottom-right {
                bottom: 5px;
                right: 5px;
            }
            .map-overlay button {
                padding: 6px !important;
                font-size: 14px !important;
            }
        }
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            cursor: crosshair;
        }
        .map-overlay {
            position: absolute;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .map-overlay-top-right {
            top: 10px;
            right: 10px;
        }
        .map-overlay-bottom-right {
            bottom: 10px;
            right: 10px;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            z-index: 10000;
        }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            pointer-events: none;
            color: #ef4444;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .distance-line {
            stroke: #3b82f6;
            stroke-width: 3;
            stroke-dasharray: 5,5;
            fill: none;
        }
        .marker-number {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #tableContainer {
            max-height: 400px;
            transition: max-height 0.3s ease;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .dashboard-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #10b981; }
        .status-inactive { background-color: #ef4444; }
        .status-pending { background-color: #f59e0b; }
        
        /* Dashboard Full Screen */
        .dashboard-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #f0f9ff, #e0e7ff);
            z-index: 10000;
            overflow-y: auto;
        }
        
        /* Image Preview */
        .image-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-preview img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Hover Image */
        .hover-image {
            position: absolute;
            z-index: 15000;
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        /* Real-time distance line */
        .temp-line {
            stroke: #ef4444;
            stroke-width: 2;
            stroke-dasharray: 3,3;
            fill: none;
            opacity: 0.8;
        }
        
        .distance-label {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 15000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* SweetAlert2 custom z-index */
        .swal2-container {
            z-index: 30000 !important;
        }
        
        /* Range Slider Styling */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #ddd;
            outline: none;
            border-radius: 3px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
  <div class="main-container"><!-- Navigation Bar -->
   <nav class="navbar px-4 py-3">
    <div class="flex items-center justify-between flex-wrap gap-2"><!-- Logo และชื่อระบบ -->
     <div class="flex items-center space-x-3">
      <div class="text-2xl">
       🧭
      </div>
      <h1 class="text-xl font-bold text-white">SURVEY PEA NPN</h1>
     </div><!-- ข้อมูลโครงการปัจจุบัน -->
     <div id="currentProjectInfo" class="hidden flex items-center space-x-2 md:space-x-4 bg-white/20 rounded-lg px-2 md:px-4 py-2 text-xs md:text-sm">
      <div class="text-white">
       <div class="opacity-90">
        ผู้สำรวจ:
       </div>
       <div id="currentSurveyorName" class="font-semibold">
        -
       </div>
      </div>
      <div class="text-white">
       <div class="opacity-90">
        ชื่องาน:
       </div>
       <div id="currentProjectName" class="font-semibold">
        -
       </div>
      </div>
      <div class="text-white">
       <div class="opacity-90">
        จุดที่:
       </div>
       <div id="currentPointDisplay" class="font-semibold text-yellow-300">
        1
       </div>
      </div>
     </div><!-- ปุ่มควบคุม -->
     <div class="flex items-center space-x-1 md:space-x-2 flex-wrap"><!-- ปุ่มเริ่มสำรวจ --> <button id="newProjectBtn" class="nav-button bg-green-550 hover:bg-blue-300 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>🚀</span> <span class="hidden md:inline">START</span> </button> <!-- ปุ่มแดชบอร์ด --> <button id="dashboardBtn" class="nav-button bg-green-550 hover:bg-blue-300 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>📊</span> <span class="hidden md:inline">DASHBOARD</span> </button> <!-- ปุ่มบันทึกข้อมูล (แสดงเมื่อมีโครงการ) --> <button id="saveDataBtn" class="nav-button hidden bg-green-550 hover:bg-blue-300 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>💾</span> <span class="hidden md:inline">SAVE</span> </button> <!-- ปุ่มล้างข้อมูล --> <button id="clearDataBtn" class="nav-button bg-red-550 hover:bg-red-500 text-white px-2 md:px-4 py-2 rounded-lg font-medium flex items-center space-x-1 md:space-x-2"> <span>🗑️</span> <span class="hidden md:inline">DELETE DATA</span> </button>
     </div>
    </div>
   </nav><!-- แผนที่ -->
   <div class="map-container">
    <div id="map"></div><!-- Crosshair -->
    <div id="crosshair" class="crosshair">
     📍
    </div><!-- ข้อมูลระยะทาง (มุมบนขวา) -->
    <div class="map-overlay map-overlay-top-right">
     <div class="text-xs space-y-1">
      <div class="flex justify-between"><span>ระยะล่าสุด:</span> <span id="lastDistance" class="font-bold text-blue-600">0 ม.</span>
      </div>
      <div class="flex justify-between"><span>ระยะรวม:</span> <span id="totalDistance" class="font-bold text-green-600">0 ม.</span>
      </div>
      <div class="flex justify-between"><span>จุดทั้งหมด:</span> <span id="totalPoints" class="font-bold text-purple-600">0</span>
      </div>
     </div>
    </div><!-- ปุ่มควบคุมแผนที่ (มุมล่างขวา) -->
    <div class="map-overlay map-overlay-bottom-right">
     <div class="flex flex-col space-y-2"><button id="currentLocationBtn" class="bg-blue-400 text-white p-2 rounded hover:bg-blue-700 transition-colors" title="ตำแหน่งปัจจุบัน"> 📍 </button> <button id="toggleMapBtn" class="bg-blue-400 text-white p-2 rounded hover:bg-blue-700 transition-colors" title="เปลี่ยนแผนที่"> 🗺️ </button> <button id="addPointBtn" class="bg-blue-400 text-white p-2 rounded hover:bg-blue-700 transition-colors" title="ปักหมุด"> ➕ </button>
     </div>
    </div>
   </div>
  </div><!-- Modal สำหรับเริ่มโครงการใหม่ -->
  <div id="newProjectModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4">
   <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
    <div class="p-4 border-b bg-blue-600 text-white rounded-t-lg">
     <h3 class="text-lg font-semibold">🚀 เริ่มสำรวจ</h3>
    </div>
    <div class="p-6 space-y-4">
     <div><label class="block text-sm font-medium text-gray-700 mb-2">ผู้สำรวจ</label> <select id="surveyorSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">เลือกผู้สำรวจ...</option> </select>
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">ชื่องาน</label> <input type="text" id="projectName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="กรอกชื่อโครงการหรือ WBS...">
     </div>
    </div>
    <div class="p-4 border-t flex space-x-2"><button id="startSurveyBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"> เริ่มสำรวจ </button> <button id="cancelNewProjectBtn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700"> ยกเลิก </button>
    </div>
   </div>
  </div><!-- Dashboard Full Screen -->
  <div id="dashboardFullscreen" class="dashboard-fullscreen hidden">
   <div class="p-6"><!-- Header -->
    <div class="flex justify-between items-center mb-6">
     <h1 class="text-3xl font-bold text-gray-800">📁 DASHBOARD</h1><button id="closeDashboardBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2"> <span>❌</span> <span>ปิด</span> </button>
    </div><!-- สรุปข้อมูล -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
     <div class="dashboard-panel p-6">
      <h3 class="text-xl font-semibold text-gray-700 mb-3">โครงการทั้งหมด</h3>
      <p id="totalProjects" class="text-4xl font-bold text-blue-600">0</p>
     </div>
     <div class="dashboard-panel p-6">
      <h3 class="text-xl font-semibold text-gray-700 mb-3">จุดสำรวจทั้งหมด</h3>
      <p id="totalPointsAll" class="text-4xl font-bold text-green-600">0</p>
     </div>
     <div class="dashboard-panel p-6">
      <h3 class="text-xl font-semibold text-gray-700 mb-3">ระยะทางรวม</h3>
      <p id="totalDistanceAll" class="text-4xl font-bold text-purple-600">0 ม.</p>
     </div>
    </div><!-- สถิติผู้สำรวจ -->
    <div class="mb-8">
     <h2 class="text-2xl font-bold text-gray-800 mb-4">📈 สถิติผู้สำรวจ</h2>
     <div id="surveyorStats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"><!-- การ์ดสถิติจะถูกเพิ่มที่นี่ -->
     </div>
    </div><!-- ตัวกรองและค้นหา -->
    <div class="dashboard-panel p-6 mb-8">
     <div class="flex flex-wrap gap-4 items-end">
      <div class="flex-1 min-w-48"><label class="block text-sm font-medium text-gray-700 mb-2">กรองตามผู้สำรวจ</label> <select id="filterSurveyor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">ทั้งหมด</option> </select>
      </div>
      <div class="flex-1 min-w-48"><label class="block text-sm font-medium text-gray-700 mb-2">กรองตามปี</label>
       <div class="space-y-2"><input type="range" id="filterYear" min="2566" max="2570" value="2568" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
        <div class="flex justify-between text-xs text-gray-500"><span>2566</span> <span id="yearDisplay" class="font-semibold text-blue-600">2568</span> <span>2570</span>
        </div>
        <div class="text-center"><button id="clearYearFilter" class="text-xs text-gray-500 hover:text-gray-700 underline"> แสดงทุกปี </button>
        </div>
       </div>
      </div>
      <div class="flex-1 min-w-48"><label class="block text-sm font-medium text-gray-700 mb-2">ค้นหาโครงการ</label> <input type="text" id="searchInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ค้นหาชื่อโครงการ...">
      </div>
      <div class="flex space-x-3"><button id="clearFilters" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium"> 🗑️ ล้างตัวกรอง </button>
      </div>
     </div>
    </div><!-- ตารางข้อมูล -->
    <div class="dashboard-panel overflow-hidden">
     <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
      <h3 class="text-xl font-semibold text-gray-800">สถานะงาน</h3><button id="toggleTableBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium"> 📋 ขยายตาราง </button>
     </div>
     <div id="tableContainer" class="overflow-x-auto">
      <table class="w-full">
       <thead class="bg-gray-100 sticky top-0">
        <tr>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('index')">ลำดับ <span class="text-xs">↕️</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('surveyor')">ผู้สำรวจ <span class="text-xs">↕️</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('project')">โครงการ <span class="text-xs">↕️</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('distance')">ระยะทางรวม (เมตร) <span class="text-xs">↕️</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">ภาพแผนที่</th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">ภาพจุดเชื่อมต่อ</th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">ลิงก์เอกสาร</th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('status')">สถานะ <span class="text-xs">↕️</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-200" onclick="sortTable('date')">วันที่ <span class="text-xs">↕️</span></th>
         <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">ดาวน์โหลด KML</th>
        </tr>
       </thead>
       <tbody id="projectTableBody" class="divide-y divide-gray-200">
       </tbody>
      </table>
     </div>
    </div>
   </div>
  </div><!-- Modal สำหรับกรอกข้อมูลจุด -->
  <div id="pointModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4">
   <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
    <div class="p-4 border-b bg-red-600 text-white rounded-t-lg">
     <h3 class="text-lg font-semibold">📍 ข้อมูลจุดที่ <span id="pointNumber">1</span></h3>
    </div>
    <div class="p-4 space-y-4 max-h-96 overflow-y-auto"><!-- จุดเชื่อมต่อ (เฉพาะจุดแรก) -->
     <div id="connectionPointSection"><label class="block text-sm font-medium text-gray-700 mb-2">📷 จุดเชื่อมต่อ</label> <input type="file" id="connectionImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded">
     </div><!-- เอกสารแนบ (เฉพาะจุดแรก) -->
     <div id="documentSection"><label class="block text-sm font-medium text-gray-700 mb-2">📄 เอกสารแนบ</label> <input type="file" id="documentFile" accept="image/*,.pdf,.doc,.docx" class="w-full p-2 border border-gray-300 rounded">
     </div><!-- ประเภทเสา (บังคับ) -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">⚡ ประเภทเสา <span class="text-red-500">*</span></label> <select id="poleType" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" required> <option value="">เลือกประเภทเสา...</option> </select>
     </div><!-- การติดตั้งอุปกรณ์ -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">🔧 การติดตั้งอุปกรณ์</label> <select id="equipment" class="w-full p-2 border border-gray-300 rounded"> <option value="">เลือกอุปกรณ์...</option> </select>
     </div><!-- หัวเสา -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">🔝 หัวเสา</label> <select id="poleHead" class="w-full p-2 border border-gray-300 rounded"> <option value="">เลือกหัวเสา...</option> </select>
     </div><!-- สายยึดโยง&เทโคน -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">🔗 สายยึดโยง&amp;เทโคน</label> <select id="wireSupport" class="w-full p-2 border border-gray-300 rounded"> <option value="">เลือกสายยึดโยง...</option> </select>
     </div><!-- ภาพประกอบ -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">📸 ภาพประกอบ</label> <input type="file" id="pointImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded">
     </div><!-- หมายเหตุ -->
     <div><label class="block text-sm font-medium text-gray-700 mb-2">📝 หมายเหตุ</label> <textarea id="notes" class="w-full p-2 border border-gray-300 rounded" rows="3" placeholder="หมายเหตุเพิ่มเติม..."></textarea>
     </div>
    </div>
    <div class="p-4 border-t flex space-x-2"><button id="addPointModalBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"> ➕ เพิ่มจุด </button> <button id="finishPointBtn" class="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700"> ✅ เสร็จสิ้น </button> <button id="cancelPointBtn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700"> ❌ ยกเลิก </button>
    </div>
   </div>
  </div>
  <script>
	// === SAFE OVERLAY (NO-OP) ===
window.showLoadingOverlay = window.showLoadingOverlay || function(){};
window.hideLoadingOverlay  = window.hideLoadingOverlay  || function(){};

        // ตัวแปรสำคัญ
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3sc2q1SQAkeDN1MxHOClJLqPyuSwu7gEkZ_WkuI-FkrUb4tScLt43_TD4jIc1fqZUfw/exec';
        const SHEET_ID = '1gQR42JzTackvfuedJUW5Zm-s9N_sun0mFb8zdOPyeVg';
        const FOLDER_ID = '1AL8KrbctkMQRA_AgmVfMLZU4a76soBX_';
        
	// === NEW: device helper ===
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
  navigator.userAgent
);
	let map;
        let currentSurveyor = '';
        let currentProject = '';
        let surveyPoints = [];
        let currentPointNumber = 1;
        let totalDistance = 0;
        let lastDistance = 0;
        let isMapSatellite = false;
        let polyline;
        let markers = [];
        let dropdownOptions = {};
        let allProjectData = [];
        let filteredProjectData = [];
        let isTableExpanded = false;
        let tempLine = null;
        let isProcessing = false;
        let currentLocationMarker = null;
        let distanceLabel = null;
        let watchId = null;
	// ให้รีเซ็นเตอร์อัตโนมัติ “ครั้งถัดไปเท่านั้น”
	let shouldCenterOnGPS = true;


        // เริ่มต้นแอป
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                await loadDropdownOptions();
                setupEventListeners();
                initializeMap();
            } catch (error) {
                console.error('Error initializing app:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเริ่มต้นแอปได้', 'error');
            }
        }

        // โหลดตัวเลือก dropdown จาก Google Sheet
        async function loadDropdownOptions() {
            try {
                console.log('🔄 กำลังโหลดตัวเลือก dropdown จาก Google Sheets:', SCRIPT_URL);
                
                // ลองหลายวิธีในการเรียก API
                let response;
                let data;
                
                // วิธีที่ 1: GET request แบบปกติ
                try {
                    response = await fetch(`${SCRIPT_URL}?action=getOptions&timestamp=${Date.now()}`, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        console.log('📄 Response (Method 1):', responseText.substring(0, 200) + '...');
                        data = JSON.parse(responseText);
                        
                        if (data && data.success && data.options) {
                            console.log('✅ Method 1 สำเร็จ!');
                            dropdownOptions = data.options;
                            populateDropdowns();
                            return;
                        }
                    }
                } catch (error) {
                    console.log('❌ Method 1 ล้มเหลว:', error.message);
                }
                
                // วิธีที่ 2: POST request
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'getOptions');
                    
                    response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params.toString()
                    });
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        console.log('📄 Response (Method 2):', responseText.substring(0, 200) + '...');
                        data = JSON.parse(responseText);
                        
                        if (data && data.success && data.options) {
                            console.log('✅ Method 2 สำเร็จ!');
                            dropdownOptions = data.options;
                            populateDropdowns();
                            return;
                        }
                    }
                } catch (error) {
                    console.log('❌ Method 2 ล้มเหลว:', error.message);
                }
                
                // วิธีที่ 3: ใช้ข้อมูลสำรอง
                console.log('🔄 ใช้ข้อมูลสำรองชั่วคราว...');
                dropdownOptions = {
                    surveyor: ['นาย ก', 'นาย ข', 'นาย ค', 'นาง ง', 'นางสาว จ'],
                    poleType: ['เสาคอนกรีต 12 ม.', 'เสาคอนกรีต 15 ม.', 'เสาเหล็ก 12 ม.', 'เสาเหล็ก 15 ม.', 'เสาไม้ 9 ม.'],
                    equipment: ['หม้อแปลง 25 kVA', 'หม้อแปลง 50 kVA', 'หม้อแปลง 100 kVA', 'สวิตช์เกียร์', 'คาปาซิเตอร์แบงค์'],
                    poleHead: ['หัวเสาแบบ A', 'หัวเสาแบบ B', 'หัวเสาแบบ C', 'หัวเสาพิเศษ'],
                    wireSupport: ['สายยึดโยงเหล็ก', 'สายยึดโยงอลูมิเนียม', 'เทโคนเหล็ก', 'เทโคนคอนกรีต']
                };
                
                populateDropdowns();
                
                // แสดงข้อความแจ้งเตือน
                Swal.fire({
                    title: '⚠️ ใช้ข้อมูลสำรอง',
                    html: `
                        <p>ไม่สามารถเชื่อมต่อ Google Sheets ได้</p>
                        <p class="text-sm text-gray-600 mt-2">ระบบกำลังใช้ข้อมูลสำรองชั่วคราว</p>
                        <div class="mt-3 p-3 bg-yellow-50 rounded">
                            <p class="text-sm text-yellow-700">
                                <strong>หมายเหตุ:</strong> ข้อมูลที่บันทึกจะไม่ถูกส่งไปยัง Google Sheets
                            </p>
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded">
                            <p class="text-sm text-blue-600">
                                กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและ URL ของ Google Apps Script
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    confirmButtonText: 'ใช้ข้อมูลสำรอง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
            } catch (error) {
                console.error('❌ เกิดข้อผิดพลาดร้ายแรง:', error);
                
                // ใช้ข้อมูลสำรองในกรณีฉุกเฉิน
                dropdownOptions = {
                    surveyor: ['ผู้สำรวจ 1', 'ผู้สำรวจ 2', 'ผู้สำรวจ 3'],
                    poleType: ['เสาคอนกรีต', 'เสาเหล็ก', 'เสาไม้'],
                    equipment: ['หม้อแปลง', 'สวิตช์เกียร์', 'คาปาซิเตอร์'],
                    poleHead: ['หัวเสาปกติ', 'หัวเสาพิเศษ'],
                    wireSupport: ['สายยึดโยง', 'เทโคน']
                };
                
                populateDropdowns();
                
                Swal.fire({
                    title: 'ข้อผิดพลาดการเชื่อมต่อ',
                    text: 'ใช้ข้อมูลสำรองเพื่อให้สามารถใช้งานได้',
                    icon: 'error',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }
        }



        function populateDropdowns() {
            console.log('🔄 กำลังเติมข้อมูลใน dropdown...', dropdownOptions);
            
            // ผู้สำรวจ
            const surveyorSelect = document.getElementById('surveyorSelect');
            if (surveyorSelect) {
                surveyorSelect.innerHTML = '<option value="">เลือกผู้สำรวจ...</option>';
                surveyorSelect.disabled = false;
                
                if (dropdownOptions.surveyor && Array.isArray(dropdownOptions.surveyor) && dropdownOptions.surveyor.length > 0) {
                    console.log('✅ พบข้อมูลผู้สำรวจ:', dropdownOptions.surveyor.length, 'คน');
                    dropdownOptions.surveyor.forEach((option, index) => {
                        if (option && option.trim()) {
                            surveyorSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                } else {
                    console.log('⚠️ ไม่พบข้อมูลผู้สำรวจ - ใช้ข้อมูลเริ่มต้น');
                    const defaultSurveyors = ['ผู้สำรวจ 1', 'ผู้สำรวจ 2', 'ผู้สำรวจ 3'];
                    defaultSurveyors.forEach(option => {
                        surveyorSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // ประเภทเสา
            const poleTypeSelect = document.getElementById('poleType');
            if (poleTypeSelect) {
                poleTypeSelect.innerHTML = '<option value="">เลือกประเภทเสา...</option>';
                poleTypeSelect.disabled = false;
                
                if (dropdownOptions.poleType && Array.isArray(dropdownOptions.poleType) && dropdownOptions.poleType.length > 0) {
                    dropdownOptions.poleType.forEach(option => {
                        if (option && option.trim()) {
                            poleTypeSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('✅ เติมข้อมูลประเภทเสา:', dropdownOptions.poleType.length, 'รายการ');
                } else {
                    console.log('⚠️ ไม่พบข้อมูลประเภทเสา - ใช้ข้อมูลเริ่มต้น');
                    const defaultPoleTypes = ['เสาคอนกรีต', 'เสาเหล็ก', 'เสาไม้'];
                    defaultPoleTypes.forEach(option => {
                        poleTypeSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // อุปกรณ์
            const equipmentSelect = document.getElementById('equipment');
            if (equipmentSelect) {
                equipmentSelect.innerHTML = '<option value="">เลือกอุปกรณ์...</option>';
                
                if (dropdownOptions.equipment && Array.isArray(dropdownOptions.equipment) && dropdownOptions.equipment.length > 0) {
                    dropdownOptions.equipment.forEach(option => {
                        if (option && option.trim()) {
                            equipmentSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('✅ เติมข้อมูลอุปกรณ์:', dropdownOptions.equipment.length, 'รายการ');
                } else {
                    const defaultEquipment = ['หม้อแปลง', 'สวิตช์เกียร์', 'คาปาซิเตอร์'];
                    defaultEquipment.forEach(option => {
                        equipmentSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // หัวเสา
            const poleHeadSelect = document.getElementById('poleHead');
            if (poleHeadSelect) {
                poleHeadSelect.innerHTML = '<option value="">เลือกหัวเสา...</option>';
                
                if (dropdownOptions.poleHead && Array.isArray(dropdownOptions.poleHead) && dropdownOptions.poleHead.length > 0) {
                    dropdownOptions.poleHead.forEach(option => {
                        if (option && option.trim()) {
                            poleHeadSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('✅ เติมข้อมูลหัวเสา:', dropdownOptions.poleHead.length, 'รายการ');
                } else {
                    const defaultPoleHeads = ['หัวเสาปกติ', 'หัวเสาพิเศษ'];
                    defaultPoleHeads.forEach(option => {
                        poleHeadSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }

            // สายยึดโยง
            const wireSupportSelect = document.getElementById('wireSupport');
            if (wireSupportSelect) {
                wireSupportSelect.innerHTML = '<option value="">เลือกสายยึดโยง...</option>';
                
                if (dropdownOptions.wireSupport && Array.isArray(dropdownOptions.wireSupport) && dropdownOptions.wireSupport.length > 0) {
                    dropdownOptions.wireSupport.forEach(option => {
                        if (option && option.trim()) {
                            wireSupportSelect.innerHTML += `<option value="${option.trim()}">${option.trim()}</option>`;
                        }
                    });
                    console.log('✅ เติมข้อมูลสายยึดโยง:', dropdownOptions.wireSupport.length, 'รายการ');
                } else {
                    const defaultWireSupports = ['สายยึดโยง', 'เทโคน'];
                    defaultWireSupports.forEach(option => {
                        wireSupportSelect.innerHTML += `<option value="${option}">${option}</option>`;
                    });
                }
            }
            
            console.log('🎉 เติมข้อมูล dropdown เสร็จสิ้น!');
        }

// === Toast helpers (วางเหนือ setupEventListeners) ===
function notifySuccess(message) {
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon: 'success',
    title: message,
    showConfirmButton: false,
    timer: 3000
  });
}
function notifyError(message) {
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon: 'error',
    title: message,
    showConfirmButton: false,
    timer: 3000
  });
}
// === Mobile-safe SweetAlert (safe attach) ===
(function attachMobileSafeSwal(){
  function patch() {
    // ต้องมี Swal และยังไม่เคยแพตช์
    if (!window.Swal || !Swal.fire || Swal.__mobilePatched) return;

    const _fire = Swal.fire.bind(Swal);

    Swal.fire = function (opts, ...rest) {
      // ถ้า dev เรียกด้วย string ให้ห่อเป็น object
      if (typeof opts === 'string') opts = { title: String(opts) };

      // Toast ปล่อยผ่าน (คง timer ได้)
      if (opts && opts.toast) {
        return _fire(opts, ...rest);
      }

      // Modal: บังคับ “ค้างรอผู้ใช้กด” บนมือถือ
      const safe = Object.assign(
        {
          allowOutsideClick: false,
          allowEscapeKey: false,
          heightAuto: false,
          showConfirmButton: true,
          confirmButtonText: (opts && opts.confirmButtonText) || 'ตกลง'
        },
        opts || {}
      );

      // ลบ timer ออกจาก modal เสมอ (กันเด้งหาย)
      if ('timer' in safe) delete safe.timer;

      return _fire(safe, ...rest);
    };

    Swal.__mobilePatched = true;
  }

  // แพตช์ทันทีถ้า Swal มีแล้ว
  if (window.Swal && Swal.fire) {
    patch();
  } else {
    // ถ้า script SweetAlert โหลดช้ากว่า เราจะรอ
    const iv = setInterval(() => {
      if (window.Swal && Swal.fire) {
        clearInterval(iv);
        patch();
      }
    }, 50);
    // กันลูปยาวเกินไป
    setTimeout(() => clearInterval(iv), 5000);
  }
})();


        function setupEventListeners() {
            // ปุ่มในแถบนำทาง
            document.getElementById('newProjectBtn').addEventListener('click', showNewProjectModal);
            document.getElementById('dashboardBtn').addEventListener('click', showDashboardModal);
            document.getElementById('saveDataBtn').addEventListener('click', saveAllData);
            document.getElementById('clearDataBtn').addEventListener('click', confirmClearDataFromNav);
            
            // ปุ่มในแผนที่
            document.getElementById('currentLocationBtn').addEventListener('click', () => {
  // ขอให้ระบบรีเซ็นเตอร์ “ครั้งถัดไป” เท่านั้น
  shouldCenterOnGPS = true;

  if (currentLocationMarker) {
    // มีตำแหน่งล่าสุดแล้ว → รีเซ็นเตอร์ให้เลย 1 ครั้ง แล้วปิด auto-center
    map.setView(currentLocationMarker.getLatLng(), 16);
    shouldCenterOnGPS = false;
  } else {
    // ยังไม่มีพิกัด → ขอ GPS พร้อมบังคับรีเซ็นเตอร์ 1 ครั้ง แล้วแฟล็กจะถูกปิดใน getCurrentLocation
    getCurrentLocation(true);
  }
});


            document.getElementById('toggleMapBtn').addEventListener('click', toggleMapView);
            document.getElementById('addPointBtn').addEventListener('click', confirmAddPoint);
            
            // Modal โครงการใหม่
            document.getElementById('startSurveyBtn').addEventListener('click', startSurvey);
            document.getElementById('cancelNewProjectBtn').addEventListener('click', hideNewProjectModal);
            
            // Modal แดชบอร์ด
            document.getElementById('closeDashboardBtn').addEventListener('click', hideDashboardModal);
            
            // ปุ่มใน Modal จุด
            document.getElementById('addPointModalBtn').addEventListener('click', addPointFromModal);
            document.getElementById('finishPointBtn').addEventListener('click', finishPoint);
            document.getElementById('cancelPointBtn').addEventListener('click', cancelPoint);
            
            // ตัวกรองและค้นหาในแดชบอร์ด
            document.getElementById('filterSurveyor').addEventListener('change', filterTable);
            document.getElementById('filterYear').addEventListener('input', updateYearDisplay);
            document.getElementById('filterYear').addEventListener('change', filterTable);
            document.getElementById('searchInput').addEventListener('input', filterTable);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('toggleTableBtn').addEventListener('click', toggleTable);
            
            // Event listener สำหรับปุ่มล้างตัวกรองปี (จะเพิ่มหลังจากโหลดแดชบอร์ด)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'clearYearFilter') {
                    document.getElementById('filterYear').value = '2568';
                    updateYearDisplay();
                    filterTable();
                }
            });
// === NEW: event delegation สำหรับปุ่มดาวน์โหลด KML ในตาราง ===
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.download-kml');
  if (!btn) return;  // ถ้าไม่ได้คลิกที่ปุ่ม KML ให้ข้าม

  const project = (btn.dataset.project || '').trim();
  if (!project) {
    // ถ้ามี helper toast แล้ว ให้ใช้; ถ้าไม่มีก็ใช้ Swal แบบยืนยัน
    if (typeof notifyError === 'function') {
      notifyError('ไม่พบชื่องานสำหรับดาวน์โหลด KML');
    } else {
      Swal.fire({
        title: 'ไม่พบชื่องาน',
        text: 'ไม่พบชื่องานสำหรับดาวน์โหลด KML',
        icon: 'error',
        confirmButtonText: 'ตกลง',
        allowOutsideClick: false
      });
    }
    return;
  }

  // เรียกฟังก์ชันเดิม
  downloadKML(project);
});

        }

//222222222222
// === NEW: live measure toggles ===
function enableLiveMeasure() {
  if (!map) return;

  const onMobileMove = () => {
    if (surveyPoints.length > 0 && !isProjectFinished) {
      updateTempLine(map.getCenter());
    }
  };

  map.__onMobileMove = onMobileMove;

  if (isMobile) {
    map.on('move', map.__onMobileMove);
    map.on('touchmove', map.__onMobileMove);
  }
}

function disableLiveMeasure() {
  if (!map) return;
  if (map.__onMobileMove) {
    map.off('move', map.__onMobileMove);
    map.off('touchmove', map.__onMobileMove);
    map.__onMobileMove = null;
  }
  clearDistanceLines?.();
  document.getElementById('lastDistance').textContent = '0 ม.';
}

	//222222222222

        function initializeMap() {
            setTimeout(() => {
                try {
                    console.log('Initializing map...');
                    
                    if (typeof L === 'undefined') {
                        console.error('Leaflet not loaded');
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดไลบรารีแผนที่ได้', 'error');
                        return;
                    }
                    
                    map = L.map('map', {
                        center: [13.7563, 100.5018],
                        zoom: 13,
                        zoomControl: true
                    });
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(map);
                    map.on('dragstart', () => { shouldCenterOnGPS = false; });
			map.on('zoomstart', () => { shouldCenterOnGPS = false; });


                    polyline = L.polyline([], {
                        color: '#3b82f6',
                        weight: 3,
                        dashArray: '5, 5'
                    }).addTo(map);
                    
                    // เส้นชั่วคราวสำหรับแสดงระยะทางแบบเรียลไทม์
                    tempLine = L.polyline([], {
                        color: '#ef4444',
                        weight: 2,
                        dashArray: '3, 3',
                        opacity: 0.8
                    }).addTo(map);
                    
                    map.on('click', function(e) {
                        if (currentSurveyor && currentProject && !isProcessing) {
                            confirmAddPointAtLocation(e.latlng);
                        }
                    });
                    
                    // เหตุการณ์เมื่อเมาส์เคลื่อนที่บนแผนที่
                    map.on('mousemove', function(e) {
                        if (currentSurveyor && currentProject && surveyPoints.length > 0) {
                            updateTempLine(e.latlng);
                        }
                    });
                    
                    map.whenReady(() => {
                        console.log('Map ready');
                        getCurrentLocation();
			enableLiveMeasure(); // <<< NEW: เปิดโหมดวัดระยะเรียลไทม์
                    });
                    
                    console.log('Map initialized successfully');
                } catch (error) {
                    console.error('Error initializing map:', error);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดแผนที่ได้: ' + error.message, 'error');
                }
            }, 300);
        }
        
        function updateTempLine(latlng) {
  if (!latlng || surveyPoints.length === 0) return;

  const lastPoint = surveyPoints[surveyPoints.length - 1];
  const tempDistance = calculateDistance(lastPoint.lat, lastPoint.lng, latlng.lat, latlng.lng);

  tempLine.setLatLngs([
    [lastPoint.lat, lastPoint.lng],
    [latlng.lat, latlng.lng]
  ]);

  if (distanceLabel) {
    map.removeLayer(distanceLabel);
  }

  const midLat = (lastPoint.lat + latlng.lat) / 2;
  const midLng = (lastPoint.lng + latlng.lng) / 2;

  distanceLabel = L.marker([midLat, midLng], {
    icon: L.divIcon({
      className: 'distance-label',
      html: `<div class="distance-label">${Math.round(tempDistance)} ม.</div>`,
      iconSize: [60, 20],
      iconAnchor: [30, 10]
    })
  }).addTo(map);

  document.getElementById('lastDistance').textContent = `${Math.round(tempDistance)} ม.`; // เด้งแบบเรียลไทม์
}


        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('hidden');
            document.getElementById('newProjectModal').classList.add('flex');
        }

        function hideNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('hidden');
            document.getElementById('newProjectModal').classList.remove('flex');
        }

        async function showDashboardModal() {
            // ตรวจสอบว่ามีข้อมูลที่ยังไม่ได้บันทึกหรือไม่
            if (isProjectFinished && surveyPoints.length > 0) {
                const saveResult = await Swal.fire({
                    title: 'คุณยังไม่ได้ทำการบันทึก',
                    text: 'ต้องการบันทึกหรือไม่?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ใช่, บันทึก',
                    cancelButtonText: 'ไม่',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
                if (saveResult.isConfirmed) {
                    try {
                        await saveAllData();
                        // หลังจากบันทึกเสร็จแล้วค่อยไปแดชบอร์ด
                        document.getElementById('dashboardFullscreen').classList.remove('hidden');
                        await loadDashboardData();
                    } catch (error) {
                        Swal.fire({
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถบันทึกข้อมูลได้',
                            icon: 'error',
                            confirmButtonText: 'ตกลง',
                            allowOutsideClick: false
                        });
                        return;
                    }
                } else {
                    // ไม่บันทึก ไปแดชบอร์ดเลย
                    document.getElementById('dashboardFullscreen').classList.remove('hidden');
                    await loadDashboardData();
                }
            } else {
                // ไม่มีข้อมูลที่ต้องบันทึก ไปแดชบอร์ดเลย
                document.getElementById('dashboardFullscreen').classList.remove('hidden');
                await loadDashboardData();
            }
        }

        function hideDashboardModal() {
            document.getElementById('dashboardFullscreen').classList.add('hidden');
        }

        function startSurvey() {
            const surveyor = document.getElementById('surveyorSelect').value;
            const project = document.getElementById('projectName').value;
            
            if (!surveyor || !project) {
                Swal.fire({
                    title: 'กรุณากรอกข้อมูล',
                    text: 'กรุณาเลือกผู้สำรวจและกรอกชื่องาน(หรือWBS)',
                    icon: 'warning',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false
                });
                return;
            }
            
            currentSurveyor = surveyor;
            currentProject = project;
            
            // อัปเดตข้อมูลในแถบนำทาง
            document.getElementById('currentSurveyorName').textContent = surveyor;
            document.getElementById('currentProjectName').textContent = project;
            document.getElementById('currentProjectInfo').classList.remove('hidden');
            document.getElementById('saveDataBtn').classList.remove('hidden');
            
            hideNewProjectModal();
            
            Swal.fire({
                title: 'START 🚗📍!',
                text: 'คุณสามารถเริ่มปักหมุดจุดสำรวจได้แล้ว',
                icon: 'success',
                confirmButtonText: 'ตกลง',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        }

function getCurrentLocation(forceCenter = false) {
  if (!navigator.geolocation) {
    Swal.fire('ไม่รองรับ GPS', 'เบราว์เซอร์นี้ไม่รองรับการหาตำแหน่ง', 'error');
    return;
  }

  // ใช้ overlay ของเราเอง (ไม่ปิดโมดัลอื่น)
  showLoadingOverlay('กำลังค้นหาตำแหน่ง...');

  // เคลียร์ watch เดิมถ้ามี
  if (window.watchId) navigator.geolocation.clearWatch(watchId);

  window.watchId = navigator.geolocation.watchPosition(
    (position) => {
      try {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        updateCurrentLocationMarker(lat, lng);

        // รีเซ็นเตอร์ “ครั้งเดียว” เท่านั้น
        if (forceCenter) {
          map.setView([lat, lng], 16);
          shouldCenterOnGPS = false;
        } else if (shouldCenterOnGPS) {
          map.setView([lat, lng], 16);
          shouldCenterOnGPS = false;
        }
      } finally {
        hideLoadingOverlay();
      }
    },
    (error) => {
      hideLoadingOverlay();
      Swal.fire({
        title: 'ไม่สามารถหาตำแหน่งได้',
        text: 'กรุณาเปิด GPS และอนุญาตการเข้าถึงตำแหน่ง',
        icon: 'error',
        confirmButtonText: 'ตกลง',
        allowOutsideClick: false,
        allowEscapeKey: false
      });
    },
    { enableHighAccuracy: true, timeout: 100000, maximumAge: 5000 }
  );
}

        
        function updateCurrentLocationMarker(lat, lng) {
            // ลบ marker เก่า
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            
            // สร้าง marker ใหม่
            const locationIcon = L.divIcon({
                className: 'current-location-marker',
                html: '<div style="background: #3b82f6; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">📍</div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            currentLocationMarker = L.marker([lat, lng], { icon: locationIcon }).addTo(map);
            currentLocationMarker.bindPopup('ตำแหน่งปัจจุบัน');
        }

        function toggleMapView() {
            const mapContainer = map.getContainer();
            map.eachLayer((layer) => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            
            if (isMapSatellite) {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                isMapSatellite = false;
            } else {
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '© Esri'
                }).addTo(map);
                isMapSatellite = true;
            }
        }

        async function confirmAddPoint() {
            if (!currentSurveyor || !currentProject) {
                Swal.fire({
                    title: 'กรุณากดปุ่ม START',
                    text: 'กรุณากดปุ่ม START ใหม่ก่อนปักหมุด',
                    icon: 'warning',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false
                });
                return;
            }
            
            const result = await Swal.fire({
                title: 'ยืนยันการปักหมุด',
                text: `ต้องการปักหมุดจุดที่ ${currentPointNumber} ใช่หรือไม่?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ปักหมุด',
                cancelButtonText: 'ยกเลิก',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            
            if (result.isConfirmed) {
                showPointModal();
            }
        }

        async function confirmAddPointAtLocation(latlng) {
            if (!currentSurveyor || !currentProject) {
                Swal.fire({
                    title: 'กรุณากดปุ่ม START',
                    text: 'กรุณาเริ่มโครงการใหม่ก่อนปักหมุด',
                    icon: 'warning',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false
                });
                return;
            }
            
            // ตรวจสอบว่าโครงการเสร็จสิ้นแล้วหรือไม่
            if (isProjectFinished) {
                const continueResult = await Swal.fire({
                    title: 'สำรวจต่อหรือไม่?',
                    text: 'คุณได้เสร็จสิ้นการสำรวจแล้ว ต้องการสำรวจต่อใช่หรือไม่?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ใช่, สำรวจต่อ',
                    cancelButtonText: 'ไม่ใช่',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
                if (!continueResult.isConfirmed) {
                    return; // กลับไปที่แผนที่
                }
                
                // ถ้าเลือกสำรวจต่อ ให้รีเซ็ตสถานะและแสดงเส้นประวัดระยะทางใหม่
                isProjectFinished = false;
                // <<< เพิ่มสองบรรทัดนี้
currentPointNumber = surveyPoints.length + 1;
document.getElementById('currentPointDisplay').textContent = currentPointNumber;
                // แสดงเส้นประวัดระยะทางใหม่
                if (surveyPoints.length > 0) {
                    const points = surveyPoints.map(point => [point.lat, point.lng]);
                    polyline.setLatLngs(points);
                }
            }
            
            const result = await Swal.fire({
                title: 'ยืนยันการปักหมุด',
                text: `ต้องการปักหมุดจุดที่ ${currentPointNumber} ที่ตำแหน่งนี้ใช่หรือไม่?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ปักหมุด',
                cancelButtonText: 'ยกเลิก',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            
            if (result.isConfirmed) {
                map.setView([latlng.lat, latlng.lng], map.getZoom());
                showPointModal();
            }
        }

        function showPointModal() {
            document.getElementById('pointNumber').textContent = currentPointNumber;
            
            const connectionSection = document.getElementById('connectionPointSection');
            const documentSection = document.getElementById('documentSection');
            
            if (currentPointNumber === 1) {
                connectionSection.style.display = 'block';
                documentSection.style.display = 'block';
            } else {
                connectionSection.style.display = 'none';
                documentSection.style.display = 'none';
            }
            
            resetModalForm();
            
            document.getElementById('pointModal').classList.remove('hidden');
            document.getElementById('pointModal').classList.add('flex');
        }

        function resetModalForm() {
            document.getElementById('connectionImage').value = '';
            document.getElementById('documentFile').value = '';
            document.getElementById('poleType').value = '';
            document.getElementById('equipment').value = '';
            document.getElementById('poleHead').value = '';
            document.getElementById('wireSupport').value = '';
            document.getElementById('pointImage').value = '';
            document.getElementById('notes').value = '';
        }

        function hidePointModal() {
            document.getElementById('pointModal').classList.add('hidden');
            document.getElementById('pointModal').classList.remove('flex');
        }

        async function addPointFromModal() {
            if (isProcessing) return;
            
            const poleType = document.getElementById('poleType').value;
            if (!poleType) {
                Swal.fire({
                    title: 'กรุณากรอกข้อมูล',
                    text: 'กรุณาเลือกประเภทเสา',
                    icon: 'warning',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                return;
            }
            
            isProcessing = true;
            
            // แสดง loading overlay
            showLoadingOverlay('กำลังบันทึกข้อมูล...');
            
            try {
                await saveCurrentPoint();
                currentPointNumber++;
                document.getElementById('currentPointDisplay').textContent = currentPointNumber;
                hidePointModal();
                hideLoadingOverlay();
                // <<< NEW: เปิดโหมดวัดระยะอีกครั้ง (กรณีถูกปิดตอนเปิด modal) 5555555
		enableLiveMeasure();

                Swal.fire({
                    title: 'เพิ่มจุดสำเร็จ!',
                    text: 'กรุณาเลือกตำแหน่งจุดถัดไปบนแผนที่',
                    icon: 'success',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                                    });
            } catch (error) {
                hideLoadingOverlay();
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้',
                    icon: 'error',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            } finally {
                isProcessing = false;
            }
        }
        
        function showLoadingOverlay(message) {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-8 text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-lg font-medium text-gray-700">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        let isProjectFinished = false;
        
        async function finishPoint() {
            const poleType = document.getElementById('poleType').value;
            if (!poleType) {
                Swal.fire({
                    title: 'กรุณากรอกข้อมูล',
                    text: 'กรุณาเลือกประเภทเสา',
                    icon: 'warning',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                return;
            }
            
            if (isProcessing) return;
            isProcessing = true;
            
            showLoadingOverlay('กำลังบันทึกข้อมูล...');
            
            try {
                // บันทึกจุดสุดท้าย
                await saveCurrentPoint();
                
                // ตั้งสถานะว่าโครงการเสร็จสิ้นแล้ว
                isProjectFinished = true;
                
                // ลบเส้นประวัดระยะทางและ event listeners ทันที
                clearAllDistanceElements();
                disableLiveMeasure(); // <<< NEW 44
                // ปิด Modal
                hidePointModal();
                hideLoadingOverlay();
                
                // แสดงข้อความแจ้งเตือนให้ผู้ใช้บันทึกข้อมูล
                Swal.fire({
                    title: 'เสร็จสิ้นการปักหมุด!',
                    text: 'กรุณากดปุ่ม "บันทึก" ที่แถบเมนูเพื่อบันทึกข้อมูลทั้งหมด',
                    icon: 'success',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
            } catch (error) {
                console.error('Error finishing point:', error);
                hideLoadingOverlay();
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            } finally {
                isProcessing = false;
            }
        }
        
        function clearDistanceLines() {
            // ล้างเส้นประวัดระยะทาง
            if (polyline && map) {
                try {
                    polyline.setLatLngs([]);
                } catch (error) {
                    console.error('Error clearing polyline:', error);
                }
            }
            
            // ล้างเส้นชั่วคราว
            if (tempLine && map) {
                try {
                    tempLine.setLatLngs([]);
                } catch (error) {
                    console.error('Error clearing temp line:', error);
                }
            }
            
            // ล้าง distance label
            if (distanceLabel && map) {
                try {
                    if (map.hasLayer(distanceLabel)) {
                        map.removeLayer(distanceLabel);
                    }
                    distanceLabel = null;
                } catch (error) {
                    console.error('Error removing distance label:', error);
                }
            }
        }
        
        function clearAllDistanceElements() {
            console.log('🧹 ล้างเส้นประวัดระยะทางและ event listeners ทั้งหมด...');
            
            // ล้างเส้นประวัดระยะทาง
            clearDistanceLines();
            
            // ลบ event listener สำหรับ mousemove
            if (map) {
                map.off('mousemove');
                console.log('✅ ลบ mousemove event listener แล้ว');
            }
            
            // รีเซ็ตตัวแปรที่เกี่ยวข้อง
            distanceLabel = null;
            
            // อัปเดตการแสดงผลระยะทาง
            document.getElementById('lastDistance').textContent = '0 ม.';
            
            console.log('🎉 ล้างเส้นประวัดระยะทางเสร็จสิ้น');
        }
        
        function showProjectCompletionOptions() {
            Swal.fire({
                title: 'สำรวจเสร็จสิ้น!',
                text: 'คุณต้องการทำอะไรกับข้อมูลที่สำรวจแล้ว?',
                icon: 'success',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: '💾 บันทึกข้อมูล',
                denyButtonText: '🗑️ ล้างข้อมูล',
                cancelButtonText: '📊 ดูแดชบอร์ด',
                confirmButtonColor: '#10b981',
                denyButtonColor: '#ef4444',
                cancelButtonColor: '#6366f1'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveAllData();
                } else if (result.isDenied) {
                    confirmClearData();
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    showDashboardModal();
                }
            });
        }
        
        function confirmClearDataFromNav() {
            if (surveyPoints.length === 0) {
                Swal.fire('ไม่มีข้อมูล', 'ไม่มีข้อมูลให้ล้าง', 'info');
                return;
            }
            
            Swal.fire({
                title: 'ยืนยันการล้างข้อมูล',
                text: `คุณแน่ใจหรือไม่ที่จะล้างข้อมูลทั้งหมด ${surveyPoints.length} จุดในการสำรวจนี้?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ล้างข้อมูล',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#ef4444',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((result) => {
                if (result.isConfirmed) {
                    resetSurveyData();
                    Swal.fire({
                        title: 'ล้างข้อมูลแล้ว!',
                        text: 'ข้อมูลสำรวจถูกล้างเรียบร้อยแล้ว',
                        icon: 'success',
                        confirmButtonText: 'ตกลง',
  			allowOutsideClick: false,
  			allowEscapeKey: false
                    });
                }
            });
        }
        
        function confirmClearData() {
            Swal.fire({
                title: 'ยืนยันการล้างข้อมูล',
                text: 'คุณแน่ใจหรือไม่ที่จะล้างข้อมูลทั้งหมดในการสำรวจนี้?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ล้างข้อมูล',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#ef4444',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((result) => {
                if (result.isConfirmed) {
                    resetSurveyData();
                    Swal.fire({
                        title: 'ล้างข้อมูลแล้ว!',
                        text: 'ข้อมูลสำรวจถูกล้างเรียบร้อยแล้ว',
                        icon: 'success',
                        confirmButtonText: 'ตกลง',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });
                }
            });
        }

        function cancelPoint() {
            hidePointModal();
        }

        async function saveCurrentPoint() {
            const center = map.getCenter();
            const lat = center.lat;
            const lng = center.lng;
            
            const connectionImageUrl = await uploadFile(document.getElementById('connectionImage').files[0]);
            const documentUrl = await uploadFile(document.getElementById('documentFile').files[0]);
            const pointImageUrl = await uploadFile(document.getElementById('pointImage').files[0]);
            
            const pointData = {
                pointNumber: currentPointNumber,
                lat: lat,
                lng: lng,
                poleType: document.getElementById('poleType').value,
                equipment: document.getElementById('equipment').value,
                poleHead: document.getElementById('poleHead').value,
                wireSupport: document.getElementById('wireSupport').value,
                notes: document.getElementById('notes').value,
                connectionImageUrl: connectionImageUrl,
                documentUrl: documentUrl,
                pointImageUrl: pointImageUrl,
                timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
            };
            
            surveyPoints.push(pointData);
            
            addMarkerToMap(lat, lng, currentPointNumber);
            calculateDistances();
            updateDistanceDisplay();
        }

        function addMarkerToMap(lat, lng, number) {
            // สร้าง custom icon ที่มีตัวเลข
            const customIcon = L.divIcon({
                className: 'marker-number',
                html: `<div class="marker-number">${number}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            marker.bindPopup(`จุดที่ ${number}<br>พิกัด: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            markers.push(marker);
            
            const points = surveyPoints.map(point => [point.lat, point.lng]);
            polyline.setLatLngs(points);
            
            // เพิ่มตัวเลขระยะทางบนเส้นประ
            if (surveyPoints.length >= 2) {
                const currentPoint = surveyPoints[surveyPoints.length - 1];
                const previousPoint = surveyPoints[surveyPoints.length - 2];
                const distance = calculateDistance(
                    previousPoint.lat, previousPoint.lng,
                    currentPoint.lat, currentPoint.lng
                );
                
                const midLat = (previousPoint.lat + currentPoint.lat) / 2;
                const midLng = (previousPoint.lng + currentPoint.lng) / 2;
                
                const distanceMarker = L.marker([midLat, midLng], {
                    icon: L.divIcon({
                        className: 'distance-marker',
                        html: `<div style="background: rgba(59, 130, 246, 0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; border: 1px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${Math.round(distance)} ม.</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(map);
                
                markers.push(distanceMarker);
            }
            
            // ล้างเส้นชั่วคราว
            tempLine.setLatLngs([]);
        }

        function calculateDistances() {
            if (surveyPoints.length < 2) {
                lastDistance = 0;
                totalDistance = 0;
                return;
            }
            
            const lastPoint = surveyPoints[surveyPoints.length - 1];
            const secondLastPoint = surveyPoints[surveyPoints.length - 2];
            
            lastDistance = calculateDistance(
                secondLastPoint.lat, secondLastPoint.lng,
                lastPoint.lat, lastPoint.lng
            );
            
            totalDistance = 0;
            for (let i = 1; i < surveyPoints.length; i++) {
                totalDistance += calculateDistance(
                    surveyPoints[i-1].lat, surveyPoints[i-1].lng,
                    surveyPoints[i].lat, surveyPoints[i].lng
                );
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateDistanceDisplay() {
            document.getElementById('lastDistance').textContent = `${Math.round(lastDistance)} ม.`;
            document.getElementById('totalDistance').textContent = `${Math.round(totalDistance)} ม.`;
            document.getElementById('totalPoints').textContent = surveyPoints.length;
        }

        async function uploadFile(file) {
            if (!file) return '';
            
            try {
                console.log('Uploading file:', file.name, 'Size:', file.size);
                
                const base64 = await fileToBase64(file);
                console.log('File converted to base64, length:', base64.length);
                
                const params = new URLSearchParams();
                params.append('action', 'uploadFile');
                params.append('fileName', file.name);
                params.append('fileData', base64);
                params.append('folderId', FOLDER_ID);
                params.append('surveyor', currentSurveyor);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                console.log('Upload result:', result);
                
                if (result.success) {
                    console.log('File uploaded successfully:', result.url);
                    return result.url;
                } else {
                    console.error('Upload failed:', result.error);
                    return '';
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                return '';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function clearMapElements() {
            console.log('Clearing map elements...');
            
            // ล้าง markers ทั้งหมด
            markers.forEach(marker => {
                try {
                    if (map && map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                } catch (error) {
                    console.error('Error removing marker:', error);
                }
            });
            markers = [];
            
            // ล้างเส้นประ
            if (polyline && map) {
                try {
                    polyline.setLatLngs([]);
                    if (map.hasLayer(polyline)) {
                        map.removeLayer(polyline);
                    }
                    // สร้างเส้นประใหม่
                    polyline = L.polyline([], {
                        color: '#3b82f6',
                        weight: 3,
                        dashArray: '5, 5'
                    }).addTo(map);
                } catch (error) {
                    console.error('Error clearing polyline:', error);
                }
            }
            
            // ล้างเส้นชั่วคราว
            if (tempLine && map) {
                try {
                    tempLine.setLatLngs([]);
                    if (map.hasLayer(tempLine)) {
                        map.removeLayer(tempLine);
                    }
                    // สร้างเส้นชั่วคราวใหม่
                    tempLine = L.polyline([], {
                        color: '#ef4444',
                        weight: 2,
                        dashArray: '3, 3',
                        opacity: 0.8
                    }).addTo(map);
                } catch (error) {
                    console.error('Error clearing temp line:', error);
                }
            }
            
            // ล้าง distance label
            if (distanceLabel && map) {
                try {
                    if (map.hasLayer(distanceLabel)) {
                        map.removeLayer(distanceLabel);
                    }
                    distanceLabel = null;
                } catch (error) {
                    console.error('Error removing distance label:', error);
                }
            }
            
            console.log('Map elements cleared successfully');
        }

        async function saveAllDataToSheets() {
            if (surveyPoints.length === 0) {
                throw new Error('ไม่มีข้อมูลให้บันทึก');
            }
            
            try {
                console.log('🔄 เริ่มบันทึกข้อมูลไปยัง Google Sheets...');
                
                // ตรวจสอบการเชื่อมต่อก่อน
                let isConnected = false;
                try {
                    const testResponse = await fetch(`${SCRIPT_URL}?action=test&timestamp=${Date.now()}`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    isConnected = testResponse.ok;
                } catch (error) {
                    console.log('⚠️ ไม่สามารถเชื่อมต่อ Google Sheets ได้');
                    isConnected = false;
                }
                
                if (!isConnected) {
                    // บันทึกข้อมูลในเครื่อง (Local Storage)
                    console.log('💾 บันทึกข้อมูลในเครื่องแทน...');
                    const projectData = {
                        surveyor: currentSurveyor,
                        project: currentProject,
                        points: surveyPoints,
                        totalDistance: totalDistance,
                        timestamp: new Date().toISOString(),
                        saved: false // ยังไม่ได้บันทึกไปยัง Google Sheets
                    };
                    
                    // บันทึกใน localStorage
                    const existingData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    existingData.push(projectData);
                    localStorage.setItem('surveyData', JSON.stringify(existingData));
                    
                    // แจ้งเตือนผู้ใช้
                    Swal.fire({
                        title: '💾 บันทึกในเครื่องแล้ว',
                        html: `
                            <p>ไม่สามารถเชื่อมต่อ Google Sheets ได้</p>
                            <p class="text-sm text-gray-600 mt-2">ข้อมูลถูกบันทึกในเครื่องชั่วคราว</p>
                            <div class="mt-3 p-3 bg-yellow-50 rounded">
                                <p class="text-sm text-yellow-700">
                                    <strong>หมายเหตุ:</strong> กรุณาส่งออกข้อมูลหรือเชื่อมต่อใหม่เพื่อบันทึกไปยัง Google Sheets
                                </p>
                            </div>
                        `,
                        icon: 'warning',
                        confirmButtonText: 'ตกลง'
                    });
                    
                    return true;
                }
                
                // ถ้าเชื่อมต่อได้ ให้บันทึกปกติ
                const mapImageUrl = await captureMapScreenshot();
                console.log('📸 จับภาพแผนที่:', mapImageUrl ? 'สำเร็จ' : 'ล้มเหลว');
                
                let savedCount = 0;
                for (let i = 0; i < surveyPoints.length; i++) {
                    const point = surveyPoints[i];
                    console.log(`💾 บันทึกจุดที่ ${i + 1}/${surveyPoints.length}...`);
                    
                    try {
                        const params = new URLSearchParams();
                        params.append('action', 'saveData');
                        params.append('surveyor', currentSurveyor);
                        params.append('project', currentProject);
                        params.append('pointNumber', point.pointNumber);
                        params.append('lat', point.lat);
                        params.append('lng', point.lng);
                        params.append('poleType', point.poleType);
                        params.append('equipment', point.equipment || '');
                        params.append('poleHead', point.poleHead || '');
                        params.append('wireSupport', point.wireSupport || '');
                        params.append('notes', point.notes || '');
                        params.append('timestamp', point.timestamp);
                        params.append('status', 'ยังไม่เขียนผัง');
                        params.append('mapImageUrl', mapImageUrl || '');
                        params.append('connectionImageUrl', point.connectionImageUrl || '');
                        params.append('documentUrl', point.documentUrl || '');
                        params.append('pointImageUrl', point.pointImageUrl || '');
                        
                        // เพิ่มการส่งลิงก์เอกสารไปยังคอลัมน์ O
                        if (point.documentUrl) {
                            params.append('documentLinkUrl', point.documentUrl);
                        }
                        
                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: params.toString()
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            savedCount++;
                            console.log(`✅ บันทึกจุดที่ ${i + 1} สำเร็จ`);
                        } else {
                            console.error(`❌ บันทึกจุดที่ ${i + 1} ล้มเหลว:`, result.error);
                        }
                        
                    } catch (pointError) {
                        console.error(`❌ ข้อผิดพลาดในการบันทึกจุดที่ ${i + 1}:`, pointError);
                    }
                }
                
                if (savedCount === surveyPoints.length) {
                    console.log('🎉 บันทึกข้อมูลทั้งหมดสำเร็จ!');
                    return true;
                } else {
                    throw new Error(`บันทึกได้เพียง ${savedCount}/${surveyPoints.length} จุด`);
                }
                
            } catch (error) {
                console.error('❌ ข้อผิดพลาดในการบันทึกข้อมูล:', error);
                throw error;
            }
        }

        async function saveAllData() {
            if (surveyPoints.length === 0) {
                Swal.fire('ไม่มีข้อมูล', 'กรุณาเพิ่มจุดสำรวจก่อนบันทึก', 'warning');
                return;
            }
            
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                await saveAllDataToSheets();
                
                Swal.fire({
                    title: 'บันทึกสำเร็จ!',
                    text: `บันทึกข้อมูล ${surveyPoints.length} จุดเรียบร้อยแล้ว`,
                    icon: 'success',
                    timer: 30000,
                    showConfirmButton: true
                });
                
                resetSurveyData();
                
            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message, 'error');
            }
        }

        async function captureMapScreenshot() {
            try {
                // ปรับมุมมองแผนที่ให้ครอบคลุมทุกจุดก่อน capture
                if (surveyPoints.length > 0) {
                    const latlngs = surveyPoints.map(point => [point.lat, point.lng]);
                    const group = L.featureGroup(markers);
                    
                    // ปรับ bounds ให้ครอบคลุมทุกจุด
                    if (markers.length > 0) {
                        const bounds = group.getBounds();
                        map.fitBounds(bounds, { padding: [20, 20] });
                    } else if (latlngs.length > 0) {
                        // ถ้าไม่มี markers ให้ใช้ coordinates
                        const bounds = L.latLngBounds(latlngs);
                        map.fitBounds(bounds, { padding: [20, 20] });
                    }
                    
                    // รอให้แผนที่ปรับตำแหน่งเสร็จ
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                const mapElement = document.getElementById('map');
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 1,
                    logging: false
                });
                
                const base64 = canvas.toDataURL('image/png').split(',')[1];
                const fileName = `map_${currentProject}_${Date.now()}.png`;
                
                const params = new URLSearchParams({
                    action: 'uploadFile',
                    fileName: fileName,
                    fileData: base64,
                    folderId: FOLDER_ID,
                    surveyor: currentSurveyor
                });
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                return result.success ? result.url : '';
            } catch (error) {
                console.error('Error capturing map screenshot:', error);
                return '';
            }
        }

        function resetSurveyData() {
            surveyPoints = [];
            currentPointNumber = 1;
            totalDistance = 0;
            lastDistance = 0;
            currentSurveyor = '';
            currentProject = '';
            isProjectFinished = false; // รีเซ็ตสถานะโครงการเสร็จสิ้น
            
            // ซ่อนข้อมูลโครงการ
            document.getElementById('currentProjectInfo').classList.add('hidden');
            document.getElementById('saveDataBtn').classList.add('hidden');
            document.getElementById('currentPointDisplay').textContent = '1';
            
            // ล้างแผนที่
            if (map) {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                if (polyline) {
                    polyline.setLatLngs([]);
                }
            }
            
            updateDistanceDisplay();
        }

        async function loadDashboardData() {
            try {
                Swal.fire({
                    title: 'กำลังโหลดข้อมูล...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // ลองโหลดจาก Google Sheets ก่อน
                let data = null;
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=getDashboardData&timestamp=${Date.now()}`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            data = result.data;
                            console.log('✅ โหลดข้อมูลจาก Google Sheets สำเร็จ');
                        }
                    }
                } catch (error) {
                    console.log('⚠️ ไม่สามารถโหลดจาก Google Sheets ได้:', error.message);
                }
                
                // ถ้าโหลดจาก Google Sheets ไม่ได้ ให้โหลดจาก localStorage
                if (!data) {
                    console.log('📱 โหลดข้อมูลจาก localStorage...');
                    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    
                    // แปลงข้อมูล localStorage ให้เป็นรูปแบบเดียวกับ Google Sheets
                    data = [];
                    localData.forEach(project => {
                        project.points.forEach(point => {
                            data.push([
                                project.surveyor,           // 0: surveyor
                                project.project,            // 1: project
                                point.pointNumber,          // 2: pointNumber
                                point.lat,                  // 3: lat
                                point.lng,                  // 4: lng
                                point.poleType,             // 5: poleType
                                point.equipment || '',      // 6: equipment
                                point.poleHead || '',       // 7: poleHead
                                point.wireSupport || '',    // 8: wireSupport
                                point.notes || '',          // 9: notes
                                point.timestamp,            // 10: timestamp
                                project.saved ? 'เขียนผังแล้ว' : 'ยังไม่เขียนผัง', // 11: status
                                '',                         // 12: mapImageUrl
                                point.connectionImageUrl || '', // 13: connectionImageUrl
                                point.documentUrl || '',    // 14: documentUrl
                                point.pointImageUrl || ''   // 15: pointImageUrl
                            ]);
                        });
                    });
                    
                    if (data.length > 0) {
                        console.log(`📊 พบข้อมูลใน localStorage: ${data.length} จุด`);
                    } else {
                        console.log('📭 ไม่พบข้อมูลใน localStorage');
                    }
                }
                
                // อัปเดตแดshboard
                allProjectData = data || [];
                filteredProjectData = [...allProjectData];
                updateDashboardDisplay(allProjectData);
                
                Swal.close();
                
                // แสดงข้อความแจ้งเตือนถ้าใช้ข้อมูลจาก localStorage
                if (data && data.length > 0 && !data.some(row => row[11] === 'เขียนผังแล้ว')) {
                    const localDataCount = JSON.parse(localStorage.getItem('surveyData') || '[]').length;
                    if (localDataCount > 0) {
                        Swal.fire({
                            title: '📱 ข้อมูลจากเครื่อง',
                            html: `
                                <p>แสดงข้อมูลที่บันทึกในเครื่อง</p>
                                <p class="text-sm text-gray-600 mt-2">พบ ${localDataCount} โครงการที่ยังไม่ได้ส่งไปยัง Google Sheets</p>
                                <div class="mt-3 p-3 bg-blue-50 rounded">
                                    <p class="text-sm text-blue-600">
                                        กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตเพื่อซิงค์ข้อมูล
                                    </p>
                                </div>
                            `,
                            icon: 'info',
                            confirmButtonText: 'ตกลง',
                            timer: 40000
                        });
                    }
                }
                
            } catch (error) {
                console.error('❌ ข้อผิดพลาดในการโหลดข้อมูลแดชบอร์ด:', error);
                Swal.close();
                
                // ลองโหลดจาก localStorage เป็นทางเลือกสุดท้าย
                try {
                    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    if (localData.length > 0) {
                        console.log('🔄 ใช้ข้อมูลสำรองจาก localStorage');
                        
                        const data = [];
                        localData.forEach(project => {
                            project.points.forEach(point => {
                                data.push([
                                    project.surveyor, project.project, point.pointNumber,
                                    point.lat, point.lng, point.poleType,
                                    point.equipment || '', point.poleHead || '', point.wireSupport || '',
                                    point.notes || '', point.timestamp, 'ยังไม่เขียนผัง',
                                    '', point.connectionImageUrl || '', point.documentUrl || '', point.pointImageUrl || ''
                                ]);
                            });
                        });
                        
                        allProjectData = data;
                        filteredProjectData = [...allProjectData];
                        updateDashboardDisplay(allProjectData);
                        
                        Swal.fire({
                            title: 'โหลดข้อมูลสำรอง',
                            text: 'แสดงข้อมูลที่บันทึกในเครื่อง',
                            icon: 'info',
                            confirmButtonText: 'ตกลง'
                        });
                    } else {
                        throw new Error('ไม่พบข้อมูล');
                    }
                } catch (localError) {
                    // แสดงแดชบอร์ดเปล่าแทนการแสดง error
                    allProjectData = [];
                    filteredProjectData = [];
                    updateDashboardDisplay([]);
                    
                    console.log('📭 ไม่พบข้อมูลในระบบ - แสดงแดชบอร์ดเปล่า');
                }
            }
        }

        function updateDashboardDisplay(data) {
            // ใช้ข้อมูลที่กรองแล้วสำหรับการคำนวณสถิติ
            const currentFilteredData = getCurrentFilteredData(data);
            
            const projects = [...new Set(currentFilteredData.map(row => row[1]).filter(p => p))];
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalPointsAll').textContent = currentFilteredData.length;
            
            const totalDistanceAll = currentFilteredData.reduce((sum, row, index) => {
                if (index > 0 && row[1] === currentFilteredData[index-1][1]) {
                    return sum + calculateDistance(
                        parseFloat(currentFilteredData[index-1][3]), parseFloat(currentFilteredData[index-1][4]),
                        parseFloat(row[3]), parseFloat(row[4])
                    );
                }
                return sum;
            }, 0);
            
            document.getElementById('totalDistanceAll').textContent = `${Math.round(totalDistanceAll).toLocaleString('th-TH')} ม.`;
            
            updateSurveyorStats(currentFilteredData, projects.length);
            updateSurveyorFilter(data); // ใช้ข้อมูลทั้งหมดสำหรับตัวกรอง
            updateYearFilter(data); // ใช้ข้อมูลทั้งหมดสำหรับตัวกรอง
            updateProjectTable(data);
        }
        
        function getCurrentFilteredData(data) {
            const yearFilter = document.getElementById('filterYear')?.value;
            
            if (!yearFilter || yearFilter === '') {
                return data;
            }
            
            return data.filter(row => {
                if (!row[10]) return false; // ไม่มีข้อมูลวันที่
                try {
                    let date;
                    
                    // ตรวจสอบรูปแบบวันที่
                    if (row[10].includes('/')) {
                        const parts = row[10].split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            let year = parseInt(parts[2]);
                            
                            // แก้ไขปีที่ผิดพลาด (3111 -> 2568)
                            if (year === 3111) {
                                year = 2568;
                            }
                            
                            // แปลงปี พ.ศ. เป็น ค.ศ. ถ้าจำเป็น
                            const actualYear = year > 2500 ? year - 543 : year;
                            date = new Date(actualYear, month, day);
                            
                            // เปรียบเทียบกับปี พ.ศ.
                            const dataYear = year > 2500 ? year : year;
                            return dataYear.toString() === yearFilter;
                        }
                    } else {
                        date = new Date(row[10]);
                        if (date && !isNaN(date.getTime())) {
                            const dataYear = date.getFullYear(); // แปลงเป็น พ.ศ.
                            return dataYear.toString() === yearFilter;
                        }
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            });
        }
        
        function updateSurveyorStats(data, totalProjects) {
            const surveyorProjects = {};
            
            // นับโครงการของแต่ละผู้สำรวจ
            const projects = [...new Set(data.map(row => row[1]).filter(p => p))];
            projects.forEach(project => {
                const projectData = data.find(row => row[1] === project);
                if (projectData && projectData[0]) {
                    const surveyor = projectData[0];
                    surveyorProjects[surveyor] = (surveyorProjects[surveyor] || 0) + 1;
                }
            });
            
            const statsContainer = document.getElementById('surveyorStats');
            statsContainer.innerHTML = '';
            
            // เรียงลำดับตามเปอร์เซ็นต์จากมากไปหาน้อย
            const sortedSurveyors = Object.entries(surveyorProjects).sort((a, b) => {
                const percentageA = totalProjects > 0 ? ((a[1] / totalProjects) * 100) : 0;
                const percentageB = totalProjects > 0 ? ((b[1] / totalProjects) * 100) : 0;
                return percentageB - percentageA;
            });
            
            // สร้างการ์ดสำหรับแต่ละผู้สำรวจ
            sortedSurveyors.forEach(([surveyor, projectCount]) => {
                const percentage = totalProjects > 0 ? ((projectCount / totalProjects) * 100).toFixed(1) : 0;
                
                const card = document.createElement('div');
                card.className = 'dashboard-panel p-4 text-center';
                card.innerHTML = `
                    <div class="text-2xl mb-2">👤</div>
                    <h4 class="font-semibold text-gray-800 mb-2 text-sm">${surveyor}</h4>
                    <div class="text-2xl font-bold text-blue-600 mb-1">${projectCount}</div>
                    <div class="text-xs text-gray-600">โครงการ</div>
                    <div class="text-sm font-medium text-green-600 mt-2">${percentage}%</div>
                `;
                
                statsContainer.appendChild(card);
            });
        }

        let currentPage = 1;
        const itemsPerPage = 20;
        let currentProjectSummary = {};
        let sortColumn = '';
        let sortDirection = 'asc';
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            const projects = Object.entries(currentProjectSummary);
            
            projects.sort((a, b) => {
                let valueA, valueB;
                
                switch (column) {
                    case 'index':
                        return sortDirection === 'asc' ? 0 : 0; // ไม่เรียงลำดับ
                    case 'surveyor':
                        valueA = a[1].surveyor;
                        valueB = b[1].surveyor;
                        break;
                    case 'project':
                        valueA = a[0];
                        valueB = b[0];
                        break;
                    case 'distance':
                        valueA = a[1].distance;
                        valueB = b[1].distance;
                        break;
                    case 'status':
                        valueA = a[1].status;
                        valueB = b[1].status;
                        break;
                    case 'date':
                        valueA = a[1].date || '';
                        valueB = b[1].date || '';
                        break;
                    default:
                        return 0;
                }
                
                if (typeof valueA === 'number' && typeof valueB === 'number') {
                    return sortDirection === 'asc' ? valueA - valueB : valueB - valueA;
                } else {
                    const comparison = String(valueA).localeCompare(String(valueB), 'th');
                    return sortDirection === 'asc' ? comparison : -comparison;
                }
            });
            
            // อัปเดต currentProjectSummary ด้วยลำดับใหม่
            const sortedSummary = {};
            projects.forEach(([project, summary]) => {
                sortedSummary[project] = summary;
            });
            currentProjectSummary = sortedSummary;
            
            currentPage = 1;
            renderTablePage();
        }
        
        function updateProjectTable(data) {
            filteredProjectData = data;
            
            const projectSummary = {};
            
            data.forEach(row => {
                const project = row[1];
                
                if (!projectSummary[project]) {
                    projectSummary[project] = {
                        projectName: project,
                        surveyor: row[0],
                        distance: 0,
                        status: row[11] || 'ยังไม่เขียนผัง',
                        mapImageUrl: row[12] || '',
                        connectionImageUrl: row[13] || '',
                        documentUrl: row[14] || '',
                        date: row[10] || ''
                    };
                }
                
                // คำนวณระยะทางสำหรับโครงการนี้
                const projectData = data.filter(d => d[1] === project);
                let totalDistance = 0;
                for (let i = 1; i < projectData.length; i++) {
                    totalDistance += calculateDistance(
                        parseFloat(projectData[i-1][3]), parseFloat(projectData[i-1][4]),
                        parseFloat(projectData[i][3]), parseFloat(projectData[i][4])
                    );
                }
                projectSummary[project].distance = totalDistance;
            });
            
            currentProjectSummary = projectSummary;
            currentPage = 1;
            renderTablePage();
        }
        
        function renderTablePage() {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';
            
            const projects = Object.entries(currentProjectSummary);
            const totalPages = Math.ceil(projects.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentProjects = projects.slice(startIndex, endIndex);
            
            currentProjects.forEach(([projectKey, summary], index) => {
                const globalIndex = startIndex + index + 1;
                
                // ใช้ projectName แทน project key
                const projectName = summary.projectName;
                
                // ตัดชื่อโครงการถ้ายาวเกิน 30 ตัวอักษร
                const truncatedProject = projectName.length > 30 ? projectName.substring(0, 30) + '...' : projectName;
                
                // จัดรูปแบบวันที่
                let formattedDate = '-';
                if (summary.date) {
                    try {
                        // ตรวจสอบรูปแบบวันที่ที่เป็นไปได้
                        let date;
                        
                        // ถ้าเป็นรูปแบบ DD/MM/YYYY
                        if (summary.date.includes('/')) {
                            const parts = summary.date.split(' ')[0].split('/'); // เอาเฉพาะส่วนวันที่
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // JavaScript month เริ่มจาก 0
                                let year = parseInt(parts[2]);
                                
                                // แก้ไขปีที่ผิดพลาด (3111 -> 2568)
                                if (year === 3111) {
                                    year = 2568;
                                }
                                
                                // แปลงปี พ.ศ. เป็น ค.ศ. ถ้าจำเป็น
                                const actualYear = year > 2500 ? year - 543 : year;
                                date = new Date(actualYear, month, day);
                                
                                // แสดงวันที่ในรูปแบบ DD/MM/YYYY (พ.ศ.)
                                const formattedDay = date.getDate().toString().padStart(2, '0');
                                const formattedMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                                const formattedYear = year > 2500 ? year : year; // ใช้ปี พ.ศ.
                                formattedDate = `${formattedDay}/${formattedMonth}/${formattedYear}`;
                            }
                        } else {
                            // ลองแปลงแบบปกติ
                            date = new Date(summary.date);
                            if (date && !isNaN(date.getTime())) {
                                const day = date.getDate().toString().padStart(2, '0');
                                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                                const year = date.getFullYear(); // แปลงเป็น พ.ศ.
                                formattedDate = `${day}/${month}/${year}`;
                            }
                        }
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        formattedDate = summary.date; // แสดงข้อมูลเดิมถ้าแปลงไม่ได้
                    }
                }
                
                // จัดรูปแบบระยะทางให้มีเครื่องหมายจุลภาค
                const formattedDistance = Math.round(summary.distance).toLocaleString('th-TH');
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm">${globalIndex}</td>
                    <td class="px-6 py-4 text-sm">${summary.surveyor}</td>
                    <td class="px-6 py-4 text-sm font-medium" title="${projectName}">${truncatedProject}</td>
                    <td class="px-6 py-4 text-sm">${formattedDistance}</td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.mapImageUrl ? `
                            <a href="javascript:void(0)" onclick="showImagePreview('${encodeURIComponent(summary.mapImageUrl)}')" 
                               onmouseover="showHoverImage(event, '${encodeURIComponent(summary.mapImageUrl)}')" 
                               onmouseout="hideHoverImage()" 
                               class="text-blue-600 hover:underline">🗺️ ดูภาพ</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.connectionImageUrl ? `
                            <a href="javascript:void(0)" onclick="showImagePreview('${encodeURIComponent(summary.connectionImageUrl)}')" 
                               onmouseover="showHoverImage(event, '${encodeURIComponent(summary.connectionImageUrl)}')" 
                               onmouseout="hideHoverImage()" 
                               class="text-blue-600 hover:underline">📷 ดูภาพ</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        ${summary.documentUrl ? `
                            <a href="${summary.documentUrl}" target="_blank" rel="noopener noreferrer" 
                               class="text-blue-600 hover:underline">📄 ดูเอกสาร</a>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <select class="text-sm p-2 border rounded-lg" onchange="updateProjectStatus('${projectName}', this.value)">
                            <option value="ยังไม่เขียนผัง" ${summary.status === 'ยังไม่เขียนผัง' ? 'selected' : ''}>ยังไม่เขียนผัง</option>
                            <option value="เขียนผังแล้ว" ${summary.status === 'เขียนผังแล้ว' ? 'selected' : ''}>เขียนผังแล้ว</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-sm">${formattedDate}</td>
                    <td class="px-6 py-4 text-sm">
                        <button class="download-kml bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium"
        data-project="${projectName}">
  📥 KML
</button>

                    </td>
                `;
                tbody.appendChild(row);
            });
            
            renderPagination(totalPages);
        }
        
        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) {
                const container = document.createElement('div');
                container.id = 'paginationContainer';
                container.className = 'flex justify-center items-center space-x-2 p-4 bg-gray-50';
                document.getElementById('tableContainer').appendChild(container);
            }
            
            const pagination = document.getElementById('paginationContainer');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // ปุ่มก่อนหน้า
            const prevBtn = document.createElement('button');
            prevBtn.className = `px-3 py-2 rounded-lg text-sm font-medium ${currentPage === 1 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            prevBtn.textContent = '← ก่อนหน้า';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTablePage();
                }
            };
            pagination.appendChild(prevBtn);
            
            // หมายเลขหน้า
            const pageInfo = document.createElement('span');
            pageInfo.className = 'px-4 py-2 text-sm text-gray-700';
            pageInfo.textContent = `หน้า ${currentPage} จาก ${totalPages}`;
            pagination.appendChild(pageInfo);
            
            // ปุ่มถัดไป
            const nextBtn = document.createElement('button');
            nextBtn.className = `px-3 py-2 rounded-lg text-sm font-medium ${currentPage === totalPages ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`;
            nextBtn.textContent = 'ถัดไป →';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTablePage();
                }
            };
            pagination.appendChild(nextBtn);
        }
        
        function showHoverImage(event, encodedImageUrl) {
            try {
                let imageUrl = decodeURIComponent(encodedImageUrl);
                
                // ตรวจสอบและแปลง Google Drive URL
                if (imageUrl.includes('drive.google.com/uc?export=view&id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s800`;
                    }
                } else if (imageUrl.includes('drive.google.com/uc?id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s800`;
                    }
                } else if (imageUrl.includes('drive.google.com')) {
                    const fileIdMatch = imageUrl.match(/\/d\/([a-zA-Z0-9-_]+)/) || imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s800`;
                    }
                }
                
                console.log('Showing hover image:', imageUrl);
                
                // ลบ hover image เก่า
                hideHoverImage();
                
                const hoverImg = document.createElement('img');
                hoverImg.id = 'hoverImage';
                hoverImg.className = 'hover-image';
                hoverImg.style.cssText = `
                    position: absolute;
                    z-index: 15000;
                    left: ${event.pageX + 10}px;
                    top: ${event.pageY + 10}px;
                    max-width: 300px;
                    max-height: 200px;
                    object-fit: contain;
                    border: 2px solid white;
                    border-radius: 8px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    background-color: white;
                    padding: 4px;
                    pointer-events: none;
                    display: block;
                `;
                
                // จัดการ error
                hoverImg.onerror = function() {
                    console.error('Failed to load hover image:', imageUrl);
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y3ZjdmNyIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiPuC5hOC4oeC5iOC4quC4suC4oeC4suC4o+C4luC5guC4q+C4peC4lOC4oOC4suC4nuC5hOC4lOC5iDwvdGV4dD48L3N2Zz4=';
                    this.alt = 'ไม่สามารถโหลดภาพได้';
                };
                
                hoverImg.onload = function() {
                    console.log('Hover image loaded successfully');
                };
                
                hoverImg.src = imageUrl;
                document.body.appendChild(hoverImg);
                
            } catch (error) {
                console.error('Error in showHoverImage:', error);
            }
        }
        
        function hideHoverImage() {
            const hoverImg = document.getElementById('hoverImage');
            if (hoverImg) {
                hoverImg.remove();
            }
        }
        
        function showImagePreview(encodedImageUrl) {
            try {
                let imageUrl = decodeURIComponent(encodedImageUrl);
                
                // ตรวจสอบและแปลง Google Drive URL
                if (imageUrl.includes('drive.google.com/uc?export=view&id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s1600`;
                    }
                } else if (imageUrl.includes('drive.google.com/uc?id=')) {
                    const fileIdMatch = imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s1600`;
                    }
                } else if (imageUrl.includes('drive.google.com')) {
                    const fileIdMatch = imageUrl.match(/\/d\/([a-zA-Z0-9-_]+)/) || imageUrl.match(/id=([a-zA-Z0-9-_]+)/);
                    if (fileIdMatch) {
                        imageUrl = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}=s1600`;
                    }
                }
                
                console.log('Showing image preview:', imageUrl);
                
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 20000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const img = document.createElement('img');
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                `;
                img.alt = 'ภาพตัวอย่าง';
                
                img.onerror = function() {
                    console.error('Failed to load preview image:', imageUrl);
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y3ZjdmNyIvPjx0ZXh0IHg9IjIwMCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTk5OTkiPuC5hOC4oeC5iOC4quC4suC4oeC4suC4o+C4luC5guC4q+C4peC4lOC4oOC4suC4nuC5hOC4lOC5iDwvdGV4dD48L3N2Zz4=';
                    this.alt = 'ไม่สามารถโหลดภาพได้';
                };
                
                img.onload = function() {
                    console.log('Preview image loaded successfully');
                };
                
                img.src = imageUrl;
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'image-preview-close';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    font-size: 20px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                closeBtn.textContent = '×';
                closeBtn.onclick = closeImagePreview;
                
                preview.appendChild(closeBtn);
                preview.appendChild(img);
                preview.onclick = function(e) {
                    if (e.target === preview) {
                        closeImagePreview();
                    }
                };
                
                document.body.appendChild(preview);
                
            } catch (error) {
                console.error('Error in showImagePreview:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถแสดงภาพได้', 'error');
            }
        }
        
        function closeImagePreview() {
            const preview = document.querySelector('.image-preview');
            if (preview) {
                preview.remove();
            }
        }

        function updateSurveyorFilter(data) {
            const filterSelect = document.getElementById('filterSurveyor');
            const currentValue = filterSelect.value;
            const surveyors = [...new Set(data.map(row => row[0]).filter(s => s))];
            
            filterSelect.innerHTML = '<option value="">ทั้งหมด</option>';
            surveyors.forEach(surveyor => {
                const selected = surveyor === currentValue ? 'selected' : '';
                filterSelect.innerHTML += `<option value="${surveyor}" ${selected}>${surveyor}</option>`;
            });
        }
        
        function updateYearFilter(data) {
            const filterSelect = document.getElementById('filterYear');
            const currentValue = filterSelect.value;
            const years = new Set();
            
            data.forEach(row => {
                if (row[10]) { // คอลัมน์วันที่
                    try {
                        const date = new Date(row[10]);
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            if (year >= 2020 && year <= 2030) { // จำกัดช่วงปีที่สมเหตุสมผล
                                years.add(year);
                            }
                        }
                    } catch (error) {
                        // ข้ามข้อมูลที่ไม่ถูกต้อง
                    }
                }
            });
            
            // เพิ่มปี 2568 เป็นค่าเริ่มต้น
            years.add(2568);
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            filterSelect.innerHTML = '<option value="">ทุกปี</option>';
            sortedYears.forEach(year => {
                const selected = (year.toString() === currentValue || (!currentValue && year === 2568)) ? 'selected' : '';
                filterSelect.innerHTML += `<option value="${year}" ${selected}>${year}</option>`;
            });
            
            // ตั้งค่าเริ่มต้นเป็น 2568 ถ้ายังไม่มีการเลือก
            if (!currentValue && sortedYears.includes(2568)) {
                filterSelect.value = '2568';
            }
        }

        function filterTable() {
            const surveyorFilter = document.getElementById('filterSurveyor').value;
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const yearFilter = document.getElementById('filterYear').value;
            
            let filteredData = [...allProjectData];
            
            // กรองตามผู้สำรวจ
            if (surveyorFilter && surveyorFilter !== '' && surveyorFilter !== 'ทั้งหมด') {
                filteredData = filteredData.filter(row => row[0] === surveyorFilter);
            }
            
            // กรองตามคำค้นหา
            if (searchTerm && searchTerm !== '') {
                filteredData = filteredData.filter(row => 
                    row[1] && row[1].toString().toLowerCase().includes(searchTerm)
                );
            }
            
            // กรองตามปี (ใช้ Range Slider)
            if (yearFilter && yearFilter !== '') {
                filteredData = filteredData.filter(row => {
                    if (!row[10]) return false; // ไม่มีข้อมูลวันที่
                    try {
                        let date;
                        
                        // ตรวจสอบรูปแบบวันที่
                        if (row[10].includes('/')) {
                            const parts = row[10].split(' ')[0].split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1;
                                let year = parseInt(parts[2]);
                                
                                // แก้ไขปีที่ผิดพลาด (3111 -> 2568)
                                if (year === 3111) {
                                    year = 2568;
                                }
                                
                                // แปลงปี พ.ศ. เป็น ค.ศ. ถ้าจำเป็น
                                const actualYear = year > 2500 ? year - 543 : year;
                                date = new Date(actualYear, month, day);
                                
                                // เปรียบเทียบกับปี พ.ศ.
                                const dataYear = year > 2500 ? year : year;
                                return dataYear.toString() === yearFilter;
                            }
                        } else {
                            date = new Date(row[10]);
                            if (date && !isNaN(date.getTime())) {
                                const dataYear = date.getFullYear(); // แปลงเป็น พ.ศ.
                                return dataYear.toString() === yearFilter;
                            }
                        }
                        return false;
                    } catch (error) {
                        return false;
                    }
                });
            }
            
            // อัปเดตสถิติด้วยข้อมูลที่กรองแล้ว
            updateDashboardStats(filteredData);
            updateProjectTable(filteredData);
        }
        
        function updateDashboardStats(data) {
            const projects = [...new Set(data.map(row => row[1]).filter(p => p))];
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalPointsAll').textContent = data.length;
            
            const totalDistanceAll = data.reduce((sum, row, index) => {
                if (index > 0 && row[1] === data[index-1][1]) {
                    return sum + calculateDistance(
                        parseFloat(data[index-1][3]), parseFloat(data[index-1][4]),
                        parseFloat(row[3]), parseFloat(row[4])
                    );
                }
                return sum;
            }, 0);
            
            document.getElementById('totalDistanceAll').textContent = `${Math.round(totalDistanceAll).toLocaleString('th-TH')} ม.`;
            
            updateSurveyorStats(data, projects.length);
        }

        function updateYearDisplay() {
            const yearSlider = document.getElementById('filterYear');
            const yearDisplay = document.getElementById('yearDisplay');
            if (yearSlider && yearDisplay) {
                yearDisplay.textContent = yearSlider.value;
            }
        }
        
        function clearFilters() {
            document.getElementById('filterSurveyor').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('filterYear').value = '2568'; // ตั้งค่าเริ่มต้นเป็น 2568
            updateYearDisplay();
            filterTable();
        }

        function toggleTable() {
            const tableContainer = document.getElementById('tableContainer');
            const toggleBtn = document.getElementById('toggleTableBtn');
            const dashboardPanel = tableContainer.closest('.dashboard-panel');
            
            if (!tableContainer || !toggleBtn) {
                console.error('Table container or toggle button not found');
                return;
            }
            
            if (isTableExpanded) {
                // ย่อตาราง
                tableContainer.style.maxHeight = '400px';
                tableContainer.style.overflow = 'auto';
                dashboardPanel.style.position = 'static';
                dashboardPanel.style.zIndex = 'auto';
                dashboardPanel.style.width = 'auto';
                dashboardPanel.style.height = 'auto';
                toggleBtn.innerHTML = '📋 ขยายตาราง';
                isTableExpanded = false;
            } else {
                // ขยายตารางเต็มจอ
                tableContainer.style.maxHeight = 'calc(100vh - 200px)';
                tableContainer.style.overflow = 'auto';
                dashboardPanel.style.position = 'fixed';
                dashboardPanel.style.top = '20px';
                dashboardPanel.style.left = '20px';
                dashboardPanel.style.right = '20px';
                dashboardPanel.style.bottom = '20px';
                dashboardPanel.style.zIndex = '25000';
                dashboardPanel.style.width = 'calc(100vw - 40px)';
                dashboardPanel.style.height = 'calc(100vh - 40px)';
                toggleBtn.innerHTML = '📋 ย่อตาราง';
                isTableExpanded = true;
            }
        }

        async function updateProjectStatus(project, status) {
  try {
    showLoadingOverlay('กำลังอัปเดตสถานะ...');

    // 1) พยายามอัปเดตลง Google Sheets ก่อน
    let updatedInSheets = false;
    try {
      const params = new URLSearchParams({
        action: 'updateStatus',
        project: project,
        status: status,
        sheetId: SHEET_ID   // <<< ส่ง sheetId ไปฝั่ง Apps Script
      });

      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString()
      });

      // บางครั้ง GAS อาจส่ง text ธรรมดา กลับมาแทน JSON — เรารองรับทั้งสองกรณี
      const raw = await response.text();
      let result = {};
      try { result = JSON.parse(raw); } catch (_) { /* not JSON */ }

      // ยอมรับทั้งรูปแบบ {success:true} หรือ {status:"ok"} หรือแม้กระทั่งข้อความมีคำว่า ok/success
      updatedInSheets =
        (result && (result.success === true || result.status === 'ok')) ||
        /"success"\s*:\s*true/i.test(raw) ||
        /\bok\b|\bsuccess\b/i.test(raw);
    } catch (err) {
      console.log('อัปเดต Google Sheets ล้มเหลว:', err);
    }

    // 2) อัปเดตข้อมูลในหน่วยความจำของแอป (แดชบอร์ด)
    allProjectData.forEach(row => {
      if (row[1] === project) {
        row[11] = status; // คอลัมน์ L (index 11) = Status
      }
    });

    // 3) อัปเดตใน localStorage ถ้ามี
    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
    const projectIndex = localData.findIndex(p => p.project === project);
    if (projectIndex !== -1) {
      localData[projectIndex].saved = (status === 'เขียนผังแล้ว');
      localStorage.setItem('surveyData', JSON.stringify(localData));
    }

    // 4) รีเฟรชตารางแดชบอร์ด
    updateProjectTable(allProjectData);

    hideLoadingOverlay();

    // 5) แจ้งผลแบบ "ต้องกดเอง" (ไม่มี timer)
    const message = updatedInSheets
      ? 'อัปเดตสถานะงานเรียบร้อยแล้ว'
      : 'อัปเดตสถานะในเครื่องเรียบร้อยแล้ว (ยังไม่ได้ซิงค์กับ Google Sheets)';

    Swal.fire({
      title: 'อัปเดตสำเร็จ!',
      text: message,
      icon: 'success',
      confirmButtonText: 'ตกลง',
      allowOutsideClick: false,
      allowEscapeKey: false
    });
  } catch (error) {
    hideLoadingOverlay();
    Swal.fire({
      title: 'เกิดข้อผิดพลาด',
      text: 'ไม่สามารถอัปเดตสถานะได้: ' + (error?.message || ''),
      icon: 'error',
      confirmButtonText: 'ตกลง',
      allowOutsideClick: false,
      allowEscapeKey: false
    });
  }
}


        async function exportLocalData() {
            try {
                const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                
                if (localData.length === 0) {
                    Swal.fire('ไม่มีข้อมูล', 'ไม่มีข้อมูลในเครื่องให้ส่งออก', 'info');
                    return;
                }
                
                const result = await Swal.fire({
                    title: 'ส่งออกข้อมูล',
                    html: `
                        <p>พบข้อมูล ${localData.length} โครงการในเครื่อง</p>
                        <p class="text-sm text-gray-600 mt-2">เลือกรูปแบบการส่งออก:</p>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: '📄 ส่งออก JSON',
                    denyButtonText: '📊 ส่งออก CSV',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#3b82f6',
                    denyButtonColor: '#10b981'
                });
                
                if (result.isConfirmed) {
                    // ส่งออกเป็น JSON
                    exportAsJSON(localData);
                } else if (result.isDenied) {
                    // ส่งออกเป็น CSV
                    exportAsCSV(localData);
                }
                
            } catch (error) {
                console.error('Error exporting data:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถส่งออกข้อมูลได้', 'error');
            }
        }
        
        function exportAsJSON(data) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            Swal.fire({
                title: 'ส่งออกสำเร็จ!',
                text: 'ไฟล์ JSON ถูกดาวน์โหลดเรียบร้อยแล้ว',
                icon: 'success',
                confirmButtonText: 'ตกลง'
            });
        }
        
        function exportAsCSV(data) {
            let csvContent = 'ผู้สำรวจ,ชื่องาน,จุดที่,ละติจูด,ลองจิจูด,ประเภทเสา,อุปกรณ์,หัวเสา,สายยึดโยง,หมายเหตุ,วันที่บันทึก,สถานะ\n';
            
            data.forEach(project => {
                project.points.forEach(point => {
                    const row = [
                        project.surveyor,
                        project.project,
                        point.pointNumber,
                        point.lat,
                        point.lng,
                        point.poleType,
                        point.equipment || '',
                        point.poleHead || '',
                        point.wireSupport || '',
                        point.notes || '',
                        point.timestamp,
                        project.saved ? 'เขียนผังแล้ว' : 'ยังไม่เขียนผัง'
                    ].map(field => `"${field}"`).join(',');
                    csvContent += row + '\n';
                });
            });
            
            // เพิ่ม BOM สำหรับ UTF-8
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            Swal.fire({
                title: 'ส่งออกสำเร็จ!',
                text: 'ไฟล์ CSV ถูกดาวน์โหลดเรียบร้อยแล้ว',
                icon: 'success',
                timer: 20000,
                showConfirmButton: false
            });
        }

        async function downloadKML(project) {
            try {
                showLoadingOverlay('กำลังสร้างไฟล์ KML...');
                
               // ลองดาวน์โหลดจาก Google Sheets ก่อน (รองรับทั้ง JSON และ KML ตรงๆ)
try {
  const response = await fetch(`${SCRIPT_URL}?action=generateKML&project=${encodeURIComponent(project)}`);
  const raw = await response.text();

  // พยายาม parse เป็น JSON ก่อน
  let data = null;
  try { data = JSON.parse(raw); } catch (_) {}

  let kmlPayload = null;

  if (data && data.success && typeof data.kml === 'string' && data.kml.trim()) {
    // เคส: Apps Script ส่ง JSON { success:true, kml:"..." }
    kmlPayload = data.kml;
  } else if (/^\s*<\?xml[\s\S]*<kml[\s\S]*<\/kml>\s*$/i.test(raw) || /^\s*<kml[\s\S]*<\/kml>\s*$/i.test(raw)) {
    // เคส: ส่ง KML เป็น XML ตรงๆ
    kmlPayload = raw;
  }

  if (kmlPayload) {
    const blob = new Blob([kmlPayload], { type: 'application/vnd.google-earth.kml+xml' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${project}.kml`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    hideLoadingOverlay();

    Swal.fire({
      title: 'ดาวน์โหลดสำเร็จ!',
      text: 'ไฟล์ KML ถูกดาวน์โหลดเรียบร้อยแล้ว',
      icon: 'success',
      confirmButtonText: 'ตกลง',
      allowOutsideClick: false
    });
    return;
  }
} catch (error) {
  console.log('ไม่สามารถดาวน์โหลดจาก Google Sheets ได้:', error?.message || error);
}

                
                // สร้าง KML จากข้อมูลในแดชบอร์ด
                const projectPoints = allProjectData.filter(row => row[1] === project);
                
                if (projectPoints.length === 0) {
                    // ลองหาจาก localStorage
                    const localData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                    const projectData = localData.find(p => p.project === project);
                    
                    if (!projectData) {
                        throw new Error('ไม่พบข้อมูลโครงการ');
                    }
                    
                    const kmlContent = generateKMLFromLocalData(projectData);
                    downloadKMLFile(kmlContent, project);
                } else {
                    // สร้าง KML จากข้อมูลในแดชบอร์ด
                    const kmlContent = generateKMLFromDashboardData(projectPoints);
                    downloadKMLFile(kmlContent, project);
                }
                
                hideLoadingOverlay();
                
                Swal.fire({
                    title: 'ดาวน์โหลดสำเร็จ!',
                    text: 'ไฟล์ KML ถูกสร้างเรียบร้อยแล้ว',
                    icon: 'success',
                    confirmButtonText: 'ตกลง',
  			allowOutsideClick: false
                });
                
            } catch (error) {
                console.error('Error downloading KML:', error);
                hideLoadingOverlay();
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดาวน์โหลดไฟล์ KML ได้: ' + error.message, 'error');
            }
        }
        
        function downloadKMLFile(kmlContent, project) {
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project}.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function generateKMLFromDashboardData(projectPoints) {
            if (projectPoints.length === 0) return '';
            
            const surveyor = projectPoints[0][0];
            const project = projectPoints[0][1];
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${project}</name>
    <description>โครงการสำรวจขยายเขต - ${surveyor}</description>
    
    <Style id="poleStyle">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="lineStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>3</width>
      </LineStyle>
    </Style>
    
    <Placemark>
      <name>เส้นทางสำรวจ</name>
      <styleUrl>#lineStyle</styleUrl>
      <LineString>
        <coordinates>`;
        
            // เรียงลำดับจุดตามหมายเลข
            projectPoints.sort((a, b) => parseInt(a[2]) - parseInt(b[2]));
            
            projectPoints.forEach(point => {
                kml += `${point[4]},${point[3]},0 `;
            });
            
            kml += `</coordinates>
      </LineString>
    </Placemark>`;
    
            projectPoints.forEach(point => {
                kml += `
    <Placemark>
      <name>จุดที่ ${point[2]}</name>
      <description><![CDATA[
        <b>ประเภทเสา:</b> ${point[5]}<br/>
        <b>อุปกรณ์:</b> ${point[6] || 'ไม่ระบุ'}<br/>
        <b>หัวเสา:</b> ${point[7] || 'ไม่ระบุ'}<br/>
        <b>สายยึดโยง:</b> ${point[8] || 'ไม่ระบุ'}<br/>
        <b>หมายเหตุ:</b> ${point[9] || 'ไม่มี'}<br/>
        <b>วันที่บันทึก:</b> ${point[10]}
      ]]></description>
      <styleUrl>#poleStyle</styleUrl>
      <Point>
        <coordinates>${point[4]},${point[3]},0</coordinates>
      </Point>
    </Placemark>`;
            });
            
            kml += `
  </Document>
</kml>`;
            
            return kml;
        }
        
        function generateKMLFromLocalData(projectData) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${projectData.project}</name>
    <description>โครงการสำรวจขยายเขต - ${projectData.surveyor}</description>
    
    <Style id="poleStyle">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="lineStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>3</width>
      </LineStyle>
    </Style>
    
    <Placemark>
      <name>เส้นทางสำรวจ</name>
      <styleUrl>#lineStyle</styleUrl>
      <LineString>
        <coordinates>`;
        
            projectData.points.forEach(point => {
                kml += `${point.lng},${point.lat},0 `;
            });
            
            kml += `</coordinates>
      </LineString>
    </Placemark>`;
    
            projectData.points.forEach(point => {
                kml += `
    <Placemark>
      <name>จุดที่ ${point.pointNumber}</name>
      <description><![CDATA[
        <b>ประเภทเสา:</b> ${point.poleType}<br/>
        <b>อุปกรณ์:</b> ${point.equipment || 'ไม่ระบุ'}<br/>
        <b>หัวเสา:</b> ${point.poleHead || 'ไม่ระบุ'}<br/>
        <b>สายยึดโยง:</b> ${point.wireSupport || 'ไม่ระบุ'}<br/>
        <b>หมายเหตุ:</b> ${point.notes || 'ไม่มี'}<br/>
        <b>วันที่บันทึก:</b> ${point.timestamp}
      ]]></description>
      <styleUrl>#poleStyle</styleUrl>
      <Point>
        <coordinates>${point.lng},${point.lat},0</coordinates>
      </Point>
    </Placemark>`;
            });
            
            kml += `
  </Document>
</kml>`;
            
            return kml;
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9909fe9ea5e7895a',t:'MTc2MDgxMTA0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>